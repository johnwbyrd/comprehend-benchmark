{"instance_id": "astropy__astropy-12907", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex a308e27297..45bea36085 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -242,7 +242,7 @@ def _cstack(left, right):\n         cright = _coord_matrix(right, 'right', noutp)\n     else:\n         cright = np.zeros((noutp, right.shape[1]))\n-        cright[-right.shape[0]:, -right.shape[1]:] = 1\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n \n     return np.hstack([cleft, cright])\n \ndiff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py\nindex 8dfe5c8626..514fc58e2c 100644\n--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -52,6 +52,13 @@ compound_models = {\n     'cm7': (map2 | p2 & sh1,\n             (np.array([False, True]),\n              np.array([[True, False], [False, True]]))\n+            ),\n+    'cm8': (rot & (sh1 & sh2),\n+            (np.array([False, False, True, True]),\n+             np.array([[True, True, False, False],\n+                       [True, True, False, False],\n+                       [False, False, True, False],\n+                       [False, False, False, True]]))\n             )\n }\n \n"}
{"instance_id": "astropy__astropy-14182", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/io/ascii/rst.py b/astropy/io/ascii/rst.py\nindex abdeba8efb..21d980bec5 100644\n--- a/astropy/io/ascii/rst.py\n+++ b/astropy/io/ascii/rst.py\n@@ -27,7 +27,6 @@ class SimpleRSTHeader(FixedWidthHeader):\n \n \n class SimpleRSTData(FixedWidthData):\n-    start_line = 3\n     end_line = -1\n     splitter_class = FixedWidthTwoLineDataSplitter\n \n@@ -57,10 +56,15 @@ class RST(FixedWidth):\n     data_class = SimpleRSTData\n     header_class = SimpleRSTHeader\n \n-    def __init__(self):\n-        super().__init__(delimiter_pad=None, bookend=False)\n+    def __init__(self, header_rows=None):\n+        super().__init__(delimiter_pad=None, bookend=False, header_rows=header_rows)\n \n     def write(self, lines):\n         lines = super().write(lines)\n-        lines = [lines[1]] + lines + [lines[1]]\n+        idx = len(self.header.header_rows)\n+        lines = [lines[idx]] + lines + [lines[idx]]\n         return lines\n+\n+    def read(self, table):\n+        self.data.start_line = 2 + len(self.header.header_rows)\n+        return super().read(table)\ndiff --git a/astropy/io/ascii/tests/test_rst.py b/astropy/io/ascii/tests/test_rst.py\nindex 84d6fed401..a25fe945b6 100644\n--- a/astropy/io/ascii/tests/test_rst.py\n+++ b/astropy/io/ascii/tests/test_rst.py\n@@ -2,7 +2,9 @@\n \n from io import StringIO\n \n+import astropy.units as u\n from astropy.io import ascii\n+from astropy.table import QTable\n \n from .common import assert_almost_equal, assert_equal\n \n@@ -185,3 +187,22 @@ Col1      Col2 Col3 Col4\n ==== ========= ==== ====\n \"\"\",\n     )\n+\n+\n+def test_write_header_rows():\n+    \"\"\"Write a QTable as RST with header_rows showing name and unit\"\"\"\n+    tbl = QTable({\"wave\": [350, 950] * u.nm, \"response\": [0.7, 1.2] * u.count})\n+    out = StringIO()\n+    tbl.write(out, format=\"ascii.rst\", header_rows=[\"name\", \"unit\"])\n+    assert_equal_splitlines(\n+        out.getvalue(),\n+        \"\"\"\\\n+===== ========\n+ wave response\n+   nm       ct\n+===== ========\n+350.0      0.7\n+950.0      1.2\n+===== ========\n+\"\"\",\n+    )\n"}
{"instance_id": "astropy__astropy-14365", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/io/ascii/qdp.py b/astropy/io/ascii/qdp.py\nindex 83a4f004aa..768beb0de9 100644\n--- a/astropy/io/ascii/qdp.py\n+++ b/astropy/io/ascii/qdp.py\n@@ -68,7 +68,7 @@ def _line_type(line, delimiter=None):\n     _new_re = rf\"NO({sep}NO)+\"\n     _data_re = rf\"({_decimal_re}|NO|[-+]?nan)({sep}({_decimal_re}|NO|[-+]?nan))*)\"\n     _type_re = rf\"^\\s*((?P<command>{_command_re})|(?P<new>{_new_re})|(?P<data>{_data_re})?\\s*(\\!(?P<comment>.*))?\\s*$\"\n-    _line_type_re = re.compile(_type_re)\n+    _line_type_re = re.compile(_type_re, re.IGNORECASE)\n     line = line.strip()\n     if not line:\n         return \"comment\"\n"}
{"instance_id": "astropy__astropy-14995", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex 4153dfccb2..69d77148e5 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -522,6 +522,8 @@ class NDArithmeticMixin:\n             return deepcopy(operand.mask)\n         elif operand is None:\n             return deepcopy(self.mask)\n+        elif operand.mask is None:\n+            return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)\n"}
{"instance_id": "astropy__astropy-6938", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/io/fits/fitsrec.py b/astropy/io/fits/fitsrec.py\nindex 574b4073b1..11f8c608e5 100644\n--- a/astropy/io/fits/fitsrec.py\n+++ b/astropy/io/fits/fitsrec.py\n@@ -1261,7 +1261,8 @@ class FITS_rec(np.recarray):\n \n         # Replace exponent separator in floating point numbers\n         if 'D' in format:\n-            output_field.replace(encode_ascii('E'), encode_ascii('D'))\n+            output_field[:] = output_field.replace(encode_ascii('E'),\n+                                                   encode_ascii('D'))\n \n \n def _get_recarray_field(array, key):\ndiff --git a/astropy/io/fits/tests/test_table.py b/astropy/io/fits/tests/test_table.py\nindex 67fe21aa72..6dbce9e45f 100644\n--- a/astropy/io/fits/tests/test_table.py\n+++ b/astropy/io/fits/tests/test_table.py\n@@ -2841,6 +2841,27 @@ class TestColumnFunctions(FitsTestCase):\n             raw = np.rec.recarray.field(hdul[1].data, 'TEST')\n             assert raw.tostring() == b'   1.   2.   3.'\n \n+    def test_d_exponent_ascii_column(self):\n+        \"\"\"\n+        Regression test for https://github.com/astropy/astropy/issues/6963\n+\n+        Ensure that D-format columns in ASCII tables write the exponent\n+        separator as 'D' rather than 'E'.\n+        \"\"\"\n+\n+        c = fits.Column('TEST', 'D25.17', array=[1.0, 2.0**100])\n+        t = fits.TableHDU.from_columns([c])\n+        t.writeto(self.temp('test.fits'))\n+\n+        with fits.open(self.temp('test.fits')) as hdul:\n+            assert hdul[1].header['TFORM1'] == 'D25.17'\n+            assert np.all(hdul[1].data['TEST'] == [1.0, 2.0**100])\n+\n+            # Check that the raw data uses 'D' as the exponent separator\n+            raw = np.rec.recarray.field(hdul[1].data, 'TEST')\n+            assert b'E' not in raw.tostring()\n+            assert b'D' in raw.tostring()\n+\n     def test_column_array_type_mismatch(self):\n         \"\"\"Regression test for https://aeon.stsci.edu/ssb/trac/pyfits/ticket/218\"\"\"\n \n"}
{"instance_id": "astropy__astropy-7746", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/astropy/wcs/wcs.py b/astropy/wcs/wcs.py\nindex d3a06f2b31..90106fa40b 100644\n--- a/astropy/wcs/wcs.py\n+++ b/astropy/wcs/wcs.py\n@@ -1220,6 +1220,11 @@ reduce these to 2 dimensions using the naxis kwarg.\n \n             xy = np.hstack([x.reshape((x.size, 1)) for x in axes])\n \n+            if xy.shape[0] == 0:\n+                if ra_dec_order and sky == 'output':\n+                    return (axes[0], axes[1])\n+                return [axes[0] for _ in range(self.naxis)]\n+\n             if ra_dec_order and sky == 'input':\n                 xy = self._denormalize_sky(xy)\n             output = func(xy, origin)\n@@ -1235,6 +1240,8 @@ reduce these to 2 dimensions using the naxis kwarg.\n                 raise ValueError(\n                     \"When providing two arguments, the array must be \"\n                     \"of shape (N, {0})\".format(self.naxis))\n+            if 0 in xy.shape:\n+                return np.zeros((0, self.naxis))\n             if ra_dec_order and sky == 'input':\n                 xy = self._denormalize_sky(xy)\n             result = func(xy, origin)\n"}
{"instance_id": "matplotlib__matplotlib-18869", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex b657a35cf7..926b61a6aa 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -129,6 +129,8 @@ __bibtex__ = r\"\"\"@Article{Hunter:2007,\n   year      = 2007\n }\"\"\"\n \n+_VersionInfo = namedtuple('_VersionInfo', 'major, minor, micro')\n+\n \n def __getattr__(name):\n     if name == \"__version__\":\n@@ -148,6 +150,12 @@ def __getattr__(name):\n         else:  # Get the version from the _version.py setuptools_scm file.\n             __version__ = _version.version\n         return __version__\n+    if name == \"__version_info__\":\n+        # Convert the version string to a namedtuple for easy comparison.\n+        from packaging.version import Version\n+        global __version_info__  # cache it.\n+        __version_info__ = _VersionInfo(*Version(__version__).release)\n+        return __version_info__\n     raise AttributeError(f\"module {__name__!r} has no attribute {name!r}\")\n \n \n"}
{"instance_id": "matplotlib__matplotlib-22711", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/widgets.py b/lib/matplotlib/widgets.py\nindex da5b40a5ef..7ccea9c1eb 100644\n--- a/lib/matplotlib/widgets.py\n+++ b/lib/matplotlib/widgets.py\n@@ -897,20 +897,22 @@ class RangeSlider(SliderBase):\n         _api.check_shape((2,), val=val)\n         val[0] = self._min_in_bounds(val[0])\n         val[1] = self._max_in_bounds(val[1])\n-        xy = self.poly.xy\n         if self.orientation == \"vertical\":\n-            xy[0] = .25, val[0]\n-            xy[1] = .25, val[1]\n-            xy[2] = .75, val[1]\n-            xy[3] = .75, val[0]\n-            xy[4] = .25, val[0]\n+            self.poly.xy = np.array([\n+                [.25, val[0]],\n+                [.25, val[1]],\n+                [.75, val[1]],\n+                [.75, val[0]],\n+                [.25, val[0]],\n+            ])\n         else:\n-            xy[0] = val[0], .25\n-            xy[1] = val[0], .75\n-            xy[2] = val[1], .75\n-            xy[3] = val[1], .25\n-            xy[4] = val[0], .25\n-        self.poly.xy = xy\n+            self.poly.xy = np.array([\n+                [val[0], .25],\n+                [val[0], .75],\n+                [val[1], .75],\n+                [val[1], .25],\n+                [val[0], .25],\n+            ])\n         self.valtext.set_text(self._format(val))\n         if self.drawon:\n             self.ax.figure.canvas.draw_idle()\n"}
{"instance_id": "matplotlib__matplotlib-22835", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex 1f33b9d3ec..130f4f8b85 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -1304,10 +1304,14 @@ class Artist:\n             normed = self.norm(data)\n             if np.isfinite(normed):\n                 # Midpoints of neighboring color intervals.\n-                neighbors = self.norm.inverse(\n-                    (int(self.norm(data) * n) + np.array([0, 1])) / n)\n-                delta = abs(neighbors - data).max()\n-                g_sig_digits = cbook._g_sig_digits(data, delta)\n+                try:\n+                    neighbors = self.norm.inverse(\n+                        (int(self.norm(data) * n) + np.array([0, 1])) / n)\n+                    delta = abs(neighbors - data).max()\n+                    g_sig_digits = cbook._g_sig_digits(data, delta)\n+                except ValueError:\n+                    # norm.inverse is not defined (e.g., BoundaryNorm).\n+                    g_sig_digits = 3  # Consistent with default below.\n             else:\n                 g_sig_digits = 3  # Consistent with default below.\n             return \"[{:-#.{}g}]\".format(data, g_sig_digits)\ndiff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex e8e90b7680..59e26608b0 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -354,6 +354,20 @@ def test_format_cursor_data(data, text):\n     assert im.format_cursor_data(im.get_cursor_data(event)) == text\n \n \n+def test_format_cursor_data_BoundaryNorm():\n+    \"\"\"BoundaryNorm is not invertible; format_cursor_data should not crash.\"\"\"\n+    from matplotlib.backend_bases import MouseEvent\n+\n+    fig, ax = plt.subplots()\n+    norm = mpl.colors.BoundaryNorm(np.linspace(-4, 4, 5), 256)\n+    im = ax.imshow(np.random.randn(10, 10), cmap='RdBu_r', norm=norm)\n+\n+    xdisp, ydisp = ax.transData.transform([0, 0])\n+    event = MouseEvent('motion_notify_event', fig.canvas, xdisp, ydisp)\n+    # Should not raise ValueError\n+    im.format_cursor_data(im.get_cursor_data(event))\n+\n+\n @image_comparison(['image_clip'], style='mpl20')\n def test_image_clip():\n     d = [[1, 2], [3, 4]]\n"}
{"instance_id": "matplotlib__matplotlib-23299", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex e3c66ea67c..1e777e32e8 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -222,6 +222,15 @@ def switch_backend(newbackend):\n     global _backend_mod\n     # make sure the init is pulled up so we can assign to it later\n     import matplotlib.backends\n+\n+    if newbackend is rcsetup._auto_backend_sentinel and _backend_mod is not None:\n+        # If the backend is already initialized and the sentinel was passed (which\n+        # can happen when rc_context exits after a figure was created inside it,\n+        # reverting rcParams['backend'] to the sentinel), restore rcParams['backend']\n+        # to the actual backend name without re-initializing or closing figures.\n+        rcParams['backend'] = dict.__getitem__(rcParamsDefault, \"backend\")\n+        return\n+\n     close(\"all\")\n \n     if newbackend is rcsetup._auto_backend_sentinel:\ndiff --git a/lib/matplotlib/tests/test_pyplot.py b/lib/matplotlib/tests/test_pyplot.py\nindex f824df490c..bc78fdf6dc 100644\n--- a/lib/matplotlib/tests/test_pyplot.py\n+++ b/lib/matplotlib/tests/test_pyplot.py\n@@ -383,3 +383,21 @@ def test_doc_pyplot_summary():\n             f\"The following functions are listed in the pyplot documentation, \"\n             f\"but they do not exist in pyplot. \"\n             f\"Please remove them from doc/api/pyplot_summary.rst: {extra!r}\")\n+\n+\n+def test_get_backend_no_rcparams_revert_on_get_backend():\n+    \"\"\"\n+    Calling get_backend() should not clear figures from Gcf if they were\n+    created inside an rc_context. Regression test for GitHub issue #23298.\n+    \"\"\"\n+    plt.close(\"all\")\n+    with mpl.rc_context():\n+        fig = plt.figure()\n+    figs_before = dict(plt._pylab_helpers.Gcf.figs)\n+    mpl.get_backend()\n+    figs_after = dict(plt._pylab_helpers.Gcf.figs)\n+    assert figs_before == figs_after, (\n+        \"get_backend() cleared figures from Gcf that were created \"\n+        \"inside rc_context\"\n+    )\n+    plt.close(\"all\")\n"}
{"instance_id": "matplotlib__matplotlib-23314", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex 9db44b7994..5479bc1af0 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -387,6 +387,8 @@ class Axes3D(Axes):\n \n     @martist.allow_rasterization\n     def draw(self, renderer):\n+        if not self.get_visible():\n+            return\n         self._unstale_viewLim()\n \n         # draw the background patch\n"}
{"instance_id": "matplotlib__matplotlib-23476", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/backend_bases.py b/lib/matplotlib/backend_bases.py\nindex 9ae2982c62..21795ab755 100644\n--- a/lib/matplotlib/backend_bases.py\n+++ b/lib/matplotlib/backend_bases.py\n@@ -1653,8 +1653,9 @@ class FigureCanvasBase:\n         self.toolbar = None  # NavigationToolbar2 will set me\n         self._is_idle_drawing = False\n         # We don't want to scale up the figure DPI more than once.\n-        figure._original_dpi = figure.dpi\n         self._device_pixel_ratio = 1\n+        if not hasattr(figure, '_original_dpi'):\n+            figure._original_dpi = figure.dpi\n         super().__init__()  # Typically the GUI widget init (if any).\n \n     callbacks = property(lambda self: self.figure._canvas_callbacks)\n"}
{"instance_id": "matplotlib__matplotlib-23562", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..80046ebf35 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -765,6 +765,8 @@ class Poly3DCollection(PolyCollection):\n         self._facecolor3d = PolyCollection.get_facecolor(self)\n         self._edgecolor3d = PolyCollection.get_edgecolor(self)\n         self._alpha3d = PolyCollection.get_alpha(self)\n+        self._facecolors2d = self._facecolor3d\n+        self._edgecolors2d = self._edgecolor3d\n         self.stale = True\n \n     def set_sort_zpos(self, val):\n"}
{"instance_id": "matplotlib__matplotlib-23563", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..63c6fb2b32 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -211,6 +211,12 @@ class Line3D(lines.Line2D):\n \n     @artist.allow_rasterization\n     def draw(self, renderer):\n+        if not hasattr(self, '_verts3d'):\n+            raise AttributeError(\n+                \"It is not possible to draw a Line3D before setting 3D \"\n+                \"data. Either supply the necessary arguments when \"\n+                \"constructing a Line3D, or use the 'set_data_3d' or \"\n+                \"'set_3d_properties' methods.\")\n         xs3d, ys3d, zs3d = self._verts3d\n         xs, ys, zs = proj3d.proj_transform(xs3d, ys3d, zs3d, self.axes.M)\n         self.set_data(xs, ys)\n"}
{"instance_id": "matplotlib__matplotlib-23913", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/legend.py b/lib/matplotlib/legend.py\nindex 9e5b903d59..747047c57a 100644\n--- a/lib/matplotlib/legend.py\n+++ b/lib/matplotlib/legend.py\n@@ -286,6 +286,9 @@ handler_map : dict or None\n     The custom dictionary mapping instances or types to a legend\n     handler. This *handler_map* updates the default handler map\n     found at `matplotlib.legend.Legend.get_legend_handler_map`.\n+\n+draggable : bool, default: False\n+    Whether the legend can be dragged with the mouse.\n \"\"\")\n \n \n@@ -342,7 +345,8 @@ class Legend(Artist):\n         title_fontproperties=None,  # properties for the legend title\n         alignment=\"center\",       # control the alignment within the legend box\n         *,\n-        ncol=1  # synonym for ncols (backward compatibility)\n+        ncol=1,  # synonym for ncols (backward compatibility)\n+        draggable=False  # whether the legend can be dragged with the mouse\n     ):\n         \"\"\"\n         Parameters\n@@ -538,6 +542,7 @@ class Legend(Artist):\n \n         self.set_title(title, prop=title_prop_fp)\n         self._draggable = None\n+        self.set_draggable(draggable)\n \n         # set the text color\n \n"}
{"instance_id": "matplotlib__matplotlib-23964", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/backends/backend_ps.py b/lib/matplotlib/backends/backend_ps.py\nindex f209e811f1..bd996b7509 100644\n--- a/lib/matplotlib/backends/backend_ps.py\n+++ b/lib/matplotlib/backends/backend_ps.py\n@@ -666,7 +666,8 @@ grestore\n                     (item.x, item.ft_object.get_glyph_name(item.glyph_idx))\n                 )\n             # append the last entry\n-            stream.append(curr_stream)\n+            if curr_stream:\n+                stream.append(curr_stream)\n \n         self.set_color(*gc.get_rgb())\n \n"}
{"instance_id": "matplotlib__matplotlib-23987", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 5bbb786984..c1368b6dfc 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -2426,9 +2426,12 @@ class Figure(FigureBase):\n             if isinstance(tight_layout, dict):\n                 self.get_layout_engine().set(**tight_layout)\n         elif constrained_layout is not None:\n-            self.set_layout_engine(layout='constrained')\n-            if isinstance(constrained_layout, dict):\n-                self.get_layout_engine().set(**constrained_layout)\n+            if constrained_layout:\n+                self.set_layout_engine(layout='constrained')\n+                if isinstance(constrained_layout, dict):\n+                    self.get_layout_engine().set(**constrained_layout)\n+            else:\n+                self.set_layout_engine(layout='none')\n         else:\n             # everything is None, so use default:\n             self.set_layout_engine(layout=layout)\n"}
{"instance_id": "matplotlib__matplotlib-24149", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/axes/_axes.py b/lib/matplotlib/axes/_axes.py\nindex fdac0f3560..3a61e89e14 100644\n--- a/lib/matplotlib/axes/_axes.py\n+++ b/lib/matplotlib/axes/_axes.py\n@@ -2180,12 +2180,12 @@ class Axes(_AxesBase):\n             # wrap numpy arrays.\n             try:\n                 x0 = cbook._safe_first_finite(x0)\n-            except (TypeError, IndexError, KeyError):\n+            except (TypeError, IndexError, KeyError, StopIteration):\n                 pass\n \n             try:\n                 x = cbook._safe_first_finite(xconv)\n-            except (TypeError, IndexError, KeyError):\n+            except (TypeError, IndexError, KeyError, StopIteration):\n                 x = xconv\n \n             delist = False\n"}
{"instance_id": "matplotlib__matplotlib-24265", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/style/core.py b/lib/matplotlib/style/core.py\nindex fb0a5426e6..808c8e980d 100644\n--- a/lib/matplotlib/style/core.py\n+++ b/lib/matplotlib/style/core.py\n@@ -244,6 +244,36 @@ def update_nested_dict(main_dict, new_dict):\n     return main_dict\n \n \n+class StyleLibrary(dict):\n+    def __getitem__(self, key):\n+        if key in [\n+            \"seaborn\",\n+            \"seaborn-bright\",\n+            \"seaborn-colorblind\",\n+            \"seaborn-dark\",\n+            \"seaborn-darkgrid\",\n+            \"seaborn-dark-palette\",\n+            \"seaborn-deep\",\n+            \"seaborn-muted\",\n+            \"seaborn-notebook\",\n+            \"seaborn-paper\",\n+            \"seaborn-pastel\",\n+            \"seaborn-poster\",\n+            \"seaborn-talk\",\n+            \"seaborn-ticks\",\n+            \"seaborn-white\",\n+            \"seaborn-whitegrid\",\n+        ]:\n+            _api.warn_deprecated(\n+                \"3.6\", message=\"The seaborn styles shipped by Matplotlib \"\n+                \"are deprecated since %(since)s, as they no longer \"\n+                \"correspond to the styles shipped by seaborn. However, \"\n+                \"they will remain available as 'seaborn-v0_8-<style>'. \"\n+                \"Alternatively, directly use the seaborn API instead.\")\n+            key = key.replace(\"seaborn\", \"seaborn-v0_8\")\n+        return super().__getitem__(key)\n+\n+\n # Load style library\n # ==================\n _base_library = read_style_directory(BASE_LIBRARY_PATH)\n@@ -254,7 +284,7 @@ available = []\n def reload_library():\n     \"\"\"Reload the style library.\"\"\"\n     global library\n-    library = update_user_library(_base_library)\n+    library = update_user_library(StyleLibrary(_base_library))\n     available[:] = sorted(library.keys())\n \n \n"}
{"instance_id": "matplotlib__matplotlib-24334", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex af0815d41d..28dbaa06de 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -2021,6 +2021,9 @@ class Axis(martist.Artist):\n         other limits, you should set the limits explicitly after setting the\n         ticks.\n         \"\"\"\n+        if kwargs and labels is None:\n+            raise ValueError(\n+                \"Passing 'kwargs' requires 'labels' to be provided as well.\")\n         result = self._set_tick_locations(ticks, minor=minor)\n         if labels is not None:\n             self.set_ticklabels(labels, minor=minor, **kwargs)\n"}
{"instance_id": "matplotlib__matplotlib-24970", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/colors.py b/lib/matplotlib/colors.py\nindex 2d3072da04..fe5bd837ab 100644\n--- a/lib/matplotlib/colors.py\n+++ b/lib/matplotlib/colors.py\n@@ -725,6 +725,11 @@ class Colormap:\n                 # Avoid converting large positive values to negative integers.\n                 np.clip(xa, -1, self.N, out=xa)\n                 xa = xa.astype(int)\n+        # Ensure xa can hold the special index values N, N+1, N+2.\n+        # This is needed for unsigned or narrow integer input dtypes (e.g.\n+        # uint8 cannot hold 256 for a default 256-color colormap).\n+        if not np.can_cast(self.N + 2, xa.dtype):\n+            xa = xa.astype(int)\n         # Set the over-range indices before the under-range;\n         # otherwise the under-range values get converted to over-range.\n         xa[xa > self.N - 1] = self._i_over\n"}
{"instance_id": "matplotlib__matplotlib-25079", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/colorbar.py b/lib/matplotlib/colorbar.py\nindex 966eb0760b..aed20d7241 100644\n--- a/lib/matplotlib/colorbar.py\n+++ b/lib/matplotlib/colorbar.py\n@@ -1102,8 +1102,11 @@ class Colorbar:\n \n         # transform from 0-1 to vmin-vmax:\n         if not self.norm.scaled():\n-            self.norm.vmin = 0\n-            self.norm.vmax = 1\n+            if self.mappable.get_array() is not None:\n+                self.norm.autoscale_None(self.mappable.get_array())\n+            if not self.norm.scaled():\n+                self.norm.vmin = 0\n+                self.norm.vmax = 1\n         self.norm.vmin, self.norm.vmax = mtransforms.nonsingular(\n             self.norm.vmin, self.norm.vmax, expander=0.1)\n         if (not isinstance(self.norm, colors.BoundaryNorm) and\ndiff --git a/lib/matplotlib/tests/test_colorbar.py b/lib/matplotlib/tests/test_colorbar.py\nindex e39d007378..f615254a34 100644\n--- a/lib/matplotlib/tests/test_colorbar.py\n+++ b/lib/matplotlib/tests/test_colorbar.py\n@@ -658,6 +658,25 @@ def test_colorbar_scale_reset():\n     assert cbar.outline.get_edgecolor() == mcolors.to_rgba('red')\n \n \n+def test_colorbar_lognorm_reset():\n+    # Test that setting a LogNorm on a mappable with an existing colorbar and\n+    # then calling autoscale() does not corrupt the norm. GitHub issue #25816.\n+    rng = np.random.default_rng(0)\n+    img = rng.uniform(1, 5, (25, 25))\n+\n+    fig, ax = plt.subplots()\n+    plot = ax.pcolormesh(img)\n+    fig.colorbar(plot, ax=ax)\n+\n+    plot.norm = LogNorm(1, 5)\n+    plot.autoscale()\n+    # Should not raise \"Invalid vmin or vmax\" on draw\n+    fig.canvas.draw()\n+    # vmin/vmax should be positive (valid for LogNorm, not corrupted to 0 or 1)\n+    assert plot.norm.vmin > 0\n+    assert plot.norm.vmax > 0\n+\n+\n def test_colorbar_get_ticks_2():\n     plt.rcParams['_internal.classic_mode'] = False\n     fig, ax = plt.subplots()\n"}
{"instance_id": "matplotlib__matplotlib-25311", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 10a4072328..8f1b043178 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -3190,6 +3190,30 @@ None}, default: None\n         # re-initialise some of the unstored state information\n         FigureCanvasBase(self)  # Set self.canvas.\n \n+        # Reconnect any DraggableBase-derived objects (e.g. DraggableLegend,\n+        # DraggableAnnotation) to the new canvas.  These objects store a direct\n+        # reference to the canvas which is stripped out during pickling (see\n+        # DraggableBase.__getstate__); we restore it here, after the canvas has\n+        # been set up, by re-registering the necessary callbacks.\n+        from matplotlib.offsetbox import DraggableBase\n+\n+        def reconnect_if_draggable(artist):\n+            draggable = getattr(artist, '_draggable', None)\n+            if isinstance(draggable, DraggableBase):\n+                draggable.canvas = self.canvas\n+                draggable.cids = [\n+                    self.canvas.callbacks._connect_picklable(\n+                        'pick_event', draggable.on_pick),\n+                    self.canvas.callbacks._connect_picklable(\n+                        'button_release_event', draggable.on_release),\n+                ]\n+\n+        for ax in self.axes:\n+            for child in ax.get_children():\n+                reconnect_if_draggable(child)\n+        for legend in self.legends:\n+            reconnect_if_draggable(legend)\n+\n         if restore_to_pylab:\n             # lazy import to avoid circularity\n             import matplotlib.pyplot as plt\ndiff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex 1dee8a23d9..497282cad9 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1580,6 +1580,20 @@ class DraggableBase:\n     def finalize_offset(self):\n         pass\n \n+    def __getstate__(self):\n+        state = self.__dict__.copy()\n+        # canvas is not picklable; it will be reconnected after unpickling via\n+        # Figure.__setstate__.\n+        state['canvas'] = None\n+        state['cids'] = []\n+        # got_artist may be True if we are pickling mid-drag; reset it.\n+        state['got_artist'] = False\n+        # background is a renderer buffer, not picklable.\n+        state.pop('background', None)\n+        # _c1 is a temporary callback registered during motion; not needed.\n+        state.pop('_c1', None)\n+        return state\n+\n \n class DraggableOffsetBox(DraggableBase):\n     def __init__(self, ref_artist, offsetbox, use_blit=False):\ndiff --git a/lib/matplotlib/tests/test_pickle.py b/lib/matplotlib/tests/test_pickle.py\nindex ec6bdcc2fe..4b5649b3d1 100644\n--- a/lib/matplotlib/tests/test_pickle.py\n+++ b/lib/matplotlib/tests/test_pickle.py\n@@ -282,3 +282,36 @@ def test_dynamic_norm():\n def test_vertexselector():\n     line, = plt.plot([0, 1], picker=True)\n     pickle.loads(pickle.dumps(VertexSelector(line)))\n+\n+\n+def test_draggable_legend():\n+    fig, ax = plt.subplots()\n+    ax.plot([1, 2, 3], label='test')\n+    leg = ax.legend()\n+    leg.set_draggable(True)\n+\n+    # Pickling must not raise.\n+    buf = BytesIO()\n+    pickle.dump(fig, buf)\n+    buf.seek(0)\n+    fig2 = pickle.load(buf)\n+\n+    # The legend should still be draggable after unpickling.\n+    assert fig2.axes[0].get_legend().get_draggable()\n+    plt.close(fig2)\n+\n+\n+def test_draggable_annotation():\n+    fig, ax = plt.subplots()\n+    ann = ax.annotate('test', xy=(0.5, 0.5))\n+    ann.draggable(True)\n+\n+    # Pickling must not raise.\n+    buf = BytesIO()\n+    pickle.dump(fig, buf)\n+    buf.seek(0)\n+    fig2 = pickle.load(buf)\n+\n+    # The annotation should still be draggable after unpickling.\n+    assert fig2.axes[0].texts[0]._draggable is not None\n+    plt.close(fig2)\n"}
{"instance_id": "matplotlib__matplotlib-25332", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/cbook.py b/lib/matplotlib/cbook.py\nindex c9699b2e21..683105d1fd 100644\n--- a/lib/matplotlib/cbook.py\n+++ b/lib/matplotlib/cbook.py\n@@ -791,6 +791,20 @@ class Grouper:\n     def __contains__(self, item):\n         return weakref.ref(item) in self._mapping\n \n+    def __getstate__(self):\n+        self.clean()\n+        # Pickle as a list of unique groups (lists of actual objects).\n+        unique_groups = {id(group): [ref() for ref in group]\n+                         for group in self._mapping.values()}\n+        return list(unique_groups.values())\n+\n+    def __setstate__(self, state):\n+        self._mapping = {}\n+        for group in state:\n+            weak_group = [weakref.ref(x) for x in group if x is not None]\n+            for wref in weak_group:\n+                self._mapping[wref] = weak_group\n+\n     def clean(self):\n         \"\"\"Clean dead weak references from the dictionary.\"\"\"\n         mapping = self._mapping\ndiff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 80d80f9691..e6b1eca353 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1542,6 +1542,16 @@ def test_unpickle_with_device_pixel_ratio():\n     assert fig2.dpi == 42\n \n \n+def test_pickle_with_aligned_labels():\n+    fig, axs = plt.subplots(2, 2)\n+    fig.align_labels()\n+    fig2 = pickle.loads(pickle.dumps(fig))\n+    assert fig2 is not None\n+    # Verify the grouper correctly identifies aligned axes after unpickling\n+    for group in fig2._align_label_groups['y']:\n+        assert len(group) > 0\n+\n+\n def test_gridspec_no_mutate_input():\n     gs = {'left': .1}\n     gs_orig = dict(gs)\n"}
{"instance_id": "matplotlib__matplotlib-25433", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex d2568fddbf..42a2f80b61 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -931,6 +931,10 @@ default: %(va)s\n         self._axobservers.process(\"_axes_change_event\", self)\n         self.stale = True\n         self._localaxes.remove(ax)\n+        # If the figure has a canvas, release any mouse grab on the deleted axes.\n+        # This prevents the mouse from being permanently blocked if the axes is\n+        # deleted while a widget (e.g. RangeSlider) is still grabbing the mouse.\n+        self.canvas.release_mouse(ax)\n \n         # Break link between any shared axes\n         for name in ax._axis_names:\n"}
{"instance_id": "matplotlib__matplotlib-25442", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/mpl-data/images/back.svg b/lib/matplotlib/mpl-data/images/back.svg\nindex a933ef8cdf..0c2d653cbe 100644\nBinary files a/lib/matplotlib/mpl-data/images/back.svg and b/lib/matplotlib/mpl-data/images/back.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/filesave.svg b/lib/matplotlib/mpl-data/images/filesave.svg\nindex ad8372d295..856721b6b5 100644\nBinary files a/lib/matplotlib/mpl-data/images/filesave.svg and b/lib/matplotlib/mpl-data/images/filesave.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/forward.svg b/lib/matplotlib/mpl-data/images/forward.svg\nindex 1f40713606..08b6fe1746 100644\nBinary files a/lib/matplotlib/mpl-data/images/forward.svg and b/lib/matplotlib/mpl-data/images/forward.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/hand.svg b/lib/matplotlib/mpl-data/images/hand.svg\nindex f246f51e57..28b96a2a9c 100644\nBinary files a/lib/matplotlib/mpl-data/images/hand.svg and b/lib/matplotlib/mpl-data/images/hand.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/help.svg b/lib/matplotlib/mpl-data/images/help.svg\nindex 484bdbcbf6..260528d607 100644\nBinary files a/lib/matplotlib/mpl-data/images/help.svg and b/lib/matplotlib/mpl-data/images/help.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/home.svg b/lib/matplotlib/mpl-data/images/home.svg\nindex 3c4ccce3ed..db140d43d1 100644\nBinary files a/lib/matplotlib/mpl-data/images/home.svg and b/lib/matplotlib/mpl-data/images/home.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/move.svg b/lib/matplotlib/mpl-data/images/move.svg\nindex aa7198cf72..f7e23ab045 100644\nBinary files a/lib/matplotlib/mpl-data/images/move.svg and b/lib/matplotlib/mpl-data/images/move.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/qt4_editor_options.svg b/lib/matplotlib/mpl-data/images/qt4_editor_options.svg\nindex 0b46bf8092..02adfbc4ae 100644\nBinary files a/lib/matplotlib/mpl-data/images/qt4_editor_options.svg and b/lib/matplotlib/mpl-data/images/qt4_editor_options.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/subplots.svg b/lib/matplotlib/mpl-data/images/subplots.svg\nindex e87d2c9b1b..9a0fa90972 100644\nBinary files a/lib/matplotlib/mpl-data/images/subplots.svg and b/lib/matplotlib/mpl-data/images/subplots.svg differ\ndiff --git a/lib/matplotlib/mpl-data/images/zoom_to_rect.svg b/lib/matplotlib/mpl-data/images/zoom_to_rect.svg\nindex f4b69b23c5..44e59a8a4f 100644\nBinary files a/lib/matplotlib/mpl-data/images/zoom_to_rect.svg and b/lib/matplotlib/mpl-data/images/zoom_to_rect.svg differ\ndiff --git a/lib/matplotlib/mpl-data/matplotlibrc b/lib/matplotlib/mpl-data/matplotlibrc\nindex bf3aab7949..df4f4afadf 100644\n--- a/lib/matplotlib/mpl-data/matplotlibrc\n+++ b/lib/matplotlib/mpl-data/matplotlibrc\n@@ -16,7 +16,7 @@\n ##         $HOME/.matplotlib/matplotlibrc\n ## and edit that copy.\n ##\n-## See https://matplotlib.org/stable/tutorials/introductory/customizing.html#customizing-with-matplotlibrc-files\n+## See https://matplotlib.org/stable/users/explain/customizing.html#customizing-with-matplotlibrc-files\n ## for more details on the paths which are checked for the configuration file.\n ##\n ## Blank lines, or lines starting with a comment symbol, are ignored, as are\n@@ -148,8 +148,14 @@\n ## for more information on patch properties.\n #patch.linewidth:       1.0    # edge width in points.\n #patch.facecolor:       C0\n-#patch.edgecolor:       black  # if forced, or patch is not filled\n-#patch.force_edgecolor: False  # True to always use edgecolor\n+#patch.edgecolor:       black  # By default, Patches and Collections do not draw edges.\n+                               # This value is only used if facecolor is \"none\"\n+                               # (an Artist without facecolor and edgecolor would be\n+                               # invisible)  or if patch.force_edgecolor is True.\n+#patch.force_edgecolor: False  # By default, Patches and Collections do not draw edges.\n+                               # Set this to True to draw edges with patch.edgedcolor\n+                               # as the default edgecolor.\n+                               # This is mainly relevant for styles.\n #patch.antialiased:     True   # render patches in antialiased (no jaggies)\n \n \n@@ -269,7 +275,7 @@\n #font.serif:      DejaVu Serif, Bitstream Vera Serif, Computer Modern Roman, New Century Schoolbook, Century Schoolbook L, Utopia, ITC Bookman, Bookman, Nimbus Roman No9 L, Times New Roman, Times, Palatino, Charter, serif\n #font.sans-serif: DejaVu Sans, Bitstream Vera Sans, Computer Modern Sans Serif, Lucida Grande, Verdana, Geneva, Lucid, Arial, Helvetica, Avant Garde, sans-serif\n #font.cursive:    Apple Chancery, Textile, Zapf Chancery, Sand, Script MT, Felipa, Comic Neue, Comic Sans MS, cursive\n-#font.fantasy:    Chicago, Charcoal, Impact, Western, Humor Sans, xkcd, fantasy\n+#font.fantasy:    Chicago, Charcoal, Impact, Western, xkcd script, fantasy\n #font.monospace:  DejaVu Sans Mono, Bitstream Vera Sans Mono, Computer Modern Typewriter, Andale Mono, Nimbus Mono L, Courier New, Courier, Fixed, Terminal, monospace\n \n \n@@ -309,7 +315,7 @@\n ## * LaTeX                                                                   *\n ## ***************************************************************************\n ## For more information on LaTeX properties, see\n-## https://matplotlib.org/stable/tutorials/text/usetex.html\n+## https://matplotlib.org/stable/users/explain/text/usetex.html\n #text.usetex: False  # use latex for all text handling. The following fonts\n                      # are supported through the usual rc parameter settings:\n                      # new century schoolbook, bookman, times, palatino,\n@@ -340,13 +346,14 @@\n ## settings which map a TeX font name to a fontconfig font pattern.  (These\n ## settings are not used for other font sets.)\n #mathtext.bf:  sans:bold\n+#mathtext.bfit: sans:italic:bold\n #mathtext.cal: cursive\n #mathtext.it:  sans:italic\n #mathtext.rm:  sans\n #mathtext.sf:  sans\n #mathtext.tt:  monospace\n #mathtext.fallback: cm  # Select fallback font from ['cm' (Computer Modern), 'stix'\n-                        # 'stixsans'] when a symbol can not be found in one of the\n+                        # 'stixsans'] when a symbol cannot be found in one of the\n                         # custom math fonts. Select 'None' to not perform fallback\n                         # and replace the missing character by a dummy symbol.\n #mathtext.default: it  # The default font to use for math.\n@@ -416,7 +423,7 @@\n                   # As opposed to all other parameters in this file, the color\n                   # values must be enclosed in quotes for this parameter,\n                   # e.g. '1f77b4', instead of 1f77b4.\n-                  # See also https://matplotlib.org/stable/tutorials/intermediate/color_cycle.html\n+                  # See also https://matplotlib.org/stable/users/explain/artists/color_cycle.html\n                   # for more details on prop_cycle usage.\n #axes.xmargin:   .05  # x margin.  See `axes.Axes.margins`\n #axes.ymargin:   .05  # y margin.  See `axes.Axes.margins`\n@@ -424,13 +431,19 @@\n #axes.autolimit_mode: data  # If \"data\", use axes.xmargin and axes.ymargin as is.\n                             # If \"round_numbers\", after application of margins, axis\n                             # limits are further expanded to the nearest \"round\" number.\n-#polaraxes.grid: True  # display grid on polar axes\n-#axes3d.grid:    True  # display grid on 3D axes\n+#polaraxes.grid:    True   # display grid on polar axes\n+#axes3d.grid:       True   # display grid on 3D axes\n+#axes3d.automargin: False  # automatically add margin when manually setting 3D axis limits\n \n #axes3d.xaxis.panecolor:    (0.95, 0.95, 0.95, 0.5)  # background pane on 3D axes\n #axes3d.yaxis.panecolor:    (0.90, 0.90, 0.90, 0.5)  # background pane on 3D axes\n #axes3d.zaxis.panecolor:    (0.925, 0.925, 0.925, 0.5)  # background pane on 3D axes\n \n+#axes3d.mouserotationstyle: arcball  # {azel, trackball, sphere, arcball}\n+                            # See also https://matplotlib.org/stable/api/toolkits/mplot3d/view_angles.html#rotation-with-mouse\n+#axes3d.trackballsize: 0.667  # trackball diameter, in units of the Axes bbox\n+#axes3d.trackballborder: 0.2  # trackball border width, in units of the Axes bbox (only for 'sphere' and 'arcball' style)\n+\n ## ***************************************************************************\n ## * AXIS                                                                    *\n ## ***************************************************************************\n@@ -488,6 +501,7 @@\n #xtick.major.bottom:  True    # draw x axis bottom major ticks\n #xtick.minor.top:     True    # draw x axis top minor ticks\n #xtick.minor.bottom:  True    # draw x axis bottom minor ticks\n+#xtick.minor.ndivs:   auto    # number of minor ticks between the major ticks on x-axis\n #xtick.alignment:     center  # alignment of xticks\n \n #ytick.left:          True    # draw ticks on the left side\n@@ -509,6 +523,7 @@\n #ytick.major.right:   True    # draw y axis right major ticks\n #ytick.minor.left:    True    # draw y axis left minor ticks\n #ytick.minor.right:   True    # draw y axis right minor ticks\n+#ytick.minor.ndivs:   auto    # number of minor ticks between the major ticks on y-axis\n #ytick.alignment:     center_baseline  # alignment of yticks\n \n \n@@ -584,17 +599,22 @@\n #figure.constrained_layout.use: False  # When True, automatically make plot\n                                        # elements fit on the figure. (Not\n                                        # compatible with `autolayout`, above).\n-#figure.constrained_layout.h_pad:  0.04167  # Padding around axes objects. Float representing\n-#figure.constrained_layout.w_pad:  0.04167  # inches. Default is 3/72 inches (3 points)\n-#figure.constrained_layout.hspace: 0.02     # Space between subplot groups. Float representing\n-#figure.constrained_layout.wspace: 0.02     # a fraction of the subplot widths being separated.\n+## Padding (in inches) around axes; defaults to 3/72 inches, i.e. 3 points.\n+#figure.constrained_layout.h_pad:  0.04167\n+#figure.constrained_layout.w_pad:  0.04167\n+## Spacing between subplots, relative to the subplot sizes.  Much smaller than for\n+## tight_layout (figure.subplot.hspace, figure.subplot.wspace) as constrained_layout\n+## already takes surrounding texts (titles, labels, # ticklabels) into account.\n+#figure.constrained_layout.hspace: 0.02\n+#figure.constrained_layout.wspace: 0.02\n \n \n ## ***************************************************************************\n ## * IMAGES                                                                  *\n ## ***************************************************************************\n #image.aspect:          equal        # {equal, auto} or a number\n-#image.interpolation:   antialiased  # see help(imshow) for options\n+#image.interpolation:   auto         # see help(imshow) for options\n+#image.interpolation_stage: auto     # see help(imshow) for options\n #image.cmap:            viridis      # A colormap name (plasma, magma, etc.)\n #image.lut:             256          # the size of the colormap lookup table\n #image.origin:          upper        # {lower, upper}\n@@ -661,14 +681,14 @@\n #path.snap: True  # When True, rectilinear axis-aligned paths will be snapped\n                   # to the nearest pixel when certain criteria are met.\n                   # When False, paths will never be snapped.\n-#path.sketch: None  # May be None, or a 3-tuple of the form:\n-                    # (scale, length, randomness).\n-                    #     - *scale* is the amplitude of the wiggle\n-                    #         perpendicular to the line (in pixels).\n-                    #     - *length* is the length of the wiggle along the\n-                    #         line (in pixels).\n-                    #     - *randomness* is the factor by which the length is\n-                    #         randomly scaled.\n+#path.sketch: None  # May be None, or a tuple of the form:\n+                    #  path.sketch: (scale, length, randomness)\n+                    # - *scale* is the amplitude of the wiggle\n+                    #    perpendicular to the line (in pixels).\n+                    # - *length* is the length of the wiggle along the\n+                    #    line (in pixels).\n+                    # - *randomness* is the factor by which the length is\n+                    #    randomly scaled.\n #path.effects:\n \n \n@@ -683,9 +703,8 @@\n #savefig.edgecolor: auto        # figure edge color when saving\n #savefig.format:    png         # {png, ps, pdf, svg}\n #savefig.bbox:      standard    # {tight, standard}\n-                                # 'tight' is incompatible with pipe-based animation\n-                                # backends (e.g. 'ffmpeg') but will work with those\n-                                # based on temporary files (e.g. 'ffmpeg_file')\n+                                # 'tight' is incompatible with generating frames\n+                                # for animation\n #savefig.pad_inches:  0.1       # padding to be used, when bbox is set to 'tight'\n #savefig.directory:   ~         # default directory in savefig dialog, gets updated after\n                                 # interactive saves, unless set to the empty string (i.e.\n@@ -695,12 +714,16 @@\n                                 # background by default\n #savefig.orientation: portrait  # orientation of saved figure, for PostScript output only\n \n+### macosx backend params\n+#macosx.window_mode : system   # How to open new figures (system, tab, window)\n+                               # system uses the MacOS system preferences\n+\n ### tk backend params\n #tk.window_focus:   False  # Maintain shell focus for TkAgg\n \n ### ps backend params\n-#ps.papersize:      letter  # {auto, letter, legal, ledger, A0-A10, B0-B10}\n-#ps.useafm:         False   # use of AFM fonts, results in small files\n+#ps.papersize:      letter  # {figure, letter, legal, ledger, A0-A10, B0-B10}\n+#ps.useafm:         False   # use AFM fonts, results in small files\n #ps.usedistiller:   False   # {ghostscript, xpdf, None}\n                             # Experimental: may produce smaller files.\n                             # xpdf intended for production of publication quality files,\n@@ -723,6 +746,8 @@\n                          #     None: Assume fonts are installed on the\n                          #           machine where the SVG will be viewed.\n #svg.hashsalt: None      # If not None, use this string as hash salt instead of uuid4\n+#svg.id: None            # If not None, use this string as the value for the `id`\n+                         # attribute in the top <svg> tag\n \n ### pgf parameter\n ## See https://matplotlib.org/stable/tutorials/text/pgf.html for more information.\ndiff --git a/lib/matplotlib/mpl-data/sample_data/logo2.png b/lib/matplotlib/mpl-data/sample_data/logo2.png\nindex a1adda483e..72843ab1fe 100644\nBinary files a/lib/matplotlib/mpl-data/sample_data/logo2.png and b/lib/matplotlib/mpl-data/sample_data/logo2.png differ\ndiff --git a/lib/matplotlib/mpl-data/stylelib/classic.mplstyle b/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\nindex 6f65e8be95..50516d831a 100644\n--- a/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\n+++ b/lib/matplotlib/mpl-data/stylelib/classic.mplstyle\n@@ -91,7 +91,7 @@ font.size           : 12.0\n font.serif     : DejaVu Serif, New Century Schoolbook, Century Schoolbook L, Utopia, ITC Bookman, Bookman, Nimbus Roman No9 L, Times New Roman, Times, Palatino, Charter, serif\n font.sans-serif: DejaVu Sans, Lucida Grande, Verdana, Geneva, Lucid, Arial, Helvetica, Avant Garde, sans-serif\n font.cursive   : Apple Chancery, Textile, Zapf Chancery, Sand, Script MT, Felipa, cursive\n-font.fantasy   : Comic Sans MS, Chicago, Charcoal, ImpactWestern, Humor Sans, fantasy\n+font.fantasy   : Comic Sans MS, Chicago, Charcoal, ImpactWestern, xkcd script, fantasy\n font.monospace : DejaVu Sans Mono, Andale Mono, Nimbus Mono L, Courier New, Courier, Fixed, Terminal, monospace\n \n ### TEXT\n@@ -158,7 +158,7 @@ mathtext.sf  : sans\\-serif\n mathtext.fontset : cm # Should be 'cm' (Computer Modern), 'stix',\n                       # 'stixsans' or 'custom'\n mathtext.fallback: cm  # Select fallback font from ['cm' (Computer Modern), 'stix'\n-                       # 'stixsans'] when a symbol can not be found in one of the\n+                       # 'stixsans'] when a symbol cannot be found in one of the\n                        # custom math fonts. Select 'None' to not perform fallback\n                        # and replace the missing character by a dummy.\n \n@@ -223,7 +223,8 @@ axes.spines.left    : True\n axes.spines.right   : True\n axes.spines.top     : True\n polaraxes.grid      : True    # display grid on polar axes\n-axes3d.grid         : True    # display grid on 3d axes\n+axes3d.grid         : True    # display grid on 3D axes\n+axes3d.automargin   : False   # automatically add margin when manually setting 3D axis limits\n \n date.autoformatter.year   : %Y\n date.autoformatter.month  : %b %Y\n@@ -379,7 +380,6 @@ boxplot.showbox: True\n boxplot.showcaps: True\n boxplot.showfliers: True\n boxplot.showmeans: False\n-boxplot.vertical: True\n boxplot.whiskerprops.color: b\n boxplot.whiskerprops.linestyle: --\n boxplot.whiskerprops.linewidth: 1.0\ndiff --git a/lib/matplotlib/mpl-data/stylelib/dark_background.mplstyle b/lib/matplotlib/mpl-data/stylelib/dark_background.mplstyle\nindex c4b7741ae4..61a99f3c0d 100644\n--- a/lib/matplotlib/mpl-data/stylelib/dark_background.mplstyle\n+++ b/lib/matplotlib/mpl-data/stylelib/dark_background.mplstyle\n@@ -18,9 +18,6 @@ grid.color: white\n figure.facecolor: black\n figure.edgecolor: black\n \n-savefig.facecolor: black\n-savefig.edgecolor: black\n-\n ### Boxplots\n boxplot.boxprops.color: white\n boxplot.capprops.color: white\ndiff --git a/lib/matplotlib/mpl-data/stylelib/fivethirtyeight.mplstyle b/lib/matplotlib/mpl-data/stylelib/fivethirtyeight.mplstyle\nindex 738db39f5f..cd56d404c3 100644\n--- a/lib/matplotlib/mpl-data/stylelib/fivethirtyeight.mplstyle\n+++ b/lib/matplotlib/mpl-data/stylelib/fivethirtyeight.mplstyle\n@@ -29,10 +29,7 @@ xtick.minor.size: 0\n ytick.major.size: 0\n ytick.minor.size: 0\n \n-font.size:14.0\n-\n-savefig.edgecolor: f0f0f0\n-savefig.facecolor: f0f0f0\n+font.size: 14.0\n \n figure.subplot.left: 0.08\n figure.subplot.right: 0.95\ndiff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex 77768e7383..fae249ff08 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1506,6 +1506,11 @@ class DraggableBase:\n             self.canvas.callbacks._connect_picklable(\n                 'button_release_event', self.on_release),\n         ]\n+        # Keep a reference to the canvas so we can disconnect even if\n+        # ref_artist.figure is later set to None (e.g. by Artist.remove()).\n+        # This is stored separately from the canvas property to avoid breaking\n+        # pickling (see __getstate__).\n+        self._canvas = self.canvas\n \n     # A property, not an attribute, to maintain picklability.\n     canvas = property(lambda self: self.ref_artist.figure.canvas)\n@@ -1558,14 +1563,27 @@ class DraggableBase:\n \n     def disconnect(self):\n         \"\"\"Disconnect the callbacks.\"\"\"\n+        # Use _canvas if available (set in __init__) to handle the case where\n+        # ref_artist.figure has been cleared (e.g. by Artist.remove()). Fall\n+        # back to the canvas property (needs figure) when _canvas is absent\n+        # (e.g. after unpickling, where __getstate__ excludes _canvas).\n+        canvas = self.__dict__.get('_canvas') or self.canvas\n         for cid in self.cids:\n-            self.canvas.mpl_disconnect(cid)\n+            canvas.mpl_disconnect(cid)\n         try:\n             c1 = self._c1\n         except AttributeError:\n             pass\n         else:\n-            self.canvas.mpl_disconnect(c1)\n+            canvas.mpl_disconnect(c1)\n+\n+    def __getstate__(self):\n+        state = self.__dict__.copy()\n+        # _canvas is not picklable for GUI backends; it is recreated in\n+        # __init__ from ref_artist.figure.canvas. Exclude it from the pickle\n+        # stream and fall back to the canvas property after unpickling.\n+        state.pop('_canvas', None)\n+        return state\n \n     def save_offset(self):\n         pass\n"}
{"instance_id": "matplotlib__matplotlib-25498", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/colorbar.py b/lib/matplotlib/colorbar.py\nindex d3d53e3d98..76ec00c00f 100644\n--- a/lib/matplotlib/colorbar.py\n+++ b/lib/matplotlib/colorbar.py\n@@ -1101,6 +1101,8 @@ class Colorbar:\n             b = np.hstack((b, b[-1] + 1))\n \n         # transform from 0-1 to vmin-vmax:\n+        if not self.norm.scaled():\n+            self.norm.autoscale_None(self.mappable.get_array())\n         if not self.norm.scaled():\n             self.norm.vmin = 0\n             self.norm.vmax = 1\n"}
{"instance_id": "matplotlib__matplotlib-26011", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex e6e7e29f11..598436ba63 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -1246,6 +1246,7 @@ class Axis(martist.Artist):\n                         v0, v1, emit=False, auto=auto)\n                     if other.figure != self.figure:\n                         other.figure.canvas.draw_idle()\n+                    other.callbacks.process(f\"{name}lim_changed\", other)\n \n         self.stale = True\n         return v0, v1\n"}
{"instance_id": "matplotlib__matplotlib-26020", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/lib/mpl_toolkits/axes_grid1/axes_grid.py b/lib/mpl_toolkits/axes_grid1/axes_grid.py\nindex 2b1b1d3200..830554edbb 100644\n--- a/lib/mpl_toolkits/axes_grid1/axes_grid.py\n+++ b/lib/mpl_toolkits/axes_grid1/axes_grid.py\n@@ -13,8 +13,13 @@ from .mpl_axes import Axes\n def _tick_only(ax, bottom_on, left_on):\n     bottom_off = not bottom_on\n     left_off = not left_on\n-    ax.axis[\"bottom\"].toggle(ticklabels=bottom_off, label=bottom_off)\n-    ax.axis[\"left\"].toggle(ticklabels=left_off, label=left_off)\n+    if hasattr(ax.axis, \"__getitem__\"):\n+        ax.axis[\"bottom\"].toggle(ticklabels=bottom_off, label=bottom_off)\n+        ax.axis[\"left\"].toggle(ticklabels=left_off, label=left_off)\n+    else:\n+        ax.tick_params(labelbottom=bottom_off, labelleft=left_off)\n+        ax.xaxis.label.set_visible(bottom_off)\n+        ax.yaxis.label.set_visible(left_off)\n \n \n class CbarAxesBase:\ndiff --git a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\nindex d1554020cd..8f34f5c583 100644\n--- a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n+++ b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n@@ -592,6 +592,14 @@ def test_axes_class_tuple():\n     gr = AxesGrid(fig, 111, nrows_ncols=(1, 1), axes_class=axes_class)\n \n \n+def test_axes_class_non_default():\n+    # Test that AxesGrid works with a non-default axes class that has axis as\n+    # a method (not an AxisDict). Regression test for GitHub issue #18869.\n+    fig = plt.figure()\n+    axes_class = (plt.Axes, {})\n+    gr = AxesGrid(fig, 111, nrows_ncols=(1, 1), axes_class=axes_class)\n+\n+\n def test_grid_axes_lists():\n     \"\"\"Test Grid axes_all, axes_row and axes_column relationship.\"\"\"\n     fig = plt.figure()\n"}
{"instance_id": "mwaskom__seaborn-2848", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/seaborn/_oldcore.py b/seaborn/_oldcore.py\nindex c9218c1f..b2ecb44b 100644\n--- a/seaborn/_oldcore.py\n+++ b/seaborn/_oldcore.py\n@@ -149,19 +149,25 @@ class HueMapping(SemanticMapping):\n             # Use a value that's in the original data vector\n             value = self.lookup_table[key]\n         except KeyError:\n-            # Use the colormap to interpolate between existing datapoints\n-            # (e.g. in the context of making a continuous legend)\n-            try:\n-                normed = self.norm(key)\n-            except TypeError as err:\n-                if np.isnan(key):\n-                    value = (0, 0, 0, 0)\n-                else:\n-                    raise err\n+            if self.norm is None:\n+                # When using categorical hue mapping, a KeyError means the\n+                # value was not in hue_order (i.e. intentionally excluded).\n+                # Return a fully transparent color so it is not plotted.\n+                value = (0, 0, 0, 0)\n             else:\n-                if np.ma.is_masked(normed):\n-                    normed = np.nan\n-                value = self.cmap(normed)\n+                # Use the colormap to interpolate between existing datapoints\n+                # (e.g. in the context of making a continuous legend)\n+                try:\n+                    normed = self.norm(key)\n+                except TypeError as err:\n+                    if np.isnan(key):\n+                        value = (0, 0, 0, 0)\n+                    else:\n+                        raise err\n+                else:\n+                    if np.ma.is_masked(normed):\n+                        normed = np.nan\n+                    value = self.cmap(normed)\n         return value\n \n     def infer_map_type(self, palette, norm, input_format, var_type):\n"}
{"instance_id": "mwaskom__seaborn-3010", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/seaborn/_stats/regression.py b/seaborn/_stats/regression.py\nindex 7b7ddc8d..16100692 100644\n--- a/seaborn/_stats/regression.py\n+++ b/seaborn/_stats/regression.py\n@@ -23,6 +23,9 @@ class PolyFit(Stat):\n \n         x = data[\"x\"]\n         y = data[\"y\"]\n+        mask = x.notna() & y.notna()\n+        x = x[mask]\n+        y = y[mask]\n         if x.nunique() <= self.order:\n             # TODO warn?\n             xx = yy = []\n"}
{"instance_id": "mwaskom__seaborn-3190", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/seaborn/_core/scales.py b/seaborn/_core/scales.py\nindex 6c9ecbc9..c18ab88c 100644\n--- a/seaborn/_core/scales.py\n+++ b/seaborn/_core/scales.py\n@@ -347,8 +347,8 @@ class ContinuousBase(Scale):\n             else:\n                 vmin, vmax = new.norm\n             vmin, vmax = axis.convert_units((vmin, vmax))\n-            a = forward(vmin)\n-            b = forward(vmax) - forward(vmin)\n+            a = forward(float(vmin))\n+            b = forward(float(vmax)) - forward(float(vmin))\n \n             def normalize(x):\n                 return (x - a) / b\n"}
{"instance_id": "mwaskom__seaborn-3407", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/seaborn/axisgrid.py b/seaborn/axisgrid.py\nindex 75349099..f8709e02 100644\n--- a/seaborn/axisgrid.py\n+++ b/seaborn/axisgrid.py\n@@ -1472,7 +1472,9 @@ class PairGrid(Grid):\n                 for ax in diag_axes[1:]:\n                     share_axis(diag_axes[0], ax, \"y\")\n \n-            self.diag_vars = np.array(diag_vars, np.object_)\n+            diag_vars_arr = np.empty(len(diag_vars), dtype=object)\n+            diag_vars_arr[:] = diag_vars\n+            self.diag_vars = diag_vars_arr\n             self.diag_axes = np.array(diag_axes, np.object_)\n \n         if \"hue\" not in signature(func).parameters:\n"}
{"instance_id": "psf__requests-1963", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 425db22c..4bb6c728 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -86,9 +86,10 @@ class SessionRedirectMixin(object):\n         \"\"\"Receives a Response. Returns a generator of Responses.\"\"\"\n \n         i = 0\n+        prepared_request = req.copy()\n \n         while resp.is_redirect:\n-            prepared_request = req.copy()\n+            prepared_request = prepared_request.copy()\n \n             resp.content  # Consume socket so it can be released\n \n@@ -99,7 +100,7 @@ class SessionRedirectMixin(object):\n             resp.close()\n \n             url = resp.headers['location']\n-            method = req.method\n+            method = prepared_request.method\n \n             # Handle redirection without scheme (see: RFC 1808 Section 4)\n             if url.startswith('//'):\n"}
{"instance_id": "psf__requests-2148", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex 0dc55568..2ababaf8 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -9,6 +9,7 @@ This module contains the primary objects that power Requests.\n \n import collections\n import datetime\n+import socket\n \n from io import BytesIO, UnsupportedOperation\n from .hooks import default_hooks\n@@ -22,7 +23,7 @@ from .packages.urllib3.util import parse_url\n from .packages.urllib3.exceptions import DecodeError\n from .exceptions import (\n     HTTPError, RequestException, MissingSchema, InvalidURL,\n-    ChunkedEncodingError, ContentDecodingError)\n+    ChunkedEncodingError, ContentDecodingError, ConnectionError)\n from .utils import (\n     guess_filename, get_auth_from_url, requote_uri,\n     stream_decode_response_unicode, to_key_val_list, parse_header_links,\n@@ -640,6 +641,8 @@ class Response(object):\n                     raise ChunkedEncodingError(e)\n                 except DecodeError as e:\n                     raise ContentDecodingError(e)\n+                except socket.error as e:\n+                    raise ConnectionError(e)\n             except AttributeError:\n                 # Standard file-like object.\n                 while True:\n"}
{"instance_id": "psf__requests-2317", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex d701ff2e..adcfbac7 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -425,7 +425,7 @@ class Session(SessionRedirectMixin):\n             If Tuple, ('cert', 'key') pair.\n         \"\"\"\n \n-        method = builtin_str(method)\n+        method = to_native_string(method)\n \n         # Create the Request.\n         req = Request(\n"}
{"instance_id": "psf__requests-2674", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/adapters.py b/requests/adapters.py\nindex 841cbbfe..000f1167 100644\n--- a/requests/adapters.py\n+++ b/requests/adapters.py\n@@ -27,9 +27,11 @@ from .packages.urllib3.exceptions import ProtocolError\n from .packages.urllib3.exceptions import ReadTimeoutError\n from .packages.urllib3.exceptions import SSLError as _SSLError\n from .packages.urllib3.exceptions import ResponseError\n+from .packages.urllib3.exceptions import DecodeError as _DecodeError\n+from .packages.urllib3.exceptions import TimeoutError as _TimeoutError\n from .cookies import extract_cookies_to_jar\n from .exceptions import (ConnectionError, ConnectTimeout, ReadTimeout, SSLError,\n-                         ProxyError, RetryError)\n+                         ProxyError, RetryError, ContentDecodingError)\n from .auth import _basic_auth_str\n \n DEFAULT_POOLBLOCK = False\n@@ -429,6 +431,10 @@ class HTTPAdapter(BaseAdapter):\n                 raise SSLError(e, request=request)\n             elif isinstance(e, ReadTimeoutError):\n                 raise ReadTimeout(e, request=request)\n+            elif isinstance(e, _DecodeError):\n+                raise ContentDecodingError(e, request=request)\n+            elif isinstance(e, _TimeoutError):\n+                raise ReadTimeout(e, request=request)\n             else:\n                 raise\n \ndiff --git a/requests/models.py b/requests/models.py\nindex 4270c647..34a7a955 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -23,7 +23,7 @@ from .packages.urllib3.exceptions import (\n     DecodeError, ReadTimeoutError, ProtocolError, LocationParseError)\n from .exceptions import (\n     HTTPError, MissingSchema, InvalidURL, ChunkedEncodingError,\n-    ContentDecodingError, ConnectionError, StreamConsumedError)\n+    ContentDecodingError, ConnectionError, StreamConsumedError, ReadTimeout)\n from .utils import (\n     guess_filename, get_auth_from_url, requote_uri,\n     stream_decode_response_unicode, to_key_val_list, parse_header_links,\n@@ -661,7 +661,7 @@ class Response(object):\n                 except DecodeError as e:\n                     raise ContentDecodingError(e)\n                 except ReadTimeoutError as e:\n-                    raise ConnectionError(e)\n+                    raise ReadTimeout(e)\n             else:\n                 # Standard file-like object.\n                 while True:\n"}
{"instance_id": "psf__requests-3362", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/utils.py b/requests/utils.py\nindex 8d17b6b2..f9f8b8d8 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -359,12 +359,17 @@ def get_encoding_from_headers(headers):\n def stream_decode_response_unicode(iterator, r):\n     \"\"\"Stream decodes a iterator.\"\"\"\n \n-    if r.encoding is None:\n+    encoding = r.encoding\n+\n+    if encoding is None:\n+        encoding = r.apparent_encoding\n+\n+    if encoding is None:\n         for item in iterator:\n             yield item\n         return\n \n-    decoder = codecs.getincrementaldecoder(r.encoding)(errors='replace')\n+    decoder = codecs.getincrementaldecoder(encoding)(errors='replace')\n     for chunk in iterator:\n         rv = decoder.decode(chunk)\n         if rv:\n"}
{"instance_id": "psf__requests-863", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex d8456375..404b4bf5 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -463,7 +463,10 @@ class Request(object):\n     def register_hook(self, event, hook):\n         \"\"\"Properly register a hook.\"\"\"\n \n-        self.hooks[event].append(hook)\n+        if isinstance(hook, list):\n+            self.hooks[event].extend(hook)\n+        else:\n+            self.hooks[event].append(hook)\n \n     def deregister_hook(self, event, hook):\n         \"\"\"Deregister a previously registered hook.\n"}
{"instance_id": "pylint-dev__pylint-5859", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/checkers/misc.py b/pylint/checkers/misc.py\nindex 69149e61a..54298b30f 100644\n--- a/pylint/checkers/misc.py\n+++ b/pylint/checkers/misc.py\n@@ -119,11 +119,14 @@ class EncodingChecker(BaseChecker):\n     def open(self):\n         super().open()\n \n-        notes = \"|\".join(re.escape(note) for note in self.config.notes)\n+        notes = \"|\".join(\n+            re.escape(note) + (r\"\\b\" if note[-1].isalnum() or note[-1] == \"_\" else \"\")\n+            for note in self.config.notes\n+        )\n         if self.config.notes_rgx:\n-            regex_string = rf\"#\\s*({notes}|{self.config.notes_rgx})\\b\"\n+            regex_string = rf\"#\\s*({notes}|{self.config.notes_rgx}\\b)\"\n         else:\n-            regex_string = rf\"#\\s*({notes})\\b\"\n+            regex_string = rf\"#\\s*({notes})\"\n \n         self._fixme_pattern = re.compile(regex_string, re.I)\n \ndiff --git a/tests/checkers/unittest_misc.py b/tests/checkers/unittest_misc.py\nindex 23e19a9d0..09eedf6b9 100644\n--- a/tests/checkers/unittest_misc.py\n+++ b/tests/checkers/unittest_misc.py\n@@ -106,6 +106,16 @@ class TestFixme(CheckerTestCase):\n         ):\n             self.checker.process_tokens(_tokenize_str(code))\n \n+    @set_config(notes=[\"???\"])\n+    def test_punctuation_notes(self) -> None:\n+        code = \"\"\"a = 1\n+                # ???: yes\n+                \"\"\"\n+        with self.assertAddsMessages(\n+            MessageTest(msg_id=\"fixme\", line=2, args=\"???: yes\", col_offset=17)\n+        ):\n+            self.checker.process_tokens(_tokenize_str(code))\n+\n     def test_dont_trigger_on_todoist(self) -> None:\n         code = \"\"\"\n         # Todoist API: What is this task about?\n"}
{"instance_id": "pylint-dev__pylint-6506", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/config/config_initialization.py b/pylint/config/config_initialization.py\nindex 24e453a73..c6e0a6f6f 100644\n--- a/pylint/config/config_initialization.py\n+++ b/pylint/config/config_initialization.py\n@@ -82,7 +82,7 @@ def _config_initialization(\n     if unrecognized_options:\n         msg = \", \".join(unrecognized_options)\n         linter.add_message(\"unrecognized-option\", line=0, args=msg)\n-        raise _UnrecognizedOptionError(options=unrecognized_options)\n+        sys.exit(32)\n \n     # Set the current module to configuration as we don't know where\n     # the --load-plugins key is coming from\n"}
{"instance_id": "pylint-dev__pylint-7080", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/lint/pylinter.py b/pylint/lint/pylinter.py\nindex e2bbf061e..29694b4cd 100644\n--- a/pylint/lint/pylinter.py\n+++ b/pylint/lint/pylinter.py\n@@ -614,6 +614,12 @@ class PyLinter(\n                             os.path.join(root, file)\n                             for file in files\n                             if file.endswith(\".py\")\n+                            and not _is_ignored_file(\n+                                os.path.join(root, file),\n+                                self.config.ignore,\n+                                self.config.ignore_patterns,\n+                                self.config.ignore_paths,\n+                            )\n                         )\n             else:\n                 yield something\n"}
{"instance_id": "pylint-dev__pylint-7114", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/lint/expand_modules.py b/pylint/lint/expand_modules.py\nindex 289e1afce..3217c86cc 100644\n--- a/pylint/lint/expand_modules.py\n+++ b/pylint/lint/expand_modules.py\n@@ -30,8 +30,7 @@ def get_python_path(filepath: str) -> str:\n     This is not true since python 3.3 and is causing problem.\n     \"\"\"\n     dirname = os.path.realpath(os.path.expanduser(filepath))\n-    if not os.path.isdir(dirname):\n-        dirname = os.path.dirname(dirname)\n+    dirname = os.path.dirname(dirname)\n     while True:\n         if not os.path.exists(os.path.join(dirname, \"__init__.py\")):\n             return dirname\ndiff --git a/tests/lint/unittest_expand_modules.py b/tests/lint/unittest_expand_modules.py\nindex 15f72d0c5..940eaae0d 100644\n--- a/tests/lint/unittest_expand_modules.py\n+++ b/tests/lint/unittest_expand_modules.py\n@@ -10,11 +10,43 @@ from pathlib import Path\n import pytest\n \n from pylint.checkers import BaseChecker\n-from pylint.lint.expand_modules import _is_in_ignore_list_re, expand_modules\n+from pylint.lint.expand_modules import _is_in_ignore_list_re, expand_modules, get_python_path\n from pylint.testutils import CheckerTestCase, set_config\n from pylint.typing import MessageDefinitionTuple\n \n \n+def test_expand_modules_with_no_duplicates_from_same_name(tmp_path: Path) -> None:\n+    \"\"\"Regression test for https://github.com/PyCQA/pylint/issues/5621\n+\n+    When a directory 'a' contains a file 'a.py' (same name as the directory),\n+    expand_modules should not fail with a parse error for the non-existent 'a/__init__.py'.\n+    \"\"\"\n+    # Create directory 'a' with 'a.py' and 'b.py' but no '__init__.py'\n+    a_dir = tmp_path / \"a\"\n+    a_dir.mkdir()\n+    (a_dir / \"a.py\").write_text(\"\")\n+    (a_dir / \"b.py\").write_text(\"\")\n+\n+    modules, errors = expand_modules(\n+        [str(a_dir)],\n+        ignore_list=[],\n+        ignore_list_re=[],\n+        ignore_list_paths_re=[],\n+    )\n+\n+    # There should be no errors (the bug caused \"Unable to load file a/__init__.py\")\n+    assert not errors\n+\n+\n+def test_get_python_path_for_directory(tmp_path: Path) -> None:\n+    \"\"\"get_python_path should return the parent of a directory, not the directory itself.\"\"\"\n+    a_dir = tmp_path / \"a\"\n+    a_dir.mkdir()\n+\n+    result = get_python_path(str(a_dir))\n+    assert result == str(tmp_path)\n+\n+\n def test__is_in_ignore_list_re_match() -> None:\n     patterns = [\n         re.compile(\".*enchilada.*\"),\n"}
{"instance_id": "pylint-dev__pylint-7228", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/config/argument.py b/pylint/config/argument.py\nindex 3c2951517..953afa59c 100644\n--- a/pylint/config/argument.py\n+++ b/pylint/config/argument.py\n@@ -17,6 +17,11 @@ import sys\n from collections.abc import Callable\n from typing import Any, Pattern, Sequence, Tuple, Union\n \n+try:\n+    import regex  # type: ignore[import]\n+except ImportError:\n+    regex = None  # type: ignore[assignment]\n+\n from pylint import interfaces\n from pylint import utils as pylint_utils\n from pylint.config.callback_actions import _CallbackAction, _ExtendAction\n@@ -99,11 +104,23 @@ def _py_version_transformer(value: str) -> tuple[int, ...]:\n     return version\n \n \n+def _regex_compile(pattern: str) -> re.Pattern[str]:\n+    \"\"\"Compile a regular expression pattern.\n+\n+    Attempts to use the ``regex`` module if it is available, which supports\n+    additional features such as Unicode property escapes (e.g. ``\\\\p{Han}``).\n+    Falls back to the standard ``re`` module if ``regex`` is not installed.\n+    \"\"\"\n+    if regex is not None:\n+        return regex.compile(pattern)  # type: ignore[return-value]\n+    return re.compile(pattern)\n+\n+\n def _regexp_csv_transfomer(value: str) -> Sequence[Pattern[str]]:\n     \"\"\"Transforms a comma separated list of regular expressions.\"\"\"\n     patterns: list[Pattern[str]] = []\n     for pattern in _csv_transformer(value):\n-        patterns.append(re.compile(pattern))\n+        patterns.append(_regex_compile(pattern))\n     return patterns\n \n \n@@ -112,7 +129,7 @@ def _regexp_paths_csv_transfomer(value: str) -> Sequence[Pattern[str]]:\n     patterns: list[Pattern[str]] = []\n     for pattern in _csv_transformer(value):\n         patterns.append(\n-            re.compile(\n+            _regex_compile(\n                 str(pathlib.PureWindowsPath(pattern)).replace(\"\\\\\", \"\\\\\\\\\")\n                 + \"|\"\n                 + pathlib.PureWindowsPath(pattern).as_posix()\n@@ -130,7 +147,7 @@ _TYPE_TRANSFORMERS: dict[str, Callable[[str], _ArgumentTypes]] = {\n     \"non_empty_string\": _non_empty_string_transformer,\n     \"path\": _path_transformer,\n     \"py_version\": _py_version_transformer,\n-    \"regexp\": re.compile,\n+    \"regexp\": _regex_compile,\n     \"regexp_csv\": _regexp_csv_transfomer,\n     \"regexp_paths_csv\": _regexp_paths_csv_transfomer,\n     \"string\": pylint_utils._unquote,\ndiff --git a/pylint/config/option.py b/pylint/config/option.py\nindex 5043fe765..20cc3d7da 100644\n--- a/pylint/config/option.py\n+++ b/pylint/config/option.py\n@@ -13,6 +13,23 @@ from re import Pattern\n \n from pylint import utils\n \n+try:\n+    import regex  # type: ignore[import]\n+except ImportError:\n+    regex = None  # type: ignore[assignment]\n+\n+\n+def _regex_compile(pattern: str) -> re.Pattern[str]:\n+    \"\"\"Compile a regular expression pattern.\n+\n+    Attempts to use the ``regex`` module if it is available, which supports\n+    additional features such as Unicode property escapes (e.g. ``\\\\p{Han}``).\n+    Falls back to the standard ``re`` module if ``regex`` is not installed.\n+    \"\"\"\n+    if regex is not None:\n+        return regex.compile(pattern)  # type: ignore[return-value]\n+    return re.compile(pattern)\n+\n \n # pylint: disable=unused-argument\n def _csv_validator(_, name, value):\n@@ -23,7 +40,7 @@ def _csv_validator(_, name, value):\n def _regexp_validator(_, name, value):\n     if hasattr(value, \"pattern\"):\n         return value\n-    return re.compile(value)\n+    return _regex_compile(value)\n \n \n # pylint: disable=unused-argument\n@@ -39,7 +56,7 @@ def _regexp_paths_csv_validator(\n     patterns = []\n     for val in _csv_validator(_, name, value):\n         patterns.append(\n-            re.compile(\n+            _regex_compile(\n                 str(pathlib.PureWindowsPath(val)).replace(\"\\\\\", \"\\\\\\\\\")\n                 + \"|\"\n                 + pathlib.PureWindowsPath(val).as_posix()\n@@ -103,7 +120,7 @@ VALIDATORS = {\n     \"string\": utils._unquote,\n     \"int\": int,\n     \"float\": float,\n-    \"regexp\": lambda pattern: re.compile(pattern or \"\"),\n+    \"regexp\": lambda pattern: _regex_compile(pattern or \"\"),\n     \"regexp_csv\": _regexp_csv_validator,\n     \"regexp_paths_csv\": _regexp_paths_csv_validator,\n     \"csv\": _csv_validator,\ndiff --git a/tests/config/unittest_config.py b/tests/config/unittest_config.py\nindex 8c668aa52..6714435ac 100644\n--- a/tests/config/unittest_config.py\n+++ b/tests/config/unittest_config.py\n@@ -16,6 +16,13 @@ from pylint.checkers import BaseChecker\n from pylint.testutils import CheckerTestCase, set_config\n from pylint.typing import MessageDefinitionTuple\n \n+try:\n+    import regex as _regex_module\n+\n+    HAS_REGEX_MODULE = True\n+except ImportError:\n+    HAS_REGEX_MODULE = False\n+\n \n def test__regexp_validator_valid() -> None:\n     result = config.option._regexp_validator(None, None, \"test_.*\")\n@@ -60,6 +67,29 @@ def test__regexp_csv_validator_invalid() -> None:\n         config.option._regexp_csv_validator(None, None, \",\".join(pattern_strings))\n \n \n+@pytest.mark.skipif(\n+    not HAS_REGEX_MODULE, reason=\"requires the 'regex' module to be installed\"\n+)\n+def test__regexp_validator_valid_with_unicode_property_escape() -> None:\n+    \"\"\"Test that Unicode property escapes work when the 'regex' module is available.\"\"\"\n+    pattern = r\"[\\p{Han}a-z_][\\p{Han}a-z0-9_]{2,30}$\"\n+    result = config.option._regexp_validator(None, None, pattern)\n+    assert result.pattern == pattern\n+    # Verify the pattern actually matches Han (Chinese) characters\n+    assert result.match(\"\u51fd\u6570\u540d\")  # Chinese function name\n+\n+\n+@pytest.mark.skipif(\n+    not HAS_REGEX_MODULE, reason=\"requires the 'regex' module to be installed\"\n+)\n+def test__regexp_csv_validator_valid_with_unicode_property_escape() -> None:\n+    \"\"\"Test that Unicode property escapes work in CSV regexp when 'regex' module is available.\"\"\"\n+    pattern_strings = [r\"[\\p{Han}a-z_][\\p{Han}a-z0-9_]{2,30}$\", \"test_.*\"]\n+    result = config.option._regexp_csv_validator(None, None, \",\".join(pattern_strings))\n+    assert len(result) == 2\n+    assert result[0].pattern == pattern_strings[0]\n+\n+\n class TestPyLinterOptionSetters(CheckerTestCase):\n     \"\"\"Class to check the set_config decorator for options declared in PyLinter.\"\"\"\n \n"}
{"instance_id": "pylint-dev__pylint-7993", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/pylint/reporters/text.py b/pylint/reporters/text.py\nindex 29bd46798..04a048d30 100644\n--- a/pylint/reporters/text.py\n+++ b/pylint/reporters/text.py\n@@ -175,7 +175,7 @@ class TextReporter(BaseReporter):\n         self._template = template\n \n         # Check to see if all parameters in the template are attributes of the Message\n-        arguments = re.findall(r\"\\{(.+?)(:.*)?\\}\", template)\n+        arguments = re.findall(r\"(?<!\\{)\\{(\\w+?)(:.*)?\\}(?!\\})\", template)\n         for argument in arguments:\n             if argument[0] not in MESSAGE_FIELDS:\n                 warnings.warn(\ndiff --git a/tests/reporters/unittest_reporting.py b/tests/reporters/unittest_reporting.py\nindex 37f3e5fd9..ff5d8e29d 100644\n--- a/tests/reporters/unittest_reporting.py\n+++ b/tests/reporters/unittest_reporting.py\n@@ -113,6 +113,25 @@ def test_template_option_non_existing(linter) -> None:\n     assert out_lines[2] == \"my_mod:2::()\"\n \n \n+def test_template_option_with_braces(linter) -> None:\n+    \"\"\"Test the msg-template option with braces escaping.\n+    This makes sure that {{ and }} are treated as literal braces and\n+    not as format arguments. See https://github.com/PyCQA/pylint/issues/7948\n+    \"\"\"\n+    output = StringIO()\n+    linter.reporter.out = output\n+    linter.config.msg_template = '{{ \"Category\": \"{category}\" }}'\n+    linter.open()\n+    with warnings.catch_warnings():\n+        warnings.simplefilter(\"error\")\n+        linter.set_current_module(\"my_mod\")\n+\n+    linter.add_message(\"C0301\", line=1, args=(1, 2))\n+\n+    out_lines = output.getvalue().split(\"\\n\")\n+    assert out_lines[1] == '{ \"Category\": \"convention\" }'\n+\n+\n def test_deprecation_set_output(recwarn):\n     \"\"\"TODO remove in 3.0.\"\"\"\n     reporter = BaseReporter()\n"}
{"instance_id": "sphinx-doc__sphinx-10325", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 62631f7ff..0d0b51cac 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -110,11 +110,11 @@ def exclude_members_option(arg: Any) -> Union[object, Set[str]]:\n \n \n def inherited_members_option(arg: Any) -> Union[object, Set[str]]:\n-    \"\"\"Used to convert the :members: option to auto directives.\"\"\"\n+    \"\"\"Used to convert the :inherited-members: option to auto directives.\"\"\"\n     if arg in (None, True):\n-        return 'object'\n+        return {'object'}\n     else:\n-        return arg\n+        return {x.strip() for x in arg.split(',')}\n \n \n def member_order_option(arg: Any) -> Optional[str]:\n@@ -682,7 +682,7 @@ class Documenter:\n         def is_filtered_inherited_member(name: str, obj: Any) -> bool:\n             if inspect.isclass(self.object):\n                 for cls in self.object.__mro__:\n-                    if cls.__name__ == self.options.inherited_members and cls != self.object:\n+                    if cls.__name__ in self.options.inherited_members and cls != self.object:\n                         # given member is a member of specified *super class*\n                         return True\n                     elif name in cls.__dict__:\ndiff --git a/tests/roots/test-ext-autodoc/target/inheritance.py b/tests/roots/test-ext-autodoc/target/inheritance.py\nindex ffac84bb6..8427d48df 100644\n--- a/tests/roots/test-ext-autodoc/target/inheritance.py\n+++ b/tests/roots/test-ext-autodoc/target/inheritance.py\n@@ -15,3 +15,7 @@ class Derived(Base):\n     def inheritedmeth(self):\n         # no docstring here\n         pass\n+\n+\n+class MyList(list):\n+    pass\ndiff --git a/tests/test_ext_autodoc.py b/tests/test_ext_autodoc.py\nindex 1f1c7e9e7..1395b2b1a 100644\n--- a/tests/test_ext_autodoc.py\n+++ b/tests/test_ext_autodoc.py\n@@ -794,6 +794,21 @@ def test_autodoc_inherited_members_None(app):\n     assert '   .. py:method:: Derived.__str__()' in actual\n \n \n+@pytest.mark.sphinx('html', testroot='ext-autodoc')\n+def test_autodoc_inherited_members_with_multiple_classes(app):\n+    options = {\"members\": None,\n+               \"inherited-members\": \"Base,list\",\n+               \"special-members\": None}\n+\n+    # members from Base should be filtered; members from list should be filtered\n+    actual = do_autodoc(app, 'class', 'target.inheritance.Derived', options)\n+    assert '   .. py:method:: Derived.inheritedmeth()' in actual  # overridden in Derived\n+    assert '   .. py:method:: Derived.inheritedclassmeth' not in actual  # from Base, filtered\n+\n+    actual = do_autodoc(app, 'class', 'target.inheritance.MyList', options)\n+    assert '   .. py:method:: MyList.append' not in actual  # from list, filtered\n+\n+\n @pytest.mark.sphinx('html', testroot='ext-autodoc')\n def test_autodoc_imported_members(app):\n     options = {\"members\": None,\n"}
{"instance_id": "sphinx-doc__sphinx-10451", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/typehints.py b/sphinx/ext/autodoc/typehints.py\nindex d912cd7d5..91cfd30e3 100644\n--- a/sphinx/ext/autodoc/typehints.py\n+++ b/sphinx/ext/autodoc/typehints.py\n@@ -2,6 +2,7 @@\n \n import re\n from collections import OrderedDict\n+from inspect import Parameter\n from typing import Any, Dict, Iterable, Set, cast\n \n from docutils import nodes\n@@ -27,7 +28,12 @@ def record_typehints(app: Sphinx, objtype: str, name: str, obj: Any,\n             sig = inspect.signature(obj, type_aliases=app.config.autodoc_type_aliases)\n             for param in sig.parameters.values():\n                 if param.annotation is not param.empty:\n-                    annotation[param.name] = typing.stringify(param.annotation, mode)\n+                    if param.kind == Parameter.VAR_POSITIONAL:\n+                        annotation['*' + param.name] = typing.stringify(param.annotation, mode)\n+                    elif param.kind == Parameter.VAR_KEYWORD:\n+                        annotation['**' + param.name] = typing.stringify(param.annotation, mode)\n+                    else:\n+                        annotation[param.name] = typing.stringify(param.annotation, mode)\n             if sig.return_annotation is not sig.empty:\n                 annotation['return'] = typing.stringify(sig.return_annotation, mode)\n     except (TypeError, ValueError):\ndiff --git a/tests/roots/test-ext-autodoc/target/typehints.py b/tests/roots/test-ext-autodoc/target/typehints.py\nindex 6b0d6142c..d04a2e2b8 100644\n--- a/tests/roots/test-ext-autodoc/target/typehints.py\n+++ b/tests/roots/test-ext-autodoc/target/typehints.py\n@@ -99,3 +99,15 @@ class _ClassWithDocumentedInit:\n \n         :param x: Some integer\n         \"\"\"\n+\n+\n+class _ClassWithDocumentedInitAndStarArgs:\n+    \"\"\"Class docstring.\"\"\"\n+\n+    def __init__(self, x: int, *args: int, **kwargs: int) -> None:\n+        \"\"\"Init docstring.\n+\n+        :param x: Some integer\n+        :param *args: Some integer\n+        :param **kwargs: Some integer\n+        \"\"\"\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex c075a8e2d..38ba2ea0e 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -1101,6 +1101,46 @@ def test_autodoc_typehints_description_with_documented_init_no_undoc_doc_rtype(a\n             '         **x** (*int*) -- Some integer\\n' == context)\n \n \n+@pytest.mark.sphinx('text', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"description\"})\n+def test_autodoc_typehints_description_with_documented_init_and_star_args(app):\n+    (app.srcdir / 'index.rst').write_text(\n+        '.. autoclass:: target.typehints._ClassWithDocumentedInitAndStarArgs\\n'\n+        '   :special-members: __init__\\n',\n+        encoding='utf8'\n+    )\n+    app.build()\n+    context = (app.outdir / 'index.txt').read_text(encoding='utf8')\n+    assert context == ('class target.typehints._ClassWithDocumentedInitAndStarArgs(x, *args, **kwargs)\\n'\n+                       '\\n'\n+                       '   Class docstring.\\n'\n+                       '\\n'\n+                       '   Parameters:\\n'\n+                       '      * **x** (*int*) --\\n'\n+                       '\\n'\n+                       '      * ***args** (*int*) --\\n'\n+                       '\\n'\n+                       '      * ****kwargs** (*int*) --\\n'\n+                       '\\n'\n+                       '   __init__(x, *args, **kwargs)\\n'\n+                       '\\n'\n+                       '      Init docstring.\\n'\n+                       '\\n'\n+                       '      Parameters:\\n'\n+                       '         * **x** (*int*) -- Some integer\\n'\n+                       '\\n'\n+                       '         * ***args** (*int*) --\\n'\n+                       '\\n'\n+                       '           Some integer\\n'\n+                       '\\n'\n+                       '         * ****kwargs** (*int*) --\\n'\n+                       '\\n'\n+                       '           Some integer\\n'\n+                       '\\n'\n+                       '      Return type:\\n'\n+                       '         None\\n')\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"description\"})\n def test_autodoc_typehints_description_for_invalid_node(app):\n"}
{"instance_id": "sphinx-doc__sphinx-11445", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py\nindex 7a1538325..5f5d9fa0e 100644\n--- a/sphinx/util/rst.py\n+++ b/sphinx/util/rst.py\n@@ -25,7 +25,7 @@ except ImportError:\n \n logger = logging.getLogger(__name__)\n \n-docinfo_re = re.compile(':\\\\w+:.*?')\n+docinfo_re = re.compile(':\\\\w+:\\\\s')\n symbols_re = re.compile(r'([!-\\-/:-@\\[-`{-~])')  # symbols without dot(0x2e)\n SECTIONING_CHARS = ['=', '-', '~']\n \ndiff --git a/tests/test_util_rst.py b/tests/test_util_rst.py\nindex 40a2ee68b..431d5645e 100644\n--- a/tests/test_util_rst.py\n+++ b/tests/test_util_rst.py\n@@ -78,6 +78,26 @@ def test_prepend_prolog_without_CR(app):\n                                       ('dummy.rst', 1, 'Sphinx is a document generator')]\n \n \n+def test_prepend_prolog_with_roles_in_heading(app):\n+    # prolog should not be inserted between a heading and its underline\n+    # when the heading contains a domain role (e.g. :mod:`name`)\n+    prolog = 'this is rst_prolog\\nhello reST!'\n+    content = StringList([':mod:`mypackage2`',\n+                          '=================',\n+                          '',\n+                          'Content'],\n+                         'dummy.rst')\n+    prepend_prolog(content, prolog)\n+\n+    assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),\n+                                      ('<rst_prolog>', 1, 'hello reST!'),\n+                                      ('<generated>', 0, ''),\n+                                      ('dummy.rst', 0, ':mod:`mypackage2`'),\n+                                      ('dummy.rst', 1, '================='),\n+                                      ('dummy.rst', 2, ''),\n+                                      ('dummy.rst', 3, 'Content')]\n+\n+\n def test_textwidth():\n     assert textwidth('Hello') == 5\n     assert textwidth('\u0440\u0443\u0441\u0441\u043a\u0438\u0439 \u044f\u0437\u044b\u043a') == 12\n"}
{"instance_id": "sphinx-doc__sphinx-7686", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autosummary/generate.py b/sphinx/ext/autosummary/generate.py\nindex a57c73fb7..1399518bb 100644\n--- a/sphinx/ext/autosummary/generate.py\n+++ b/sphinx/ext/autosummary/generate.py\n@@ -255,6 +255,10 @@ def generate_autosummary_content(name: str, obj: Any, parent: Any,\n             get_members(obj, {'exception'}, imported=imported_members)\n         ns['attributes'], ns['all_attributes'] = \\\n             get_module_attrs(ns['members'])\n+        if not imported_members:\n+            ns['members'] = [m for m in ns['members']\n+                             if getattr(safe_getattr(obj, m, None), '__module__', None) ==\n+                             obj.__name__]\n         ispackage = hasattr(obj, '__path__')\n         if ispackage and recursive:\n             ns['modules'], ns['all_modules'] = get_modules(obj)\n"}
{"instance_id": "sphinx-doc__sphinx-7738", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/napoleon/docstring.py b/sphinx/ext/napoleon/docstring.py\nindex 11409e6f6..fd0957e7f 100644\n--- a/sphinx/ext/napoleon/docstring.py\n+++ b/sphinx/ext/napoleon/docstring.py\n@@ -318,9 +318,6 @@ class GoogleDocstring:\n             return [line[min_indent:] for line in lines]\n \n     def _escape_args_and_kwargs(self, name: str) -> str:\n-        if name.endswith('_'):\n-            name = name[:-1] + r'\\_'\n-\n         if name[:2] == '**':\n             return r'\\*\\*' + name[2:]\n         elif name[:1] == '*':\ndiff --git a/tests/test_ext_napoleon_docstring.py b/tests/test_ext_napoleon_docstring.py\nindex 3027a4cb2..d9ccc4122 100644\n--- a/tests/test_ext_napoleon_docstring.py\n+++ b/tests/test_ext_napoleon_docstring.py\n@@ -1399,8 +1399,8 @@ arg_ : type\n \"\"\"\n \n         expected = \"\"\"\n-:ivar arg\\\\_: some description\n-:vartype arg\\\\_: type\n+:ivar arg_: some description\n+:vartype arg_: type\n \"\"\"\n \n         config = Config(napoleon_use_ivar=True)\n"}
{"instance_id": "sphinx-doc__sphinx-7975", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/environment/adapters/indexentries.py b/sphinx/environment/adapters/indexentries.py\nindex 5af213932..51d84fbfc 100644\n--- a/sphinx/environment/adapters/indexentries.py\n+++ b/sphinx/environment/adapters/indexentries.py\n@@ -99,7 +99,8 @@ class IndexEntries:\n                 subentry[0].sort(key=keyfunc0)  # type: ignore\n \n         # sort the index entries; put all symbols at the front, even those\n-        # following the letters in ASCII, this is where the chr(127) comes from\n+        # following the letters in Unicode, this is where the chr(127) and\n+        # chr(0) come from\n         def keyfunc(entry: Tuple[str, List]) -> Tuple[str, str]:\n             key, (void, void, category_key) = entry\n             if category_key:\n@@ -110,6 +111,9 @@ class IndexEntries:\n                 lckey = lckey[1:]\n             if lckey[0:1].isalpha() or lckey.startswith('_'):\n                 lckey = chr(127) + lckey\n+            else:\n+                # put all other symbols at the front\n+                lckey = chr(0) + lckey\n             # ensure a determinstic order *within* letters by also sorting on\n             # the entry itself\n             return (lckey, entry[0])\n@@ -152,6 +156,8 @@ class IndexEntries:\n                 key = key[1:]\n             if key[0:1].isalpha() or key.startswith('_'):\n                 key = chr(127) + key\n+            else:\n+                key = chr(0) + key\n             return key\n \n         # group the entries by letter\ndiff --git a/tests/test_environment_indexentries.py b/tests/test_environment_indexentries.py\nindex 7f6003d54..bc6f6ae73 100644\n--- a/tests/test_environment_indexentries.py\n+++ b/tests/test_environment_indexentries.py\n@@ -41,6 +41,24 @@ def test_create_single_index(app):\n     assert index[5] == ('\u05ea', [('\u200f\u05ea\u05d9\u05e8\u05d1\u05e2\u200e', [[('', '#index-7')], [], None])])\n \n \n+@pytest.mark.sphinx('dummy', freshenv=True)\n+def test_create_single_index_with_unicode_symbols(app):\n+    # Test that symbols with Unicode code points > 127 (like \u00a3, \u2190) are grouped\n+    # with other symbols (like @) in a single \"Symbols\" section, not split into\n+    # two separate sections around the alphabetical entries.\n+    text = (\".. index:: @at-symbol\\n\"\n+            \".. index:: \u00a3pound\\n\"\n+            \".. index:: \u2190arrow\\n\"\n+            \".. index:: normal\\n\")\n+    restructuredtext.parse(app, text)\n+    index = IndexEntries(app.env).create_index(app.builder)\n+    assert len(index) == 2\n+    assert index[0] == ('Symbols', [('@at-symbol', [[('', '#index-0')], [], None]),\n+                                    ('\u00a3pound', [[('', '#index-1')], [], None]),\n+                                    ('\u2190arrow', [[('', '#index-2')], [], None])])\n+    assert index[1] == ('N', [('normal', [[('', '#index-3')], [], None])])\n+\n+\n @pytest.mark.sphinx('dummy', freshenv=True)\n def test_create_pair_index(app):\n     text = (\".. index:: pair: docutils; reStructuredText\\n\"\n"}
{"instance_id": "sphinx-doc__sphinx-8273", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/builders/manpage.py b/sphinx/builders/manpage.py\nindex 4166dece9..a7ae06ecb 100644\n--- a/sphinx/builders/manpage.py\n+++ b/sphinx/builders/manpage.py\n@@ -24,7 +24,7 @@ from sphinx.util import logging\n from sphinx.util import progress_message\n from sphinx.util.console import darkgreen  # type: ignore\n from sphinx.util.nodes import inline_all_toctrees\n-from sphinx.util.osutil import make_filename_from_project\n+from sphinx.util.osutil import ensuredir, make_filename_from_project\n from sphinx.writers.manpage import ManualPageWriter, ManualPageTranslator\n \n \n@@ -82,8 +82,10 @@ class ManualPageBuilder(Builder):\n \n             targetname = '%s.%s' % (name, section)\n             logger.info(darkgreen(targetname) + ' { ', nonl=True)\n+            destination_dir = path.join(self.outdir, 'man%s' % section)\n+            ensuredir(destination_dir)\n             destination = FileOutput(\n-                destination_path=path.join(self.outdir, targetname),\n+                destination_path=path.join(destination_dir, targetname),\n                 encoding='utf-8')\n \n             tree = self.env.get_doctree(docname)\ndiff --git a/tests/test_build_manpage.py b/tests/test_build_manpage.py\nindex c3c41a2ae..6cc7cdb39 100644\n--- a/tests/test_build_manpage.py\n+++ b/tests/test_build_manpage.py\n@@ -17,9 +17,9 @@ from sphinx.config import Config\n @pytest.mark.sphinx('man')\n def test_all(app, status, warning):\n     app.builder.build_all()\n-    assert (app.outdir / 'sphinxtests.1').exists()\n+    assert (app.outdir / 'man1' / 'sphinxtests.1').exists()\n \n-    content = (app.outdir / 'sphinxtests.1').read_text()\n+    content = (app.outdir / 'man1' / 'sphinxtests.1').read_text()\n     assert r'\\fBprint \\fP\\fIi\\fP\\fB\\en\\fP' in content\n     assert r'\\fBmanpage\\en\\fP' in content\n \n@@ -33,7 +33,7 @@ def test_all(app, status, warning):\n @pytest.mark.sphinx('man', testroot='directive-code')\n def test_captioned_code_block(app, status, warning):\n     app.builder.build_all()\n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n \n     assert ('.sp\\n'\n             'caption \\\\fItest\\\\fP rb\\n'\n@@ -64,5 +64,5 @@ def test_default_man_pages():\n @pytest.mark.sphinx('man', testroot='markup-rubric')\n def test_rubric(app, status, warning):\n     app.build()\n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n     assert 'This is a rubric\\n' in content\n"}
{"instance_id": "sphinx-doc__sphinx-8282", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 978fd5df8..ccf7c3a8d 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1261,6 +1261,9 @@ class FunctionDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):  # typ\n                     documenter.objpath = [None]\n                     sigs.append(documenter.format_signature())\n         if overloaded:\n+            if self.env.config.autodoc_typehints in ('none', 'description'):\n+                kwargs.setdefault('show_annotation', False)\n+\n             __globals__ = safe_getattr(self.object, '__globals__', {})\n             for overload in self.analyzer.overloads.get('.'.join(self.objpath)):\n                 overload = evaluate_signature(overload, __globals__,\n@@ -1478,6 +1481,9 @@ class ClassDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):  # type:\n             # Use signatures for overloaded methods instead of the implementation method.\n             method = safe_getattr(self._signature_class, self._signature_method_name, None)\n             __globals__ = safe_getattr(method, '__globals__', {})\n+            if self.env.config.autodoc_typehints in ('none', 'description'):\n+                kwargs.setdefault('show_annotation', False)\n+\n             for overload in overloads:\n                 overload = evaluate_signature(overload, __globals__,\n                                               self.env.config.autodoc_type_aliases)\n@@ -1905,6 +1911,9 @@ class MethodDocumenter(DocstringSignatureMixin, ClassLevelDocumenter):  # type:\n                     documenter.objpath = [None]\n                     sigs.append(documenter.format_signature())\n         if overloaded:\n+            if self.env.config.autodoc_typehints in ('none', 'description'):\n+                kwargs.setdefault('show_annotation', False)\n+\n             __globals__ = safe_getattr(self.object, '__globals__', {})\n             for overload in self.analyzer.overloads.get('.'.join(self.objpath)):\n                 overload = evaluate_signature(overload, __globals__,\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex 7d51b7f0e..3e4150183 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -610,6 +610,61 @@ def test_autodoc_typehints_none(app):\n     ]\n \n \n+@pytest.mark.sphinx('html', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"none\"})\n+def test_autodoc_typehints_none_for_overloaded_function(app):\n+    options = {\"members\": None}\n+    actual = do_autodoc(app, 'module', 'target.overload', options)\n+    assert list(actual) == [\n+        '',\n+        '.. py:module:: target.overload',\n+        '',\n+        '',\n+        '.. py:class:: Bar(x, y)',\n+        '              Bar(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Baz(x, y)',\n+        '              Baz(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Foo(x, y)',\n+        '              Foo(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Math()',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '   .. py:method:: Math.sum(x, y)',\n+        '                  Math.sum(x, y)',\n+        '                  Math.sum(x, y)',\n+        '      :module: target.overload',\n+        '',\n+        '      docstring',\n+        '',\n+        '',\n+        '.. py:function:: sum(x, y)',\n+        '                 sum(x, y)',\n+        '                 sum(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+    ]\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"description\"})\n def test_autodoc_typehints_description(app):\n"}
{"instance_id": "sphinx-doc__sphinx-8435", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 171a3e7b0..5c958ad05 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1702,7 +1702,7 @@ class DataDocumenter(ModuleLevelDocumenter):\n         if not self.options.annotation:\n             # obtain annotation for this data\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, None, self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})\n@@ -2093,7 +2093,7 @@ class AttributeDocumenter(DocstringStripSignatureMixin, ClassLevelDocumenter):\n         if not self.options.annotation:\n             # obtain type annotation for this attribute\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, None, self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})\ndiff --git a/tests/roots/test-ext-autodoc/target/annotations.py b/tests/roots/test-ext-autodoc/target/annotations.py\nindex 691176b08..9a9c0d758 100644\n--- a/tests/roots/test-ext-autodoc/target/annotations.py\n+++ b/tests/roots/test-ext-autodoc/target/annotations.py\n@@ -4,6 +4,16 @@ from typing import overload\n \n myint = int\n \n+#: blah blah blah\n+var: myint\n+\n+\n+class Class:\n+    \"\"\"docstring\"\"\"\n+\n+    #: blah blah blah\n+    attr: myint\n+\n \n def sum(x: myint, y: myint) -> myint:\n     \"\"\"docstring\"\"\"\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex 3d1005ac0..4cb7da9d8 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -700,6 +700,19 @@ def test_autodoc_type_aliases(app):\n         '.. py:module:: target.annotations',\n         '',\n         '',\n+        '.. py:class:: Class()',\n+        '   :module: target.annotations',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '   .. py:attribute:: Class.attr',\n+        '      :module: target.annotations',\n+        '      :type: int',\n+        '',\n+        '      blah blah blah',\n+        '',\n+        '',\n         '.. py:function:: mult(x: int, y: int) -> int',\n         '                 mult(x: float, y: float) -> float',\n         '   :module: target.annotations',\n@@ -712,6 +725,13 @@ def test_autodoc_type_aliases(app):\n         '',\n         '   docstring',\n         '',\n+        '',\n+        '.. py:data:: var',\n+        '   :module: target.annotations',\n+        '   :type: int',\n+        '',\n+        '   blah blah blah',\n+        '',\n     ]\n \n     # define aliases\n@@ -722,6 +742,19 @@ def test_autodoc_type_aliases(app):\n         '.. py:module:: target.annotations',\n         '',\n         '',\n+        '.. py:class:: Class()',\n+        '   :module: target.annotations',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '   .. py:attribute:: Class.attr',\n+        '      :module: target.annotations',\n+        '      :type: myint',\n+        '',\n+        '      blah blah blah',\n+        '',\n+        '',\n         '.. py:function:: mult(x: myint, y: myint) -> myint',\n         '                 mult(x: float, y: float) -> float',\n         '   :module: target.annotations',\n@@ -734,6 +767,13 @@ def test_autodoc_type_aliases(app):\n         '',\n         '   docstring',\n         '',\n+        '',\n+        '.. py:data:: var',\n+        '   :module: target.annotations',\n+        '   :type: myint',\n+        '',\n+        '   blah blah blah',\n+        '',\n     ]\n \n \n"}
{"instance_id": "sphinx-doc__sphinx-8474", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/domains/std.py b/sphinx/domains/std.py\nindex 4bde57930..5aeec3fb4 100644\n--- a/sphinx/domains/std.py\n+++ b/sphinx/domains/std.py\n@@ -843,6 +843,10 @@ class StandardDomain(Domain):\n         if figtype is None:\n             return None\n \n+        if figtype != 'section' and self.get_numfig_title(target_node) is None:\n+            # no caption, so no number can be assigned\n+            return contnode\n+\n         if figtype != 'section' and env.config.numfig is False:\n             logger.warning(__('numfig is disabled. :numref: is ignored.'), location=node)\n             return contnode\n"}
{"instance_id": "sphinx-doc__sphinx-8506", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/domains/std.py b/sphinx/domains/std.py\nindex c87217c56..d3c8768b6 100644\n--- a/sphinx/domains/std.py\n+++ b/sphinx/domains/std.py\n@@ -43,7 +43,7 @@ logger = logging.getLogger(__name__)\n \n \n # RE for option descriptions\n-option_desc_re = re.compile(r'((?:/|--|-|\\+)?[^\\s=[]+)(=?\\s*.*)')\n+option_desc_re = re.compile(r'((?:/|--|-|\\+)?(?:\\[.*?\\]|[^\\s=[]+))(=?\\s*.*)')\n # RE for grammar tokens\n token_re = re.compile(r'`(\\w+)`', re.U)\n \ndiff --git a/tests/test_domain_std.py b/tests/test_domain_std.py\nindex 7ee1d6c07..ab11e4fd3 100644\n--- a/tests/test_domain_std.py\n+++ b/tests/test_domain_std.py\n@@ -327,6 +327,21 @@ def test_multiple_cmdoptions(app):\n     assert domain.progoptions[('cmd', '--output')] == ('index', 'cmdoption-cmd-o')\n \n \n+def test_cmdoption_with_optional_prefix(app):\n+    # Test that options with bracket notation (like QEMU's [enable=]PATTERN)\n+    # are accepted without warning (regression test for GH-8535)\n+    text = (\".. program:: qemu\\n\"\n+            \"\\n\"\n+            \".. option:: [enable=]PATTERN\\n\")\n+    domain = app.env.get_domain('std')\n+    doctree = restructuredtext.parse(app, text)\n+    assert_node(doctree, (addnodes.index,\n+                          [desc, ([desc_signature, ([desc_name, \"[enable=]\"],\n+                                                    [desc_addname, \"PATTERN\"])],\n+                                  [desc_content, ()])]))\n+    assert ('qemu', '[enable=]') in domain.progoptions\n+\n+\n @pytest.mark.skipif(docutils.__version_info__ < (0, 13),\n                     reason='docutils-0.13 or above is required')\n @pytest.mark.sphinx(testroot='productionlist')\n"}
{"instance_id": "sphinx-doc__sphinx-8595", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex d85d79617..c9f90acca 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1074,7 +1074,7 @@ class ModuleDocumenter(Documenter):\n     def get_object_members(self, want_all: bool) -> Tuple[bool, ObjectMembers]:\n         members = self.get_module_members()\n         if want_all:\n-            if not self.__all__:\n+            if self.__all__ is None:\n                 # for implicit module members, check __module__ to avoid\n                 # documenting imported objects\n                 return True, list(members.values())\n"}
{"instance_id": "sphinx-doc__sphinx-8627", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/util/typing.py b/sphinx/util/typing.py\nindex 2d4f67bba..cef015dd4 100644\n--- a/sphinx/util/typing.py\n+++ b/sphinx/util/typing.py\n@@ -86,6 +86,38 @@ def is_system_TypeVar(typ: Any) -> bool:\n     return modname == 'typing' and isinstance(typ, TypeVar)\n \n \n+def _get_annotation_module(annotation: Any) -> str:\n+    \"\"\"Return the correct module name for the given annotation.\n+\n+    This handles the case where a class (typically a C extension type) has an\n+    internal ``__module__`` attribute that points to a private implementation\n+    module (e.g. ``_struct`` for :class:`struct.Struct`).  In that case the\n+    function tries to find the corresponding public module.\n+    \"\"\"\n+    module = getattr(annotation, '__module__', None)\n+    if module is None:\n+        return ''\n+\n+    if module.startswith('_'):\n+        qualname = getattr(annotation, '__qualname__', None)\n+        if qualname:\n+            # Try the module name without the leading underscore\n+            # (e.g. '_struct' -> 'struct', '_collections' -> 'collections')\n+            public_module = module[1:]\n+            if public_module in sys.modules:\n+                candidate = sys.modules[public_module]\n+                try:\n+                    obj = candidate\n+                    for part in qualname.split('.'):\n+                        obj = getattr(obj, part)\n+                    if obj is annotation:\n+                        return public_module\n+                except AttributeError:\n+                    pass\n+\n+    return module\n+\n+\n def restify(cls: Optional[\"Type\"]) -> str:\n     \"\"\"Convert python class to a reST reference.\"\"\"\n     from sphinx.util import inspect  # lazy loading\n@@ -146,7 +178,7 @@ def _restify_py37(cls: Optional[\"Type\"]) -> str:\n         if cls.__module__ == 'typing':\n             return ':class:`%s`' % cls.__qualname__\n         else:\n-            return ':class:`%s.%s`' % (cls.__module__, cls.__qualname__)\n+            return ':class:`%s.%s`' % (_get_annotation_module(cls), cls.__qualname__)\n     elif hasattr(cls, '_name'):\n         # SpecialForm\n         if cls.__module__ == 'typing':\n@@ -325,7 +357,7 @@ def _stringify_py37(annotation: Any) -> str:\n         else:\n             qualname = stringify(annotation.__origin__)  # ex. Union\n     elif hasattr(annotation, '__qualname__'):\n-        qualname = '%s.%s' % (module, annotation.__qualname__)\n+        qualname = '%s.%s' % (_get_annotation_module(annotation), annotation.__qualname__)\n     elif hasattr(annotation, '__origin__'):\n         # instantiated generic provided by a user\n         qualname = stringify(annotation.__origin__)\ndiff --git a/tests/test_util_typing.py b/tests/test_util_typing.py\nindex a2565f1e1..ae13aa666 100644\n--- a/tests/test_util_typing.py\n+++ b/tests/test_util_typing.py\n@@ -8,6 +8,7 @@\n     :license: BSD, see LICENSE for details.\n \"\"\"\n \n+import struct\n import sys\n from numbers import Integral\n from typing import (Any, Callable, Dict, Generator, List, NewType, Optional, Tuple, TypeVar,\n@@ -119,6 +120,11 @@ def test_restify_broken_type_hints():\n     assert restify(BrokenType) == ':class:`tests.test_util_typing.BrokenType`'\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 7), reason='python 3.7+ is required.')\n+def test_restify_type_hints_Struct():\n+    assert restify(struct.Struct) == ':class:`struct.Struct`'\n+\n+\n def test_stringify():\n     assert stringify(int) == \"int\"\n     assert stringify(str) == \"str\"\n@@ -205,3 +211,8 @@ def test_stringify_type_hints_alias():\n \n def test_stringify_broken_type_hints():\n     assert stringify(BrokenType) == 'tests.test_util_typing.BrokenType'\n+\n+\n+@pytest.mark.skipif(sys.version_info < (3, 7), reason='python 3.7+ is required.')\n+def test_stringify_type_hints_Struct():\n+    assert stringify(struct.Struct) == 'struct.Struct'\n"}
{"instance_id": "sphinx-doc__sphinx-8713", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/napoleon/docstring.py b/sphinx/ext/napoleon/docstring.py\nindex 755088ca5..a5a986e49 100644\n--- a/sphinx/ext/napoleon/docstring.py\n+++ b/sphinx/ext/napoleon/docstring.py\n@@ -682,7 +682,13 @@ class GoogleDocstring:\n         return self._parse_generic_section(_('Notes'), use_admonition)\n \n     def _parse_other_parameters_section(self, section: str) -> List[str]:\n-        return self._format_fields(_('Other Parameters'), self._consume_fields())\n+        if self._config.napoleon_use_param:\n+            # Allow to declare multiple parameters at once (ex: x, y: int)\n+            fields = self._consume_fields(multiple=True)\n+            return self._format_docutils_params(fields)\n+        else:\n+            fields = self._consume_fields()\n+            return self._format_fields(_('Other Parameters'), fields)\n \n     def _parse_parameters_section(self, section: str) -> List[str]:\n         if self._config.napoleon_use_param:\n"}
{"instance_id": "sphinx-doc__sphinx-8721", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/viewcode.py b/sphinx/ext/viewcode.py\nindex a7d52a91c..060604e25 100644\n--- a/sphinx/ext/viewcode.py\n+++ b/sphinx/ext/viewcode.py\n@@ -182,6 +182,8 @@ def collect_pages(app: Sphinx) -> Generator[Tuple[str, Dict[str, Any], str], Non\n     env = app.builder.env\n     if not hasattr(env, '_viewcode_modules'):\n         return\n+    if app.builder.name.startswith(\"epub\") and not env.config.viewcode_enable_epub:\n+        return\n     highlighter = app.builder.highlighter  # type: ignore\n     urito = app.builder.get_relative_uri\n \n"}
{"instance_id": "sphinx-doc__sphinx-8801", "model_name_or_path": "claude-code-baseline", "model_patch": "diff --git a/sphinx/ext/autodoc/importer.py b/sphinx/ext/autodoc/importer.py\nindex 477aae247..d3cc555fa 100644\n--- a/sphinx/ext/autodoc/importer.py\n+++ b/sphinx/ext/autodoc/importer.py\n@@ -307,9 +307,12 @@ def get_class_members(subject: Any, objpath: List[str], attrgetter: Callable\n                 analyzer = ModuleAnalyzer.for_module(modname)\n                 analyzer.analyze()\n                 for (ns, name), docstring in analyzer.attr_docs.items():\n-                    if ns == qualname and name not in members:\n-                        members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n-                                                     docstring='\\n'.join(docstring))\n+                    if ns == qualname:\n+                        if name not in members:\n+                            members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n+                                                         docstring='\\n'.join(docstring))\n+                        elif members[name].docstring is None:\n+                            members[name].docstring = '\\n'.join(docstring)\n             except (AttributeError, PycodeError):\n                 pass\n     except AttributeError:\ndiff --git a/tests/roots/test-ext-autodoc/target/inheritance.py b/tests/roots/test-ext-autodoc/target/inheritance.py\nindex ffac84bb6..8609f3833 100644\n--- a/tests/roots/test-ext-autodoc/target/inheritance.py\n+++ b/tests/roots/test-ext-autodoc/target/inheritance.py\n@@ -15,3 +15,12 @@ class Derived(Base):\n     def inheritedmeth(self):\n         # no docstring here\n         pass\n+\n+\n+class Foo:\n+    #: docstring\n+    attr: int\n+\n+\n+class Bar(Foo):\n+    pass\ndiff --git a/tests/test_ext_autodoc.py b/tests/test_ext_autodoc.py\nindex d555359cf..f04b2260f 100644\n--- a/tests/test_ext_autodoc.py\n+++ b/tests/test_ext_autodoc.py\n@@ -625,6 +625,14 @@ def test_autodoc_inherited_members(app):\n     ]\n \n \n+@pytest.mark.sphinx('html', testroot='ext-autodoc')\n+def test_autodoc_inherited_members_with_annotations(app):\n+    options = {\"members\": None,\n+               \"inherited-members\": None}\n+    actual = do_autodoc(app, 'class', 'target.inheritance.Bar', options)\n+    assert '   .. py:attribute:: Bar.attr' in actual\n+\n+\n @pytest.mark.sphinx('html', testroot='ext-autodoc')\n def test_autodoc_inherited_members_Base(app):\n     options = {\"members\": None,\n"}
