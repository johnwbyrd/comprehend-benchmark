{
  "config": "comprehend",
  "repo_dir": "/tmp/swebench_iu299bow/sphinx-doc__sphinx",
  "wall_time_seconds": 714,
  "git_diff": "diff --git a/sphinx/ext/autodoc/typehints.py b/sphinx/ext/autodoc/typehints.py\nindex d912cd7d5..910259f09 100644\n--- a/sphinx/ext/autodoc/typehints.py\n+++ b/sphinx/ext/autodoc/typehints.py\n@@ -27,7 +27,12 @@ def record_typehints(app: Sphinx, objtype: str, name: str, obj: Any,\n             sig = inspect.signature(obj, type_aliases=app.config.autodoc_type_aliases)\n             for param in sig.parameters.values():\n                 if param.annotation is not param.empty:\n-                    annotation[param.name] = typing.stringify(param.annotation, mode)\n+                    if param.kind == param.VAR_POSITIONAL:\n+                        annotation['*' + param.name] = typing.stringify(param.annotation, mode)\n+                    elif param.kind == param.VAR_KEYWORD:\n+                        annotation['**' + param.name] = typing.stringify(param.annotation, mode)\n+                    else:\n+                        annotation[param.name] = typing.stringify(param.annotation, mode)\n             if sig.return_annotation is not sig.empty:\n                 annotation['return'] = typing.stringify(sig.return_annotation, mode)\n     except (TypeError, ValueError):\n@@ -115,7 +120,14 @@ def modify_field_list(node: nodes.field_list, annotations: Dict[str, str],\n         if name == 'return':\n             continue\n \n-        arg = arguments.get(name, {})\n+        if name in arguments:\n+            arg = arguments.get(name, {})\n+        elif name.startswith('**') and name[2:] in arguments:\n+            arg = arguments.get(name[2:], {})\n+        elif name.startswith('*') and name[1:] in arguments:\n+            arg = arguments.get(name[1:], {})\n+        else:\n+            arg = {}\n         if not arg.get('type'):\n             field = nodes.field()\n             field += nodes.field_name('', 'type ' + name)\n@@ -167,13 +179,21 @@ def augment_descriptions_with_types(\n             has_type.add('return')\n \n     # Add 'type' for parameters with a description but no declared type.\n-    for name in annotations:\n+    for name, annotation in annotations.items():\n         if name in ('return', 'returns'):\n             continue\n-        if name in has_description and name not in has_type:\n+        if name in has_description:\n+            field_name = name\n+        elif name.startswith('**') and name[2:] in has_description:\n+            field_name = name[2:]\n+        elif name.startswith('*') and name[1:] in has_description:\n+            field_name = name[1:]\n+        else:\n+            field_name = name\n+        if field_name in has_description and field_name not in has_type:\n             field = nodes.field()\n-            field += nodes.field_name('', 'type ' + name)\n-            field += nodes.field_body('', nodes.paragraph('', annotations[name]))\n+            field += nodes.field_name('', 'type ' + field_name)\n+            field += nodes.field_body('', nodes.paragraph('', annotation))\n             node += field\n \n     # Add 'rtype' if 'return' is present and 'rtype' isn't.\ndiff --git a/tests/roots/test-ext-autodoc/target/typehints.py b/tests/roots/test-ext-autodoc/target/typehints.py\nindex 6b0d6142c..d04a2e2b8 100644\n--- a/tests/roots/test-ext-autodoc/target/typehints.py\n+++ b/tests/roots/test-ext-autodoc/target/typehints.py\n@@ -99,3 +99,15 @@ class _ClassWithDocumentedInit:\n \n         :param x: Some integer\n         \"\"\"\n+\n+\n+class _ClassWithDocumentedInitAndStarArgs:\n+    \"\"\"Class docstring.\"\"\"\n+\n+    def __init__(self, x: int, *args: int, **kwargs: int) -> None:\n+        \"\"\"Init docstring.\n+\n+        :param x: Some integer\n+        :param *args: Some integer\n+        :param **kwargs: Some integer\n+        \"\"\"\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex c075a8e2d..d5e075608 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -1101,6 +1101,46 @@ def test_autodoc_typehints_description_with_documented_init_no_undoc_doc_rtype(a\n             '         **x** (*int*) -- Some integer\\n' == context)\n \n \n+@pytest.mark.sphinx('text', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"description\"})\n+def test_autodoc_typehints_description_with_documented_init_and_star_args(app):\n+    (app.srcdir / 'index.rst').write_text(\n+        '.. autoclass:: target.typehints._ClassWithDocumentedInitAndStarArgs\\n'\n+        '   :special-members: __init__\\n',\n+        encoding='utf8'\n+    )\n+    app.build()\n+    context = (app.outdir / 'index.txt').read_text(encoding='utf8')\n+    assert ('class target.typehints._ClassWithDocumentedInitAndStarArgs(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '   Class docstring.\\n'\n+            '\\n'\n+            '   Parameters:\\n'\n+            '      * **x** (*int*) --\\n'\n+            '\\n'\n+            '      * ***args** (*int*) --\\n'\n+            '\\n'\n+            '      * ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '   __init__(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '      Init docstring.\\n'\n+            '\\n'\n+            '      Parameters:\\n'\n+            '         * **x** (*int*) -- Some integer\\n'\n+            '\\n'\n+            '         * ***args** (*int*) --\\n'\n+            '\\n'\n+            '           Some integer\\n'\n+            '\\n'\n+            '         * ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '           Some integer\\n'\n+            '\\n'\n+            '      Return type:\\n'\n+            '         None\\n' == context)\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"description\"})\n def test_autodoc_typehints_description_for_invalid_node(app):\n",
  "claude_output": {
    "type": "result",
    "subtype": "success",
    "is_error": false,
    "duration_ms": 712665,
    "duration_api_ms": 739014,
    "num_turns": 60,
    "result": "Here's a summary of the changes made to fix the bug:\n\n## Summary\n\nThe bug was in `sphinx/ext/autodoc/typehints.py` where `*args` and `**kwargs` parameters were duplicated when using `autodoc_typehints = \"description\"` with docstrings that document these parameters using their starred names (`:param *args:`, `:param **kwargs:`).\n\n### Root Cause\n\n1. **`record_typehints()`** stored parameter names without asterisk prefixes (`args`, `kwargs`) regardless of whether they were `VAR_POSITIONAL` or `VAR_KEYWORD` parameters.\n\n2. **`modify_field_list()`** looked up annotation names in the `arguments` dict (built from the docstring fields). When the docstring had `:param *args:`, the key in `arguments` was `*args`, but the annotation key was `args` \u2014 so the lookup missed, and duplicate entries were created.\n\n3. **`augment_descriptions_with_types()`** had the same mismatch problem.\n\n### Fix\n\n**`record_typehints()`** \u2014 now stores `*args` and `**kwargs` with their asterisk prefixes for `VAR_POSITIONAL` and `VAR_KEYWORD` parameters respectively.\n\n**`modify_field_list()`** \u2014 now also checks for stripped names (e.g., annotation `*args` \u2192 check `arguments['*args']`, then fall back to `arguments['args']` for docstrings using plain names).\n\n**`augment_descriptions_with_types()`** \u2014 same fix using a `field_name` variable to track the actual name used in the docstring.\n\n### Test Added\n\n- New fixture class `_ClassWithDocumentedInitAndStarArgs` in `tests/roots/test-ext-autodoc/target/typehints.py`\n- New test `test_autodoc_typehints_description_with_documented_init_and_star_args` in `tests/test_ext_autodoc_configs.py`",
    "stop_reason": null,
    "session_id": "bab3e67c-ed1e-459d-a9fe-c047cc1865c0",
    "total_cost_usd": 2.902353199999999,
    "usage": {
      "input_tokens": 62,
      "cache_creation_input_tokens": 60119,
      "cache_read_input_tokens": 3099283,
      "output_tokens": 27584,
      "server_tool_use": {
        "web_search_requests": 0,
        "web_fetch_requests": 0
      },
      "service_tier": "standard",
      "cache_creation": {
        "ephemeral_1h_input_tokens": 60119,
        "ephemeral_5m_input_tokens": 0
      },
      "inference_geo": "",
      "iterations": [],
      "speed": "standard"
    },
    "modelUsage": {
      "claude-sonnet-4-6": {
        "inputTokens": 62,
        "outputTokens": 27584,
        "cacheReadInputTokens": 3099283,
        "cacheCreationInputTokens": 60119,
        "webSearchRequests": 0,
        "costUSD": 2.61529525,
        "contextWindow": 200000,
        "maxOutputTokens": 32000
      },
      "claude-haiku-4-5-20251001": {
        "inputTokens": 102013,
        "outputTokens": 9610,
        "cacheReadInputTokens": 834862,
        "cacheCreationInputTokens": 42807,
        "webSearchRequests": 0,
        "costUSD": 0.2870579499999999,
        "contextWindow": 200000,
        "maxOutputTokens": 32000
      }
    },
    "permission_denials": [],
    "uuid": "ffe28832-9d7e-40fa-82e9-0b0d2118097f"
  },
  "session_id": "bab3e67c-ed1e-459d-a9fe-c047cc1865c0",
  "result_text": "Here's a summary of the changes made to fix the bug:\n\n## Summary\n\nThe bug was in `sphinx/ext/autodoc/typehints.py` where `*args` and `**kwargs` parameters were duplicated when using `autodoc_typehints = \"description\"` with docstrings that document these parameters using their starred names (`:param *args:`, `:param **kwargs:`).\n\n### Root Cause\n\n1. **`record_typehints()`** stored parameter names without asterisk prefixes (`args`, `kwargs`) regardless of whether they were `VAR_POSITIONAL` or `VAR_KEYWORD` parameters.\n\n2. **`modify_field_list()`** looked up annotation names in the `arguments` dict (built from the docstring fields). When the docstring had `:param *args:`, the key in `arguments` was `*args`, but the annotation key was `args` \u2014 so the lookup missed, and duplicate entries were created.\n\n3. **`augment_descriptions_with_types()`** had the same mismatch problem.\n\n### Fix\n\n**`record_typehints()`** \u2014 now stores `*args` and `**kwargs` with their asterisk prefixes for `VAR_POSITIONAL` and `VAR_KEYWORD` parameters respectively.\n\n**`modify_field_list()`** \u2014 now also checks for stripped names (e.g., annotation `*args` \u2192 check `arguments['*args']`, then fall back to `arguments['args']` for docstrings using plain names).\n\n**`augment_descriptions_with_types()`** \u2014 same fix using a `field_name` variable to track the actual name used in the docstring.\n\n### Test Added\n\n- New fixture class `_ClassWithDocumentedInitAndStarArgs` in `tests/roots/test-ext-autodoc/target/typehints.py`\n- New test `test_autodoc_typehints_description_with_documented_init_and_star_args` in `tests/test_ext_autodoc_configs.py`",
  "total_cost_usd": 2.902353199999999,
  "num_turns": 60
}