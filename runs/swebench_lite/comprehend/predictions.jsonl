{"instance_id": "astropy__astropy-12907", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex a308e27297..45bea36085 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -242,7 +242,7 @@ def _cstack(left, right):\n         cright = _coord_matrix(right, 'right', noutp)\n     else:\n         cright = np.zeros((noutp, right.shape[1]))\n-        cright[-right.shape[0]:, -right.shape[1]:] = 1\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n \n     return np.hstack([cleft, cright])\n \ndiff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py\nindex 8dfe5c8626..e43d6b3cdd 100644\n--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -135,6 +135,22 @@ def test_separable(compound_model, result):\n     assert_allclose(separability_matrix(compound_model), result[1])\n \n \n+def test_separability_matrix_nested_compound_model():\n+    \"\"\"\n+    Test that separability_matrix gives correct result for nested CompoundModels.\n+    Regression test for https://github.com/astropy/astropy/issues/12907\n+    \"\"\"\n+    # cm is separable: output 0 depends only on input 0, output 1 only on input 1\n+    cm = models.Linear1D(10) & models.Linear1D(5)\n+    assert_allclose(separability_matrix(cm), np.array([[True, False], [False, True]]))\n+\n+    # Nesting cm inside another compound model should give the same result as\n+    # using the flat equivalent: Pix2Sky_TAN() & Linear1D(10) & Linear1D(5)\n+    nested = models.Pix2Sky_TAN() & cm\n+    flat = models.Pix2Sky_TAN() & models.Linear1D(10) & models.Linear1D(5)\n+    assert_allclose(separability_matrix(nested), separability_matrix(flat))\n+\n+\n def test_custom_model_separable():\n     @custom_model\n     def model_a(x):\n"}
{"instance_id": "astropy__astropy-14182", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/io/ascii/rst.py b/astropy/io/ascii/rst.py\nindex abdeba8efb..35de6ec80f 100644\n--- a/astropy/io/ascii/rst.py\n+++ b/astropy/io/ascii/rst.py\n@@ -57,10 +57,12 @@ class RST(FixedWidth):\n     data_class = SimpleRSTData\n     header_class = SimpleRSTHeader\n \n-    def __init__(self):\n-        super().__init__(delimiter_pad=None, bookend=False)\n+    def __init__(self, header_rows=None):\n+        super().__init__(delimiter_pad=None, bookend=False, header_rows=header_rows)\n+        self.data.start_line = 2 + len(self.data.header_rows)\n \n     def write(self, lines):\n         lines = super().write(lines)\n-        lines = [lines[1]] + lines + [lines[1]]\n+        idx = len(self.data.header_rows)\n+        lines = [lines[idx]] + lines + [lines[idx]]\n         return lines\ndiff --git a/astropy/io/ascii/tests/test_rst.py b/astropy/io/ascii/tests/test_rst.py\nindex 84d6fed401..d020576791 100644\n--- a/astropy/io/ascii/tests/test_rst.py\n+++ b/astropy/io/ascii/tests/test_rst.py\n@@ -2,7 +2,9 @@\n \n from io import StringIO\n \n+import astropy.units as u\n from astropy.io import ascii\n+from astropy.table import QTable\n \n from .common import assert_almost_equal, assert_equal\n \n@@ -185,3 +187,39 @@ Col1      Col2 Col3 Col4\n ==== ========= ==== ====\n \"\"\",\n     )\n+\n+\n+def test_write_header_rows():\n+    \"\"\"Write a QTable as RST with header_rows including units\"\"\"\n+    tbl = QTable({\"wave\": [350, 950] * u.nm, \"response\": [0.7, 1.2] * u.count})\n+    out = StringIO()\n+    tbl.write(out, format=\"ascii.rst\", header_rows=[\"name\", \"unit\"])\n+    assert_equal_splitlines(\n+        out.getvalue(),\n+        \"\"\"\\\n+===== ========\n+ wave response\n+   nm       ct\n+===== ========\n+350.0      0.7\n+950.0      1.2\n+===== ========\n+\"\"\",\n+    )\n+\n+\n+def test_read_header_rows():\n+    \"\"\"Read an RST table with header_rows including units\"\"\"\n+    table = \"\"\"\\\n+===== ========\n+ wave response\n+   nm       ct\n+===== ========\n+350.0      0.7\n+950.0      1.2\n+===== ========\n+\"\"\"\n+    tbl = ascii.read(table, format=\"ascii.rst\", header_rows=[\"name\", \"unit\"])\n+    assert tbl.colnames == [\"wave\", \"response\"]\n+    assert str(tbl[\"wave\"].unit) == \"nm\"\n+    assert str(tbl[\"response\"].unit) == \"ct\"\n"}
{"instance_id": "astropy__astropy-14365", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/io/ascii/qdp.py b/astropy/io/ascii/qdp.py\nindex 83a4f004aa..5324dc81cc 100644\n--- a/astropy/io/ascii/qdp.py\n+++ b/astropy/io/ascii/qdp.py\n@@ -68,7 +68,7 @@ def _line_type(line, delimiter=None):\n     _new_re = rf\"NO({sep}NO)+\"\n     _data_re = rf\"({_decimal_re}|NO|[-+]?nan)({sep}({_decimal_re}|NO|[-+]?nan))*)\"\n     _type_re = rf\"^\\s*((?P<command>{_command_re})|(?P<new>{_new_re})|(?P<data>{_data_re})?\\s*(\\!(?P<comment>.*))?\\s*$\"\n-    _line_type_re = re.compile(_type_re)\n+    _line_type_re = re.compile(_type_re, re.IGNORECASE)\n     line = line.strip()\n     if not line:\n         return \"comment\"\n@@ -306,7 +306,7 @@ def _get_tables_from_qdp_file(qdp_file, input_colnames=None, delimiter=None):\n \n             values = []\n             for v in line.split(delimiter):\n-                if v == \"NO\":\n+                if v.upper() == \"NO\":\n                     values.append(np.ma.masked)\n                 else:\n                     # Understand if number is int or float\n"}
{"instance_id": "astropy__astropy-14995", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex 4153dfccb2..56a8678791 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -520,7 +520,7 @@ class NDArithmeticMixin:\n         elif self.mask is None and operand is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+        elif operand is None or operand.mask is None:\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\ndiff --git a/astropy/nddata/mixins/tests/test_ndarithmetic.py b/astropy/nddata/mixins/tests/test_ndarithmetic.py\nindex 8c461155ab..5cd4b1291c 100644\n--- a/astropy/nddata/mixins/tests/test_ndarithmetic.py\n+++ b/astropy/nddata/mixins/tests/test_ndarithmetic.py\n@@ -1226,6 +1226,34 @@ def test_arithmetics_mask_func():\n         nd1.add(nd2, handle_mask=mask_sad_func, fun=1)\n \n \n+def test_arithmetic_mask_func_one_operand_no_mask():\n+    # Regression test for https://github.com/astropy/astropy/issues/15228\n+    # When one operand has no mask, handle_mask should not be called with None\n+    array = np.array([[0, 1, 0], [1, 0, 1], [0, 1, 0]])\n+    mask = np.array([[0, 1, 64], [8, 0, 1], [2, 1, 0]])\n+\n+    nref_nomask = NDDataRef(array)\n+    nref_mask = NDDataRef(array, mask=mask)\n+\n+    # multiply no mask by constant (no mask * no mask)\n+    assert nref_nomask.multiply(1.0, handle_mask=np.bitwise_or).mask is None\n+\n+    # multiply no mask by itself (no mask * no mask)\n+    assert nref_nomask.multiply(nref_nomask, handle_mask=np.bitwise_or).mask is None\n+\n+    # multiply mask by constant (mask * no mask)\n+    result = nref_mask.multiply(1.0, handle_mask=np.bitwise_or)\n+    np.testing.assert_array_equal(result.mask, mask)\n+\n+    # multiply mask by itself (mask * mask)\n+    result = nref_mask.multiply(nref_mask, handle_mask=np.bitwise_or)\n+    np.testing.assert_array_equal(result.mask, mask)\n+\n+    # multiply mask by no mask (mask * no mask)\n+    result = nref_mask.multiply(nref_nomask, handle_mask=np.bitwise_or)\n+    np.testing.assert_array_equal(result.mask, mask)\n+\n+\n @pytest.mark.parametrize(\"meth\", [\"add\", \"subtract\", \"divide\", \"multiply\"])\n def test_two_argument_useage(meth):\n     ndd1 = NDDataArithmetic(np.ones((3, 3)))\n"}
{"instance_id": "astropy__astropy-6938", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/io/fits/fitsrec.py b/astropy/io/fits/fitsrec.py\nindex 574b4073b1..36e4a5899a 100644\n--- a/astropy/io/fits/fitsrec.py\n+++ b/astropy/io/fits/fitsrec.py\n@@ -1261,7 +1261,8 @@ class FITS_rec(np.recarray):\n \n         # Replace exponent separator in floating point numbers\n         if 'D' in format:\n-            output_field.replace(encode_ascii('E'), encode_ascii('D'))\n+            output_field[:] = np.char.replace(output_field, encode_ascii('E'),\n+                                               encode_ascii('D'))\n \n \n def _get_recarray_field(array, key):\n"}
{"instance_id": "astropy__astropy-7746", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/astropy/wcs/wcs.py b/astropy/wcs/wcs.py\nindex d3a06f2b31..46b4d824f7 100644\n--- a/astropy/wcs/wcs.py\n+++ b/astropy/wcs/wcs.py\n@@ -1220,6 +1220,11 @@ reduce these to 2 dimensions using the naxis kwarg.\n \n             xy = np.hstack([x.reshape((x.size, 1)) for x in axes])\n \n+            if 0 in xy.shape:\n+                if ra_dec_order and sky == 'output':\n+                    return (xy[:, 0], xy[:, 1])\n+                return [xy[:, i] for i in range(xy.shape[1])]\n+\n             if ra_dec_order and sky == 'input':\n                 xy = self._denormalize_sky(xy)\n             output = func(xy, origin)\n@@ -1235,6 +1240,8 @@ reduce these to 2 dimensions using the naxis kwarg.\n                 raise ValueError(\n                     \"When providing two arguments, the array must be \"\n                     \"of shape (N, {0})\".format(self.naxis))\n+            if 0 in xy.shape:\n+                return xy\n             if ra_dec_order and sky == 'input':\n                 xy = self._denormalize_sky(xy)\n             result = func(xy, origin)\n"}
{"instance_id": "matplotlib__matplotlib-18869", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex b657a35cf7..479eed30d1 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -114,6 +114,8 @@ from matplotlib.rcsetup import validate_backend, cycler\n \n _log = logging.getLogger(__name__)\n \n+_VersionInfo = namedtuple('_VersionInfo', 'major, minor, micro')\n+\n __bibtex__ = r\"\"\"@Article{Hunter:2007,\n   Author    = {Hunter, J. D.},\n   Title     = {Matplotlib: A 2D graphics environment},\n@@ -131,7 +133,7 @@ __bibtex__ = r\"\"\"@Article{Hunter:2007,\n \n \n def __getattr__(name):\n-    if name == \"__version__\":\n+    if name in (\"__version__\", \"__version_info__\"):\n         import setuptools_scm\n         global __version__  # cache it.\n         # Only shell out to a git subprocess if really needed, and not on a\n@@ -147,7 +149,11 @@ def __getattr__(name):\n             )\n         else:  # Get the version from the _version.py setuptools_scm file.\n             __version__ = _version.version\n-        return __version__\n+        global __version_info__\n+        __version_info__ = _VersionInfo(*parse_version(__version__).release[:3])\n+        if name == \"__version__\":\n+            return __version__\n+        return __version_info__\n     raise AttributeError(f\"module {__name__!r} has no attribute {name!r}\")\n \n \ndiff --git a/lib/matplotlib/tests/test_matplotlib.py b/lib/matplotlib/tests/test_matplotlib.py\nindex cad9433a56..1df8115c2b 100644\n--- a/lib/matplotlib/tests/test_matplotlib.py\n+++ b/lib/matplotlib/tests/test_matplotlib.py\n@@ -52,6 +52,17 @@ def test_use_doc_standard_backends():\n             set(matplotlib.rcsetup.non_interactive_bk))\n \n \n+def test_version_info():\n+    assert matplotlib.__version_info__ >= (3, 0, 0)\n+    assert isinstance(matplotlib.__version_info__.major, int)\n+    assert isinstance(matplotlib.__version_info__.minor, int)\n+    assert isinstance(matplotlib.__version_info__.micro, int)\n+    assert (f\"{matplotlib.__version_info__.major}\"\n+            f\".{matplotlib.__version_info__.minor}\"\n+            f\".{matplotlib.__version_info__.micro}\"\n+            in matplotlib.__version__)\n+\n+\n def test_importable_with__OO():\n     \"\"\"\n     When using -OO or export PYTHONOPTIMIZE=2, docstrings are discarded,\n"}
{"instance_id": "matplotlib__matplotlib-22711", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/widgets.py b/lib/matplotlib/widgets.py\nindex da5b40a5ef..5828b7b545 100644\n--- a/lib/matplotlib/widgets.py\n+++ b/lib/matplotlib/widgets.py\n@@ -897,20 +897,22 @@ class RangeSlider(SliderBase):\n         _api.check_shape((2,), val=val)\n         val[0] = self._min_in_bounds(val[0])\n         val[1] = self._max_in_bounds(val[1])\n-        xy = self.poly.xy\n         if self.orientation == \"vertical\":\n-            xy[0] = .25, val[0]\n-            xy[1] = .25, val[1]\n-            xy[2] = .75, val[1]\n-            xy[3] = .75, val[0]\n-            xy[4] = .25, val[0]\n+            self.poly.xy = [\n+                [.25, val[0]],\n+                [.25, val[1]],\n+                [.75, val[1]],\n+                [.75, val[0]],\n+                [.25, val[0]],\n+            ]\n         else:\n-            xy[0] = val[0], .25\n-            xy[1] = val[0], .75\n-            xy[2] = val[1], .75\n-            xy[3] = val[1], .25\n-            xy[4] = val[0], .25\n-        self.poly.xy = xy\n+            self.poly.xy = [\n+                [val[0], .25],\n+                [val[0], .75],\n+                [val[1], .75],\n+                [val[1], .25],\n+                [val[0], .25],\n+            ]\n         self.valtext.set_text(self._format(val))\n         if self.drawon:\n             self.ax.figure.canvas.draw_idle()\n"}
{"instance_id": "matplotlib__matplotlib-22835", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex 1f33b9d3ec..8b17643497 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -1304,10 +1304,14 @@ class Artist:\n             normed = self.norm(data)\n             if np.isfinite(normed):\n                 # Midpoints of neighboring color intervals.\n-                neighbors = self.norm.inverse(\n-                    (int(self.norm(data) * n) + np.array([0, 1])) / n)\n-                delta = abs(neighbors - data).max()\n-                g_sig_digits = cbook._g_sig_digits(data, delta)\n+                try:\n+                    neighbors = self.norm.inverse(\n+                        (int(self.norm(data) * n) + np.array([0, 1])) / n)\n+                    delta = abs(neighbors - data).max()\n+                    g_sig_digits = cbook._g_sig_digits(data, delta)\n+                except ValueError:\n+                    # Norm is not invertible.\n+                    g_sig_digits = 3\n             else:\n                 g_sig_digits = 3  # Consistent with default below.\n             return \"[{:-#.{}g}]\".format(data, g_sig_digits)\ndiff --git a/lib/matplotlib/tests/test_image.py b/lib/matplotlib/tests/test_image.py\nindex e8e90b7680..b85b3346c3 100644\n--- a/lib/matplotlib/tests/test_image.py\n+++ b/lib/matplotlib/tests/test_image.py\n@@ -1086,6 +1086,14 @@ def test_image_cursor_formatting():\n     assert im.format_cursor_data(data) == '[nan]'\n \n \n+def test_image_cursor_formatting_with_boundary_norm():\n+    fig, ax = plt.subplots()\n+    norm = mpl.colors.BoundaryNorm(np.linspace(-4, 4, 5), 256)\n+    im = ax.imshow(np.zeros((4, 4)), norm=norm)\n+    # BoundaryNorm is not invertible; format_cursor_data should not crash.\n+    assert im.format_cursor_data(1.0) == '[1.0]'\n+\n+\n @check_figures_equal()\n def test_image_array_alpha(fig_test, fig_ref):\n     \"\"\"Per-pixel alpha channel test.\"\"\"\n"}
{"instance_id": "matplotlib__matplotlib-23299", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex e3c66ea67c..cc09b4e629 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -222,7 +222,6 @@ def switch_backend(newbackend):\n     global _backend_mod\n     # make sure the init is pulled up so we can assign to it later\n     import matplotlib.backends\n-    close(\"all\")\n \n     if newbackend is rcsetup._auto_backend_sentinel:\n         current_framework = cbook._get_running_interactive_framework()\n@@ -260,6 +259,19 @@ def switch_backend(newbackend):\n             rcParamsOrig[\"backend\"] = \"agg\"\n             return\n \n+    # If the same backend was already loaded, skip switching (this can happen\n+    # if e.g. an rc_context that was entered before the backend was resolved\n+    # restores rcParams to the auto-backend sentinel on exit, then\n+    # get_backend() triggers re-resolution which would otherwise close all\n+    # open figures via the close(\"all\") below).\n+    if (cbook._backend_module_name(newbackend)\n+            == cbook._backend_module_name(\n+                rcParamsDefault._get_backend_or_none() or \"\")):\n+        rcParams['backend'] = newbackend\n+        return\n+\n+    close(\"all\")\n+\n     backend_mod = importlib.import_module(\n         cbook._backend_module_name(newbackend))\n     canvas_class = backend_mod.FigureCanvas\ndiff --git a/lib/matplotlib/tests/test_pyplot.py b/lib/matplotlib/tests/test_pyplot.py\nindex f824df490c..d3e71ef1d0 100644\n--- a/lib/matplotlib/tests/test_pyplot.py\n+++ b/lib/matplotlib/tests/test_pyplot.py\n@@ -383,3 +383,20 @@ def test_doc_pyplot_summary():\n             f\"The following functions are listed in the pyplot documentation, \"\n             f\"but they do not exist in pyplot. \"\n             f\"Please remove them from doc/api/pyplot_summary.rst: {extra!r}\")\n+\n+\n+def test_get_backend_does_not_clear_figures_from_Gcf_when_using_rc_context():\n+    # Regression test for https://github.com/matplotlib/matplotlib/issues/23407\n+    # When the same backend is already loaded, switch_backend() should not close\n+    # open figures. This is the core fix needed to prevent get_backend() from\n+    # clearing Gcf.figs when figures were created in an rc_context that was\n+    # entered before the backend was resolved (rc_context restores the sentinel\n+    # on exit, then get_backend() triggers switch_backend which would otherwise\n+    # call close(\"all\")).\n+    plt.switch_backend(\"agg\")\n+    fig = plt.figure()\n+    assert len(plt._pylab_helpers.Gcf.get_all_fig_managers()) == 1\n+    # Calling switch_backend with the same backend should NOT close figures.\n+    plt.switch_backend(\"agg\")\n+    assert len(plt._pylab_helpers.Gcf.get_all_fig_managers()) == 1\n+    plt.close(fig)\n"}
{"instance_id": "matplotlib__matplotlib-23314", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex 9db44b7994..5479bc1af0 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -387,6 +387,8 @@ class Axes3D(Axes):\n \n     @martist.allow_rasterization\n     def draw(self, renderer):\n+        if not self.get_visible():\n+            return\n         self._unstale_viewLim()\n \n         # draw the background patch\n"}
{"instance_id": "matplotlib__matplotlib-23476", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/backend_bases.py b/lib/matplotlib/backend_bases.py\nindex 9ae2982c62..48ef6e8728 100644\n--- a/lib/matplotlib/backend_bases.py\n+++ b/lib/matplotlib/backend_bases.py\n@@ -1653,7 +1653,10 @@ class FigureCanvasBase:\n         self.toolbar = None  # NavigationToolbar2 will set me\n         self._is_idle_drawing = False\n         # We don't want to scale up the figure DPI more than once.\n-        figure._original_dpi = figure.dpi\n+        # If the figure already has an _original_dpi set (e.g. after unpickling),\n+        # we must not overwrite it, since figure.dpi may already be scaled.\n+        if not hasattr(figure, '_original_dpi'):\n+            figure._original_dpi = figure.dpi\n         self._device_pixel_ratio = 1\n         super().__init__()  # Typically the GUI widget init (if any).\n \n"}
{"instance_id": "matplotlib__matplotlib-23562", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..000446f32a 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -867,10 +867,12 @@ class Poly3DCollection(PolyCollection):\n         self.stale = True\n \n     def get_facecolor(self):\n-        return self._facecolors2d\n+        return self._facecolors2d if hasattr(self, '_facecolors2d') \\\n+            else self._facecolor3d\n \n     def get_edgecolor(self):\n-        return self._edgecolors2d\n+        return self._edgecolors2d if hasattr(self, '_edgecolors2d') \\\n+            else self._edgecolor3d\n \n \n def poly_collection_2d_to_3d(col, zs=0, zdir='z'):\n"}
{"instance_id": "matplotlib__matplotlib-23563", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..2033aa04f9 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -222,6 +222,7 @@ def line_2d_to_3d(line, zs=0, zdir='z'):\n     \"\"\"Convert a 2D line to 3D.\"\"\"\n \n     line.__class__ = Line3D\n+    line._verts3d = ([], [], [])\n     line.set_3d_properties(zs, zdir)\n \n \n"}
{"instance_id": "matplotlib__matplotlib-23913", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/legend.py b/lib/matplotlib/legend.py\nindex 9e5b903d59..747047c57a 100644\n--- a/lib/matplotlib/legend.py\n+++ b/lib/matplotlib/legend.py\n@@ -286,6 +286,9 @@ handler_map : dict or None\n     The custom dictionary mapping instances or types to a legend\n     handler. This *handler_map* updates the default handler map\n     found at `matplotlib.legend.Legend.get_legend_handler_map`.\n+\n+draggable : bool, default: False\n+    Whether the legend can be dragged with the mouse.\n \"\"\")\n \n \n@@ -342,7 +345,8 @@ class Legend(Artist):\n         title_fontproperties=None,  # properties for the legend title\n         alignment=\"center\",       # control the alignment within the legend box\n         *,\n-        ncol=1  # synonym for ncols (backward compatibility)\n+        ncol=1,  # synonym for ncols (backward compatibility)\n+        draggable=False  # whether the legend can be dragged with the mouse\n     ):\n         \"\"\"\n         Parameters\n@@ -538,6 +542,7 @@ class Legend(Artist):\n \n         self.set_title(title, prop=title_prop_fp)\n         self._draggable = None\n+        self.set_draggable(draggable)\n \n         # set the text color\n \n"}
{"instance_id": "matplotlib__matplotlib-23964", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/backends/backend_ps.py b/lib/matplotlib/backends/backend_ps.py\nindex f209e811f1..bd996b7509 100644\n--- a/lib/matplotlib/backends/backend_ps.py\n+++ b/lib/matplotlib/backends/backend_ps.py\n@@ -666,7 +666,8 @@ grestore\n                     (item.x, item.ft_object.get_glyph_name(item.glyph_idx))\n                 )\n             # append the last entry\n-            stream.append(curr_stream)\n+            if curr_stream:\n+                stream.append(curr_stream)\n \n         self.set_color(*gc.get_rgb())\n \ndiff --git a/lib/matplotlib/tests/test_backend_ps.py b/lib/matplotlib/tests/test_backend_ps.py\nindex fc2556a47d..4361357e4e 100644\n--- a/lib/matplotlib/tests/test_backend_ps.py\n+++ b/lib/matplotlib/tests/test_backend_ps.py\n@@ -256,6 +256,16 @@ def test_linedash():\n     assert buf.tell() > 0\n \n \n+def test_empty_line():\n+    # Regression test for GH#24723 - empty lines in multi-line text caused\n+    # TypeError in PostScript backend.\n+    fig = Figure()\n+    ax = fig.add_subplot(111)\n+    ax.annotate(text='\\nLower label', xy=(0, 0))\n+    buf = io.BytesIO()\n+    fig.savefig(buf, format='eps')  # Should not raise.\n+\n+\n def test_no_duplicate_definition():\n \n     fig = Figure()\n"}
{"instance_id": "matplotlib__matplotlib-23987", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex 5bbb786984..547b1deac7 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -2426,9 +2426,12 @@ class Figure(FigureBase):\n             if isinstance(tight_layout, dict):\n                 self.get_layout_engine().set(**tight_layout)\n         elif constrained_layout is not None:\n-            self.set_layout_engine(layout='constrained')\n-            if isinstance(constrained_layout, dict):\n-                self.get_layout_engine().set(**constrained_layout)\n+            if constrained_layout:\n+                self.set_layout_engine(layout='constrained')\n+                if isinstance(constrained_layout, dict):\n+                    self.get_layout_engine().set(**constrained_layout)\n+            else:\n+                self.set_layout_engine(layout=None)\n         else:\n             # everything is None, so use default:\n             self.set_layout_engine(layout=layout)\n"}
{"instance_id": "matplotlib__matplotlib-24149", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/cbook/__init__.py b/lib/matplotlib/cbook/__init__.py\nindex 34c6ddb861..79fbfb7b1a 100644\n--- a/lib/matplotlib/cbook/__init__.py\n+++ b/lib/matplotlib/cbook/__init__.py\n@@ -1746,7 +1746,10 @@ def _safe_first_finite(obj, *, skip_nonfinite=True):\n         raise RuntimeError(\"matplotlib does not \"\n                            \"support generators as input\")\n     else:\n-        return next(val for val in obj if safe_isfinite(val))\n+        return next(\n+            (val for val in obj if safe_isfinite(val)),\n+            next(iter(obj))  # fallback if no finite values exist\n+        )\n \n \n def sanitize_sequence(data):\n"}
{"instance_id": "matplotlib__matplotlib-24265", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/style/core.py b/lib/matplotlib/style/core.py\nindex fb0a5426e6..b1f70f8535 100644\n--- a/lib/matplotlib/style/core.py\n+++ b/lib/matplotlib/style/core.py\n@@ -251,10 +251,40 @@ library = None\n available = []\n \n \n+class StyleLibrary(dict):\n+    def __getitem__(self, key):\n+        if key in [\n+            \"seaborn\",\n+            \"seaborn-bright\",\n+            \"seaborn-colorblind\",\n+            \"seaborn-dark\",\n+            \"seaborn-darkgrid\",\n+            \"seaborn-dark-palette\",\n+            \"seaborn-deep\",\n+            \"seaborn-muted\",\n+            \"seaborn-notebook\",\n+            \"seaborn-paper\",\n+            \"seaborn-pastel\",\n+            \"seaborn-poster\",\n+            \"seaborn-talk\",\n+            \"seaborn-ticks\",\n+            \"seaborn-white\",\n+            \"seaborn-whitegrid\",\n+        ]:\n+            _api.warn_deprecated(\n+                \"3.6\", message=\"The seaborn styles shipped by Matplotlib \"\n+                \"are deprecated since %(since)s, as they no longer \"\n+                \"correspond to the styles shipped by seaborn. However, \"\n+                \"they will remain available as 'seaborn-v0_8-<style>'. \"\n+                \"Alternatively, directly use the seaborn API instead.\")\n+            key = key.replace(\"seaborn\", \"seaborn-v0_8\")\n+        return super().__getitem__(key)\n+\n+\n def reload_library():\n     \"\"\"Reload the style library.\"\"\"\n     global library\n-    library = update_user_library(_base_library)\n+    library = StyleLibrary(update_user_library(_base_library))\n     available[:] = sorted(library.keys())\n \n \ndiff --git a/lib/matplotlib/tests/test_style.py b/lib/matplotlib/tests/test_style.py\nindex e1388819ff..4f947951ce 100644\n--- a/lib/matplotlib/tests/test_style.py\n+++ b/lib/matplotlib/tests/test_style.py\n@@ -186,5 +186,13 @@ def test_deprecated_seaborn_styles():\n     assert mpl.rcParams == seaborn_bright\n \n \n+def test_deprecated_seaborn_styles_library_access():\n+    # Directly accessing library with deprecated seaborn names should\n+    # emit a deprecation warning and return the same result as the new name.\n+    with pytest.warns(mpl._api.MatplotlibDeprecationWarning):\n+        rc = mpl.style.library[\"seaborn-colorblind\"]\n+    assert rc == mpl.style.library[\"seaborn-v0_8-colorblind\"]\n+\n+\n def test_up_to_date_blacklist():\n     assert mpl.style.core.STYLE_BLACKLIST <= {*mpl.rcsetup._validators}\n"}
{"instance_id": "matplotlib__matplotlib-24334", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex af0815d41d..c6dad1d07b 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -2021,6 +2021,9 @@ class Axis(martist.Artist):\n         other limits, you should set the limits explicitly after setting the\n         ticks.\n         \"\"\"\n+        if kwargs and labels is None:\n+            raise ValueError(\n+                \"Keyword arguments cannot be used without setting 'labels'\")\n         result = self._set_tick_locations(ticks, minor=minor)\n         if labels is not None:\n             self.set_ticklabels(labels, minor=minor, **kwargs)\ndiff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py\nindex 3699c9df13..436ee4d0e0 100644\n--- a/lib/matplotlib/tests/test_axes.py\n+++ b/lib/matplotlib/tests/test_axes.py\n@@ -5754,6 +5754,13 @@ def test_set_ticks_with_labels(fig_test, fig_ref):\n     ax.set_yticks([2, 4], ['A', 'B'], minor=True)\n \n \n+def test_set_ticks_kwargs_raise_if_no_labels():\n+    # Ensure a ValueError is raised if kwargs are passed without labels\n+    fig, ax = plt.subplots()\n+    with pytest.raises(ValueError, match=\"Keyword arguments cannot be used without setting 'labels'\"):\n+        ax.set_xticks([1, 2, 3], fontsize=14)\n+\n+\n def test_set_noniterable_ticklabels():\n     # Ensure a useful TypeError message is raised\n     # when given a non-iterable ticklabels argument\n"}
{"instance_id": "matplotlib__matplotlib-24970", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/colors.py b/lib/matplotlib/colors.py\nindex 2d3072da04..4fc0e792f4 100644\n--- a/lib/matplotlib/colors.py\n+++ b/lib/matplotlib/colors.py\n@@ -724,7 +724,7 @@ class Colormap:\n                 xa[xa == self.N] = self.N - 1\n                 # Avoid converting large positive values to negative integers.\n                 np.clip(xa, -1, self.N, out=xa)\n-                xa = xa.astype(int)\n+        xa = xa.astype(int)\n         # Set the over-range indices before the under-range;\n         # otherwise the under-range values get converted to over-range.\n         xa[xa > self.N - 1] = self._i_over\n"}
{"instance_id": "matplotlib__matplotlib-25079", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/colorbar.py b/lib/matplotlib/colorbar.py\nindex 966eb0760b..97aa78c34a 100644\n--- a/lib/matplotlib/colorbar.py\n+++ b/lib/matplotlib/colorbar.py\n@@ -1102,13 +1102,16 @@ class Colorbar:\n \n         # transform from 0-1 to vmin-vmax:\n         if not self.norm.scaled():\n-            self.norm.vmin = 0\n-            self.norm.vmax = 1\n-        self.norm.vmin, self.norm.vmax = mtransforms.nonsingular(\n-            self.norm.vmin, self.norm.vmax, expander=0.1)\n+            vmin = 0\n+            vmax = 1\n+        else:\n+            vmin, vmax = self.norm.vmin, self.norm.vmax\n+        vmin, vmax = mtransforms.nonsingular(vmin, vmax, expander=0.1)\n         if (not isinstance(self.norm, colors.BoundaryNorm) and\n                 (self.boundaries is None)):\n-            b = self.norm.inverse(b)\n+            with self.norm.callbacks.blocked(), \\\n+                    cbook._setattr_cm(self.norm, vmin=vmin, vmax=vmax):\n+                b = self.norm.inverse(b)\n \n         self._boundaries = np.asarray(b, dtype=float)\n         self._values = 0.5 * (self._boundaries[:-1] + self._boundaries[1:])\ndiff --git a/lib/matplotlib/colors.py b/lib/matplotlib/colors.py\nindex f9e4dcbd62..1c6cacdff8 100644\n--- a/lib/matplotlib/colors.py\n+++ b/lib/matplotlib/colors.py\n@@ -1362,8 +1362,10 @@ class Normalize:\n \n     def autoscale(self, A):\n         \"\"\"Set *vmin*, *vmax* to min, max of *A*.\"\"\"\n-        self.vmin = self.vmax = None\n-        self.autoscale_None(A)\n+        with self.callbacks.blocked():\n+            self.vmin = self.vmax = None\n+            self.autoscale_None(A)\n+        self._changed()\n \n     def autoscale_None(self, A):\n         \"\"\"If vmin or vmax are not set, use the min/max of *A* to set them.\"\"\"\n"}
{"instance_id": "matplotlib__matplotlib-25311", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex 1dee8a23d9..5fe913d101 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1580,6 +1580,35 @@ class DraggableBase:\n     def finalize_offset(self):\n         pass\n \n+    def __getstate__(self):\n+        state = self.__dict__.copy()\n+        # The canvas cannot be pickled (it references the GUI backend), but\n+        # it can be reconstructed from the ref_artist's figure when needed.\n+        state.pop(\"canvas\")\n+        return state\n+\n+    def __setstate__(self, state):\n+        self.__dict__ = state\n+        # canvas will be reconnected the first time it is accessed via\n+        # __getattr__, at which point the figure will be fully restored.\n+\n+    def __getattr__(self, name):\n+        if name == \"canvas\":\n+            # This is called when canvas is not in __dict__ (i.e. after\n+            # unpickling).  Re-connect to the figure's current canvas and\n+            # re-register the event callbacks.\n+            canvas = self.ref_artist.figure.canvas\n+            self.canvas = canvas\n+            self.cids = [\n+                canvas.callbacks._connect_picklable(\n+                    'pick_event', self.on_pick),\n+                canvas.callbacks._connect_picklable(\n+                    'button_release_event', self.on_release),\n+            ]\n+            return canvas\n+        raise AttributeError(f\"{type(self).__name__!r} object has no \"\n+                             f\"attribute {name!r}\")\n+\n \n class DraggableOffsetBox(DraggableBase):\n     def __init__(self, ref_artist, offsetbox, use_blit=False):\ndiff --git a/lib/matplotlib/tests/test_pickle.py b/lib/matplotlib/tests/test_pickle.py\nindex ec6bdcc2fe..663b18db71 100644\n--- a/lib/matplotlib/tests/test_pickle.py\n+++ b/lib/matplotlib/tests/test_pickle.py\n@@ -282,3 +282,18 @@ def test_dynamic_norm():\n def test_vertexselector():\n     line, = plt.plot([0, 1], picker=True)\n     pickle.loads(pickle.dumps(VertexSelector(line)))\n+\n+\n+def test_draggable_legend():\n+    fig, ax = plt.subplots()\n+    ax.plot([1, 2, 3], label=\"test\")\n+    leg = ax.legend()\n+    leg.set_draggable(True)\n+    pickle.loads(pickle.dumps(fig))\n+\n+\n+def test_draggable_annotation():\n+    fig, ax = plt.subplots()\n+    ann = ax.annotate(\"test\", xy=(0.5, 0.5))\n+    ann.draggable(True)\n+    pickle.loads(pickle.dumps(fig))\n"}
{"instance_id": "matplotlib__matplotlib-25332", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/cbook.py b/lib/matplotlib/cbook.py\nindex c9699b2e21..943f28e183 100644\n--- a/lib/matplotlib/cbook.py\n+++ b/lib/matplotlib/cbook.py\n@@ -788,6 +788,15 @@ class Grouper:\n     def __init__(self, init=()):\n         self._mapping = {weakref.ref(x): [weakref.ref(x)] for x in init}\n \n+    def __getstate__(self):\n+        return list(self)\n+\n+    def __setstate__(self, state):\n+        self._mapping = {}\n+        for group in state:\n+            if group:\n+                self.join(group[0], *group[1:])\n+\n     def __contains__(self, item):\n         return weakref.ref(item) in self._mapping\n \ndiff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\nindex 80d80f9691..edfb1425cf 100644\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1534,6 +1534,17 @@ def test_deepcopy():\n     assert fig2.axes[0].get_xlim() == (0, 1)\n \n \n+def test_pickle_with_aligned_labels():\n+    fig = plt.figure()\n+    ax1 = fig.add_subplot(211)\n+    ax2 = fig.add_subplot(212)\n+    ax1.set_ylabel('ylabel')\n+    ax2.set_ylabel('ylabel')\n+    fig.align_labels()\n+    fig2 = pickle.loads(pickle.dumps(fig))\n+    assert len(fig2.axes) == 2\n+\n+\n def test_unpickle_with_device_pixel_ratio():\n     fig = Figure(dpi=42)\n     fig.canvas._set_device_pixel_ratio(7)\n"}
{"instance_id": "matplotlib__matplotlib-25433", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex d2568fddbf..5ffeadb8a6 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -3104,6 +3104,7 @@ None}, default: None\n         toolbar = self.canvas.toolbar\n         if toolbar is not None:\n             toolbar.update()\n+        self.canvas.mouse_grabber = None\n \n     @_finalize_rasterization\n     @allow_rasterization\ndiff --git a/lib/matplotlib/tests/test_widgets.py b/lib/matplotlib/tests/test_widgets.py\nindex 5706df46e3..51a8d38bfc 100644\n--- a/lib/matplotlib/tests/test_widgets.py\n+++ b/lib/matplotlib/tests/test_widgets.py\n@@ -1334,6 +1334,35 @@ def test_range_slider_same_init_values(orientation):\n     assert_allclose(box.get_points().flatten()[idx], [0, 0.25, 0, 0.75])\n \n \n+def test_range_slider_on_changed_callback_with_clf():\n+    # Test that clf() in on_changed callback properly releases canvas\n+    # mouse_grabber (GH#26623)\n+    from matplotlib.testing.widgets import mock_event\n+    fig, ax = plt.subplots()\n+    slider = widgets.RangeSlider(ax=ax, label=\"\", valmin=0, valmax=10,\n+                                 valinit=(1, 9))\n+\n+    def on_changed(val):\n+        fig.clear()\n+\n+    slider.on_changed(on_changed)\n+\n+    # Simulate a press to start drag\n+    press_event = mock_event(ax, button=1, xdata=5, ydata=0.5)\n+    press_event.name = 'button_press_event'\n+    slider._update(press_event)\n+    assert slider.drag_active\n+    assert ax.figure.canvas.mouse_grabber is ax\n+\n+    # Simulate motion that triggers on_changed which calls clf()\n+    move_event = mock_event(ax, button=1, xdata=6, ydata=0.5)\n+    move_event.name = 'motion_notify_event'\n+    slider._update(move_event)\n+\n+    # After clf(), mouse_grabber must be reset to None so new widgets work\n+    assert fig.canvas.mouse_grabber is None\n+\n+\n def check_polygon_selector(event_sequence, expected_result, selections_count,\n                            **kwargs):\n     \"\"\"\n"}
{"instance_id": "matplotlib__matplotlib-25442", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex 77768e7383..1b505ad77d 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1558,14 +1558,18 @@ class DraggableBase:\n \n     def disconnect(self):\n         \"\"\"Disconnect the callbacks.\"\"\"\n+        try:\n+            canvas = self.canvas\n+        except AttributeError:\n+            return\n         for cid in self.cids:\n-            self.canvas.mpl_disconnect(cid)\n+            canvas.mpl_disconnect(cid)\n         try:\n             c1 = self._c1\n         except AttributeError:\n             pass\n         else:\n-            self.canvas.mpl_disconnect(c1)\n+            canvas.mpl_disconnect(c1)\n \n     def save_offset(self):\n         pass\n"}
{"instance_id": "matplotlib__matplotlib-25498", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/colorbar.py b/lib/matplotlib/colorbar.py\nindex d3d53e3d98..fbd1beeac8 100644\n--- a/lib/matplotlib/colorbar.py\n+++ b/lib/matplotlib/colorbar.py\n@@ -511,6 +511,8 @@ class Colorbar:\n             self.norm = mappable.norm\n             self._reset_locator_formatter_scale()\n \n+        if mappable.get_array() is not None:\n+            mappable.autoscale_None()\n         self._draw_all()\n         if isinstance(self.mappable, contour.ContourSet):\n             CS = self.mappable\n"}
{"instance_id": "matplotlib__matplotlib-26011", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/matplotlib/axis.py b/lib/matplotlib/axis.py\nindex e6e7e29f11..f2abb72a2d 100644\n--- a/lib/matplotlib/axis.py\n+++ b/lib/matplotlib/axis.py\n@@ -1244,6 +1244,7 @@ class Axis(martist.Artist):\n                 if other is not self.axes:\n                     other._axis_map[name]._set_lim(\n                         v0, v1, emit=False, auto=auto)\n+                    other.callbacks.process(f\"{name}lim_changed\", other)\n                     if other.figure != self.figure:\n                         other.figure.canvas.draw_idle()\n \n"}
{"instance_id": "matplotlib__matplotlib-26020", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/lib/mpl_toolkits/axes_grid1/axes_grid.py b/lib/mpl_toolkits/axes_grid1/axes_grid.py\nindex 2b1b1d3200..830554edbb 100644\n--- a/lib/mpl_toolkits/axes_grid1/axes_grid.py\n+++ b/lib/mpl_toolkits/axes_grid1/axes_grid.py\n@@ -13,8 +13,13 @@ from .mpl_axes import Axes\n def _tick_only(ax, bottom_on, left_on):\n     bottom_off = not bottom_on\n     left_off = not left_on\n-    ax.axis[\"bottom\"].toggle(ticklabels=bottom_off, label=bottom_off)\n-    ax.axis[\"left\"].toggle(ticklabels=left_off, label=left_off)\n+    if hasattr(ax.axis, \"__getitem__\"):\n+        ax.axis[\"bottom\"].toggle(ticklabels=bottom_off, label=bottom_off)\n+        ax.axis[\"left\"].toggle(ticklabels=left_off, label=left_off)\n+    else:\n+        ax.tick_params(labelbottom=bottom_off, labelleft=left_off)\n+        ax.xaxis.label.set_visible(bottom_off)\n+        ax.yaxis.label.set_visible(left_off)\n \n \n class CbarAxesBase:\ndiff --git a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\nindex d1554020cd..2fd60dd8e3 100644\n--- a/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n+++ b/lib/mpl_toolkits/axes_grid1/tests/test_axes_grid1.py\n@@ -592,6 +592,17 @@ def test_axes_class_tuple():\n     gr = AxesGrid(fig, 111, nrows_ncols=(1, 1), axes_class=axes_class)\n \n \n+def test_axes_class_non_default():\n+    # Test that AxesGrid works with a non-default axes class whose .axis\n+    # attribute is a callable (method) rather than a subscriptable AxisDict.\n+    # Regression test for https://github.com/matplotlib/matplotlib/issues/XXXXX\n+    import matplotlib.axes\n+    fig = plt.figure()\n+    axes_class = (matplotlib.axes.Axes, {})\n+    # This should not raise \"TypeError: 'method' object is not subscriptable\"\n+    gr = AxesGrid(fig, 111, nrows_ncols=(2, 2), axes_class=axes_class)\n+\n+\n def test_grid_axes_lists():\n     \"\"\"Test Grid axes_all, axes_row and axes_column relationship.\"\"\"\n     fig = plt.figure()\n"}
{"instance_id": "mwaskom__seaborn-2848", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/seaborn/_oldcore.py b/seaborn/_oldcore.py\nindex c9218c1f..45c33859 100644\n--- a/seaborn/_oldcore.py\n+++ b/seaborn/_oldcore.py\n@@ -151,17 +151,23 @@ class HueMapping(SemanticMapping):\n         except KeyError:\n             # Use the colormap to interpolate between existing datapoints\n             # (e.g. in the context of making a continuous legend)\n-            try:\n-                normed = self.norm(key)\n-            except TypeError as err:\n-                if np.isnan(key):\n-                    value = (0, 0, 0, 0)\n-                else:\n-                    raise err\n+            if self.norm is None:\n+                # No norm means we have a categorical mapping; a key that is\n+                # not in the lookup table (e.g. excluded by hue_order) should\n+                # be drawn as transparent.\n+                value = (0, 0, 0, 0)\n             else:\n-                if np.ma.is_masked(normed):\n-                    normed = np.nan\n-                value = self.cmap(normed)\n+                try:\n+                    normed = self.norm(key)\n+                except TypeError as err:\n+                    if np.isnan(key):\n+                        value = (0, 0, 0, 0)\n+                    else:\n+                        raise err\n+                else:\n+                    if np.ma.is_masked(normed):\n+                        normed = np.nan\n+                    value = self.cmap(normed)\n         return value\n \n     def infer_map_type(self, palette, norm, input_format, var_type):\ndiff --git a/tests/test_axisgrid.py b/tests/test_axisgrid.py\nindex 40d591f1..65ec0053 100644\n--- a/tests/test_axisgrid.py\n+++ b/tests/test_axisgrid.py\n@@ -1280,6 +1280,19 @@ class TestPairGrid:\n         for ax in g.diag_axes:\n             assert len(ax.collections) == n\n \n+    def test_pairplot_hue_order_with_missing_levels(self):\n+\n+        # Test that pairplot works when hue_order doesn't include all hue values\n+        # (regression test for GH issue - partial hue_order should not raise TypeError)\n+        hue_levels = list(self.df[\"a\"].unique())\n+        hue_order = hue_levels[:-1]  # Exclude the last level\n+\n+        # Should not raise an error\n+        g = ag.pairplot(self.df, hue=\"a\", hue_order=hue_order)\n+        assert len(g.hue_names) == len(hue_order)\n+\n+        plt.close(\"all\")\n+\n     def test_pairplot_reg(self):\n \n         vars = [\"x\", \"y\", \"z\"]\ndiff --git a/tests/test_core.py b/tests/test_core.py\nindex a64d0637..9ba27a6c 100644\n--- a/tests/test_core.py\n+++ b/tests/test_core.py\n@@ -177,6 +177,13 @@ class TestHueMapping:\n         m = HueMapping(p)\n         assert m(np.nan) == (0, 0, 0, 0)\n \n+        # Test value not in hue_order (excluded level) returns transparent\n+        p = VectorPlotter(data=long_df, variables=dict(x=\"x\", y=\"y\", hue=\"a\"))\n+        hue_order = categorical_order(long_df[\"a\"])[:-1]  # Exclude the last level\n+        m = HueMapping(p, order=hue_order)\n+        excluded_level = categorical_order(long_df[\"a\"])[-1]\n+        assert m(excluded_level) == (0, 0, 0, 0)\n+\n         # Test default palette with many levels\n         x = y = np.arange(26)\n         hue = pd.Series(list(\"abcdefghijklmnopqrstuvwxyz\"))\n"}
{"instance_id": "mwaskom__seaborn-3010", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/seaborn/_stats/regression.py b/seaborn/_stats/regression.py\nindex 7b7ddc8d..7b10679c 100644\n--- a/seaborn/_stats/regression.py\n+++ b/seaborn/_stats/regression.py\n@@ -23,6 +23,10 @@ class PolyFit(Stat):\n \n         x = data[\"x\"]\n         y = data[\"y\"]\n+        if x.isna().any() or y.isna().any():\n+            data = data.dropna(subset=[\"x\", \"y\"])\n+            x = data[\"x\"]\n+            y = data[\"y\"]\n         if x.nunique() <= self.order:\n             # TODO warn?\n             xx = yy = []\n"}
{"instance_id": "mwaskom__seaborn-3190", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/seaborn/_core/scales.py b/seaborn/_core/scales.py\nindex 6c9ecbc9..13461c96 100644\n--- a/seaborn/_core/scales.py\n+++ b/seaborn/_core/scales.py\n@@ -346,6 +346,7 @@ class ContinuousBase(Scale):\n                 vmin, vmax = data.min(), data.max()\n             else:\n                 vmin, vmax = new.norm\n+            vmin, vmax = float(vmin), float(vmax)\n             vmin, vmax = axis.convert_units((vmin, vmax))\n             a = forward(vmin)\n             b = forward(vmax) - forward(vmin)\n"}
{"instance_id": "mwaskom__seaborn-3407", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/seaborn/axisgrid.py b/seaborn/axisgrid.py\nindex 75349099..857f4315 100644\n--- a/seaborn/axisgrid.py\n+++ b/seaborn/axisgrid.py\n@@ -1472,7 +1472,7 @@ class PairGrid(Grid):\n                 for ax in diag_axes[1:]:\n                     share_axis(diag_axes[0], ax, \"y\")\n \n-            self.diag_vars = np.array(diag_vars, np.object_)\n+            self.diag_vars = diag_vars\n             self.diag_axes = np.array(diag_axes, np.object_)\n \n         if \"hue\" not in signature(func).parameters:\n"}
{"instance_id": "psf__requests-1963", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 425db22c..6fb2b1ad 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -86,10 +86,9 @@ class SessionRedirectMixin(object):\n         \"\"\"Receives a Response. Returns a generator of Responses.\"\"\"\n \n         i = 0\n+        prepared_request = req.copy()\n \n         while resp.is_redirect:\n-            prepared_request = req.copy()\n-\n             resp.content  # Consume socket so it can be released\n \n             if i >= self.max_redirects:\n@@ -99,7 +98,7 @@ class SessionRedirectMixin(object):\n             resp.close()\n \n             url = resp.headers['location']\n-            method = req.method\n+            method = prepared_request.method\n \n             # Handle redirection without scheme (see: RFC 1808 Section 4)\n             if url.startswith('//'):\n"}
{"instance_id": "psf__requests-2148", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex 0dc55568..2ababaf8 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -9,6 +9,7 @@ This module contains the primary objects that power Requests.\n \n import collections\n import datetime\n+import socket\n \n from io import BytesIO, UnsupportedOperation\n from .hooks import default_hooks\n@@ -22,7 +23,7 @@ from .packages.urllib3.util import parse_url\n from .packages.urllib3.exceptions import DecodeError\n from .exceptions import (\n     HTTPError, RequestException, MissingSchema, InvalidURL,\n-    ChunkedEncodingError, ContentDecodingError)\n+    ChunkedEncodingError, ContentDecodingError, ConnectionError)\n from .utils import (\n     guess_filename, get_auth_from_url, requote_uri,\n     stream_decode_response_unicode, to_key_val_list, parse_header_links,\n@@ -640,6 +641,8 @@ class Response(object):\n                     raise ChunkedEncodingError(e)\n                 except DecodeError as e:\n                     raise ContentDecodingError(e)\n+                except socket.error as e:\n+                    raise ConnectionError(e)\n             except AttributeError:\n                 # Standard file-like object.\n                 while True:\n"}
{"instance_id": "psf__requests-2317", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex 3f6a4f92..06142646 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -329,7 +329,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         \"\"\"Prepares the given HTTP method.\"\"\"\n         self.method = method\n         if self.method is not None:\n-            self.method = self.method.upper()\n+            self.method = to_native_string(self.method.upper())\n \n     def prepare_url(self, url, params):\n         \"\"\"Prepares the given HTTP URL.\"\"\"\n"}
{"instance_id": "psf__requests-2674", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/adapters.py b/requests/adapters.py\nindex 841cbbfe..41c53eee 100644\n--- a/requests/adapters.py\n+++ b/requests/adapters.py\n@@ -27,9 +27,11 @@ from .packages.urllib3.exceptions import ProtocolError\n from .packages.urllib3.exceptions import ReadTimeoutError\n from .packages.urllib3.exceptions import SSLError as _SSLError\n from .packages.urllib3.exceptions import ResponseError\n+from .packages.urllib3.exceptions import DecodeError as _DecodeError\n+from .packages.urllib3.exceptions import TimeoutError as _TimeoutError\n from .cookies import extract_cookies_to_jar\n from .exceptions import (ConnectionError, ConnectTimeout, ReadTimeout, SSLError,\n-                         ProxyError, RetryError)\n+                         ProxyError, RetryError, ContentDecodingError, Timeout)\n from .auth import _basic_auth_str\n \n DEFAULT_POOLBLOCK = False\n@@ -429,6 +431,10 @@ class HTTPAdapter(BaseAdapter):\n                 raise SSLError(e, request=request)\n             elif isinstance(e, ReadTimeoutError):\n                 raise ReadTimeout(e, request=request)\n+            elif isinstance(e, _DecodeError):\n+                raise ContentDecodingError(e, request=request)\n+            elif isinstance(e, _TimeoutError):\n+                raise Timeout(e, request=request)\n             else:\n                 raise\n \n"}
{"instance_id": "psf__requests-3362", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/utils.py b/requests/utils.py\nindex 8d17b6b2..99f8655b 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -360,9 +360,7 @@ def stream_decode_response_unicode(iterator, r):\n     \"\"\"Stream decodes a iterator.\"\"\"\n \n     if r.encoding is None:\n-        for item in iterator:\n-            yield item\n-        return\n+        r.encoding = r.apparent_encoding\n \n     decoder = codecs.getincrementaldecoder(r.encoding)(errors='replace')\n     for chunk in iterator:\n"}
{"instance_id": "psf__requests-863", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex d8456375..404b4bf5 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -463,7 +463,10 @@ class Request(object):\n     def register_hook(self, event, hook):\n         \"\"\"Properly register a hook.\"\"\"\n \n-        self.hooks[event].append(hook)\n+        if isinstance(hook, list):\n+            self.hooks[event].extend(hook)\n+        else:\n+            self.hooks[event].append(hook)\n \n     def deregister_hook(self, event, hook):\n         \"\"\"Deregister a previously registered hook.\n"}
{"instance_id": "pylint-dev__pylint-5859", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/checkers/misc.py b/pylint/checkers/misc.py\nindex 69149e61a..d22191d31 100644\n--- a/pylint/checkers/misc.py\n+++ b/pylint/checkers/misc.py\n@@ -119,11 +119,14 @@ class EncodingChecker(BaseChecker):\n     def open(self):\n         super().open()\n \n-        notes = \"|\".join(re.escape(note) for note in self.config.notes)\n+        notes = \"|\".join(\n+            re.escape(note) + (r\"\\b\" if note[-1].isalnum() or note[-1] == \"_\" else \"\")\n+            for note in self.config.notes\n+        )\n         if self.config.notes_rgx:\n             regex_string = rf\"#\\s*({notes}|{self.config.notes_rgx})\\b\"\n         else:\n-            regex_string = rf\"#\\s*({notes})\\b\"\n+            regex_string = rf\"#\\s*({notes})\"\n \n         self._fixme_pattern = re.compile(regex_string, re.I)\n \ndiff --git a/tests/checkers/unittest_misc.py b/tests/checkers/unittest_misc.py\nindex 23e19a9d0..53e38ccc0 100644\n--- a/tests/checkers/unittest_misc.py\n+++ b/tests/checkers/unittest_misc.py\n@@ -106,6 +106,28 @@ class TestFixme(CheckerTestCase):\n         ):\n             self.checker.process_tokens(_tokenize_str(code))\n \n+    @set_config(notes=[\"???\"])\n+    def test_fixme_with_punctuation_note(self) -> None:\n+        code = \"\"\"a = 1\n+                # ???: yes\n+                \"\"\"\n+        with self.assertAddsMessages(\n+            MessageTest(msg_id=\"fixme\", line=2, args=\"???: yes\", col_offset=17)\n+        ):\n+            self.checker.process_tokens(_tokenize_str(code))\n+\n+    @set_config(notes=[\"???\", \"YES\"])\n+    def test_fixme_with_mixed_notes(self) -> None:\n+        code = \"\"\"a = 1\n+                # YES: yes\n+                # ???: no\n+                \"\"\"\n+        with self.assertAddsMessages(\n+            MessageTest(msg_id=\"fixme\", line=2, args=\"YES: yes\", col_offset=17),\n+            MessageTest(msg_id=\"fixme\", line=3, args=\"???: no\", col_offset=17),\n+        ):\n+            self.checker.process_tokens(_tokenize_str(code))\n+\n     def test_dont_trigger_on_todoist(self) -> None:\n         code = \"\"\"\n         # Todoist API: What is this task about?\n"}
{"instance_id": "pylint-dev__pylint-6506", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/config/config_initialization.py b/pylint/config/config_initialization.py\nindex 24e453a73..c6e0a6f6f 100644\n--- a/pylint/config/config_initialization.py\n+++ b/pylint/config/config_initialization.py\n@@ -82,7 +82,7 @@ def _config_initialization(\n     if unrecognized_options:\n         msg = \", \".join(unrecognized_options)\n         linter.add_message(\"unrecognized-option\", line=0, args=msg)\n-        raise _UnrecognizedOptionError(options=unrecognized_options)\n+        sys.exit(32)\n \n     # Set the current module to configuration as we don't know where\n     # the --load-plugins key is coming from\n"}
{"instance_id": "pylint-dev__pylint-7080", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/lint/expand_modules.py b/pylint/lint/expand_modules.py\nindex 5cacc0371..53e5298e6 100644\n--- a/pylint/lint/expand_modules.py\n+++ b/pylint/lint/expand_modules.py\n@@ -57,6 +57,7 @@ def _is_ignored_file(\n         basename in ignore_list\n         or _is_in_ignore_list_re(basename, ignore_list_re)\n         or _is_in_ignore_list_re(element, ignore_list_paths_re)\n+        or _is_in_ignore_list_re(element + os.sep, ignore_list_paths_re)\n     )\n \n \ndiff --git a/tests/lint/unittest_expand_modules.py b/tests/lint/unittest_expand_modules.py\nindex 15f72d0c5..051fd9327 100644\n--- a/tests/lint/unittest_expand_modules.py\n+++ b/tests/lint/unittest_expand_modules.py\n@@ -136,9 +136,7 @@ class TestExpandModules(CheckerTestCase):\n             ([__file__], []),\n             (\n                 [str(Path(__file__).parent)],\n-                [\n-                    init_of_package,\n-                ],\n+                [],\n             ),\n         ],\n     )\n"}
{"instance_id": "pylint-dev__pylint-7114", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/lint/expand_modules.py b/pylint/lint/expand_modules.py\nindex 289e1afce..3217c86cc 100644\n--- a/pylint/lint/expand_modules.py\n+++ b/pylint/lint/expand_modules.py\n@@ -30,8 +30,7 @@ def get_python_path(filepath: str) -> str:\n     This is not true since python 3.3 and is causing problem.\n     \"\"\"\n     dirname = os.path.realpath(os.path.expanduser(filepath))\n-    if not os.path.isdir(dirname):\n-        dirname = os.path.dirname(dirname)\n+    dirname = os.path.dirname(dirname)\n     while True:\n         if not os.path.exists(os.path.join(dirname, \"__init__.py\")):\n             return dirname\ndiff --git a/tests/lint/unittest_expand_modules.py b/tests/lint/unittest_expand_modules.py\nindex 15f72d0c5..83c4006d5 100644\n--- a/tests/lint/unittest_expand_modules.py\n+++ b/tests/lint/unittest_expand_modules.py\n@@ -4,13 +4,14 @@\n \n from __future__ import annotations\n \n+import os\n import re\n from pathlib import Path\n \n import pytest\n \n from pylint.checkers import BaseChecker\n-from pylint.lint.expand_modules import _is_in_ignore_list_re, expand_modules\n+from pylint.lint.expand_modules import _is_in_ignore_list_re, expand_modules, get_python_path\n from pylint.testutils import CheckerTestCase, set_config\n from pylint.typing import MessageDefinitionTuple\n \n@@ -155,3 +156,43 @@ class TestExpandModules(CheckerTestCase):\n         modules.sort(key=lambda d: d[\"name\"])\n         assert modules == expected\n         assert not errors\n+\n+\n+def test_expand_modules_namespace_package() -> None:\n+    \"\"\"Test that linting a namespace package (no __init__.py) works when a submodule\n+    has the same name as the package directory.\n+\n+    Regression test for https://github.com/PyCQA/pylint/issues/5928\n+    \"\"\"\n+    namespace_pkg_dir = str(\n+        Path(__file__).parent.parent\n+        / \"regrtest_data\"\n+        / \"namespace_package\"\n+        / \"sub_namespace\"\n+    )\n+    modules, errors = expand_modules([namespace_pkg_dir], [], [], [])\n+    assert not errors\n+    assert not any(m[\"path\"].endswith(\"__init__.py\") for m in modules)\n+    module_paths = {m[\"path\"] for m in modules}\n+    assert any(os.path.basename(p) == \"sub_namespace.py\" for p in module_paths)\n+    assert any(os.path.basename(p) == \"other.py\" for p in module_paths)\n+\n+\n+def test_get_python_path() -> None:\n+    \"\"\"Test that get_python_path returns the parent directory for both files\n+    and directories, so that modules can be correctly imported from that path.\n+    \"\"\"\n+    # For a directory, get_python_path should return its parent (or an ancestor\n+    # without __init__.py), not the directory itself.\n+    namespace_pkg_dir = str(\n+        Path(__file__).parent.parent\n+        / \"regrtest_data\"\n+        / \"namespace_package\"\n+        / \"sub_namespace\"\n+    )\n+    python_path = get_python_path(namespace_pkg_dir)\n+    # The returned path should NOT be the sub_namespace directory itself,\n+    # because that would cause sub_namespace/sub_namespace.py to be found\n+    # as module \"sub_namespace\" instead of the namespace package.\n+    assert python_path != namespace_pkg_dir\n+    assert not python_path.endswith(\"sub_namespace\")\n"}
{"instance_id": "pylint-dev__pylint-7228", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/config/argument.py b/pylint/config/argument.py\nindex 3c2951517..cd9cc85d8 100644\n--- a/pylint/config/argument.py\n+++ b/pylint/config/argument.py\n@@ -17,6 +17,11 @@ import sys\n from collections.abc import Callable\n from typing import Any, Pattern, Sequence, Tuple, Union\n \n+try:\n+    import regex\n+except ImportError:\n+    regex = None  # type: ignore[assignment]\n+\n from pylint import interfaces\n from pylint import utils as pylint_utils\n from pylint.config.callback_actions import _CallbackAction, _ExtendAction\n@@ -99,11 +104,29 @@ def _py_version_transformer(value: str) -> tuple[int, ...]:\n     return version\n \n \n+def _regexp_transformer(value: str) -> Pattern[str]:\n+    \"\"\"Compile a regular expression.\n+\n+    Tries the standard ``re`` module first. If that fails and the ``regex``\n+    module is installed, retries with ``regex`` which supports additional\n+    features like Unicode property escapes (e.g. ``\\\\p{Han}``).\n+    \"\"\"\n+    try:\n+        return re.compile(value)\n+    except re.error as e:\n+        if regex is not None:\n+            return regex.compile(value)\n+        raise argparse.ArgumentTypeError(\n+            f\"Error in provided regular expression: {value} beginning at \"\n+            f\"index {e.pos}: {e.msg}\"\n+        ) from e\n+\n+\n def _regexp_csv_transfomer(value: str) -> Sequence[Pattern[str]]:\n     \"\"\"Transforms a comma separated list of regular expressions.\"\"\"\n     patterns: list[Pattern[str]] = []\n     for pattern in _csv_transformer(value):\n-        patterns.append(re.compile(pattern))\n+        patterns.append(_regexp_transformer(pattern))\n     return patterns\n \n \n@@ -111,13 +134,28 @@ def _regexp_paths_csv_transfomer(value: str) -> Sequence[Pattern[str]]:\n     \"\"\"Transforms a comma separated list of regular expressions paths.\"\"\"\n     patterns: list[Pattern[str]] = []\n     for pattern in _csv_transformer(value):\n-        patterns.append(\n-            re.compile(\n-                str(pathlib.PureWindowsPath(pattern)).replace(\"\\\\\", \"\\\\\\\\\")\n-                + \"|\"\n-                + pathlib.PureWindowsPath(pattern).as_posix()\n+        try:\n+            patterns.append(\n+                re.compile(\n+                    str(pathlib.PureWindowsPath(pattern)).replace(\"\\\\\", \"\\\\\\\\\")\n+                    + \"|\"\n+                    + pathlib.PureWindowsPath(pattern).as_posix()\n+                )\n             )\n-        )\n+        except re.error as e:\n+            if regex is not None:\n+                patterns.append(\n+                    regex.compile(\n+                        str(pathlib.PureWindowsPath(pattern)).replace(\"\\\\\", \"\\\\\\\\\")\n+                        + \"|\"\n+                        + pathlib.PureWindowsPath(pattern).as_posix()\n+                    )\n+                )\n+            else:\n+                raise argparse.ArgumentTypeError(\n+                    f\"Error in provided regular expression: {pattern} beginning at \"\n+                    f\"index {e.pos}: {e.msg}\"\n+                ) from e\n     return patterns\n \n \n@@ -130,7 +168,7 @@ _TYPE_TRANSFORMERS: dict[str, Callable[[str], _ArgumentTypes]] = {\n     \"non_empty_string\": _non_empty_string_transformer,\n     \"path\": _path_transformer,\n     \"py_version\": _py_version_transformer,\n-    \"regexp\": re.compile,\n+    \"regexp\": _regexp_transformer,\n     \"regexp_csv\": _regexp_csv_transfomer,\n     \"regexp_paths_csv\": _regexp_paths_csv_transfomer,\n     \"string\": pylint_utils._unquote,\ndiff --git a/pylint/config/option.py b/pylint/config/option.py\nindex 5043fe765..cfffee6d5 100644\n--- a/pylint/config/option.py\n+++ b/pylint/config/option.py\n@@ -11,6 +11,11 @@ import re\n import warnings\n from re import Pattern\n \n+try:\n+    import regex\n+except ImportError:\n+    regex = None  # type: ignore[assignment]\n+\n from pylint import utils\n \n \n@@ -23,7 +28,12 @@ def _csv_validator(_, name, value):\n def _regexp_validator(_, name, value):\n     if hasattr(value, \"pattern\"):\n         return value\n-    return re.compile(value)\n+    try:\n+        return re.compile(value)\n+    except re.error:\n+        if regex is not None:\n+            return regex.compile(value)\n+        raise\n \n \n # pylint: disable=unused-argument\n@@ -38,13 +48,25 @@ def _regexp_paths_csv_validator(\n         return value\n     patterns = []\n     for val in _csv_validator(_, name, value):\n-        patterns.append(\n-            re.compile(\n-                str(pathlib.PureWindowsPath(val)).replace(\"\\\\\", \"\\\\\\\\\")\n-                + \"|\"\n-                + pathlib.PureWindowsPath(val).as_posix()\n+        try:\n+            patterns.append(\n+                re.compile(\n+                    str(pathlib.PureWindowsPath(val)).replace(\"\\\\\", \"\\\\\\\\\")\n+                    + \"|\"\n+                    + pathlib.PureWindowsPath(val).as_posix()\n+                )\n             )\n-        )\n+        except re.error:\n+            if regex is not None:\n+                patterns.append(\n+                    regex.compile(\n+                        str(pathlib.PureWindowsPath(val)).replace(\"\\\\\", \"\\\\\\\\\")\n+                        + \"|\"\n+                        + pathlib.PureWindowsPath(val).as_posix()\n+                    )\n+                )\n+            else:\n+                raise\n     return patterns\n \n \n"}
{"instance_id": "pylint-dev__pylint-7993", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/pylint/reporters/text.py b/pylint/reporters/text.py\nindex 29bd46798..059c3c853 100644\n--- a/pylint/reporters/text.py\n+++ b/pylint/reporters/text.py\n@@ -175,14 +175,16 @@ class TextReporter(BaseReporter):\n         self._template = template\n \n         # Check to see if all parameters in the template are attributes of the Message\n-        arguments = re.findall(r\"\\{(.+?)(:.*)?\\}\", template)\n+        arguments = re.findall(r\"\\{(\\w+?)(:.*)?\\}\", template)\n         for argument in arguments:\n             if argument[0] not in MESSAGE_FIELDS:\n                 warnings.warn(\n                     f\"Don't recognize the argument '{argument[0]}' in the --msg-template. \"\n                     \"Are you sure it is supported on the current version of pylint?\"\n                 )\n-                template = re.sub(r\"\\{\" + argument[0] + r\"(:.*?)?\\}\", \"\", template)\n+                template = re.sub(\n+                    r\"\\{\" + argument[0] + r\"(:.*?)?\\}\", \"\", template\n+                )\n         self._fixed_template = template\n \n     def write_message(self, msg: Message) -> None:\ndiff --git a/tests/reporters/unittest_reporting.py b/tests/reporters/unittest_reporting.py\nindex 37f3e5fd9..8615c2fbf 100644\n--- a/tests/reporters/unittest_reporting.py\n+++ b/tests/reporters/unittest_reporting.py\n@@ -81,6 +81,23 @@ def test_template_option_end_line(linter) -> None:\n     assert out_lines[2] == \"my_mod:2:0:2:4: C0301: Line too long (3/4) (line-too-long)\"\n \n \n+def test_template_option_with_escaped_braces(linter) -> None:\n+    \"\"\"Test the msg-template option with escaped braces ({{ and }}).\n+\n+    Escaped braces should be treated as literal braces in the output,\n+    not as format field delimiters.\n+    \"\"\"\n+    output = StringIO()\n+    linter.reporter.out = output\n+    linter.config.msg_template = '{{ \"Category\": \"{category}\" }}'\n+    linter.open()\n+    linter.set_current_module(\"my_mod\")\n+    linter.add_message(\"C0301\", line=1, args=(1, 2))\n+\n+    out_lines = output.getvalue().split(\"\\n\")\n+    assert out_lines[1] == '{ \"Category\": \"convention\" }'\n+\n+\n def test_template_option_non_existing(linter) -> None:\n     \"\"\"Test the msg-template option with non-existent options.\n     This makes sure that this option remains backwards compatible as new\n"}
{"instance_id": "sphinx-doc__sphinx-10325", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/doc/usage/extensions/autodoc.rst b/doc/usage/extensions/autodoc.rst\nindex e3d551dd4..62d19038c 100644\n--- a/doc/usage/extensions/autodoc.rst\n+++ b/doc/usage/extensions/autodoc.rst\n@@ -252,14 +252,17 @@ inserting them into the page source under a suitable :rst:dir:`py:module`,\n      This can be combined with ``undoc-members`` to document *all* available\n      members of the class or module.\n \n-     It can take an ancestor class not to document inherited members from it.\n-     By default, members of ``object`` class are not documented.  To show them\n-     all, give ``None`` to the option.\n+     It can take a comma-separated list of ancestor class names to ignore when\n+     collecting inherited members.  By default, members of the ``object`` class\n+     are not documented.  To show them all, give ``None`` to the option.\n \n      For example; If your class ``Foo`` is derived from ``list`` class and\n-     you don't want to document ``list.__len__()``, you should specify a\n-     option ``:inherited-members: list`` to avoid special members of list\n-     class.\n+     you don't want to document ``list.__len__()``, you should specify the\n+     option ``:inherited-members: list`` to avoid members of the list class.\n+\n+     Another example; If your class ``Bar`` inherits from both ``MyMixin`` and\n+     ``list`` and you want to ignore members from both, use a comma-separated\n+     list: ``:inherited-members: MyMixin, list``.\n \n      Another example; If your class Foo has ``__str__`` special method and\n      autodoc directive has both ``inherited-members`` and ``special-members``,\n@@ -275,6 +278,10 @@ inserting them into the page source under a suitable :rst:dir:`py:module`,\n \n         It takes an ancestor class name as an argument.\n \n+     .. versionchanged:: 5.0\n+\n+        It can now take a comma-separated list of ancestor class names.\n+\n    * It's possible to override the signature for explicitly documented callable\n      objects (functions, methods, classes) with the regular syntax that will\n      override the signature gained from introspection::\ndiff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 62631f7ff..0d89ee7e7 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -110,11 +110,11 @@ def exclude_members_option(arg: Any) -> Union[object, Set[str]]:\n \n \n def inherited_members_option(arg: Any) -> Union[object, Set[str]]:\n-    \"\"\"Used to convert the :members: option to auto directives.\"\"\"\n+    \"\"\"Used to convert the :inherited-members: option to auto directives.\"\"\"\n     if arg in (None, True):\n-        return 'object'\n+        return {'object'}\n     else:\n-        return arg\n+        return {x.strip() for x in arg.split(',') if x.strip()}\n \n \n def member_order_option(arg: Any) -> Optional[str]:\n@@ -682,7 +682,9 @@ class Documenter:\n         def is_filtered_inherited_member(name: str, obj: Any) -> bool:\n             if inspect.isclass(self.object):\n                 for cls in self.object.__mro__:\n-                    if cls.__name__ == self.options.inherited_members and cls != self.object:\n+                    if (isinstance(self.options.inherited_members, set) and\n+                            cls.__name__ in self.options.inherited_members and\n+                            cls != self.object):\n                         # given member is a member of specified *super class*\n                         return True\n                     elif name in cls.__dict__:\ndiff --git a/tests/roots/test-ext-autodoc/target/inheritance.py b/tests/roots/test-ext-autodoc/target/inheritance.py\nindex ffac84bb6..3fb8f3494 100644\n--- a/tests/roots/test-ext-autodoc/target/inheritance.py\n+++ b/tests/roots/test-ext-autodoc/target/inheritance.py\n@@ -15,3 +15,14 @@ class Derived(Base):\n     def inheritedmeth(self):\n         # no docstring here\n         pass\n+\n+\n+class MyMixin:\n+    def mixin(self):\n+        \"\"\"Mixin method.\"\"\"\n+\n+\n+class Derived2(MyMixin, Base):\n+    def inheritedmeth(self):\n+        # no docstring here\n+        pass\ndiff --git a/tests/test_ext_autodoc.py b/tests/test_ext_autodoc.py\nindex 1f1c7e9e7..917cc2d07 100644\n--- a/tests/test_ext_autodoc.py\n+++ b/tests/test_ext_autodoc.py\n@@ -794,6 +794,29 @@ def test_autodoc_inherited_members_None(app):\n     assert '   .. py:method:: Derived.__str__()' in actual\n \n \n+@pytest.mark.sphinx('html', testroot='ext-autodoc')\n+def test_autodoc_inherited_members_Base_and_mixin(app):\n+    options = {\"members\": None,\n+               \"inherited-members\": \"Base, MyMixin\"}\n+\n+    # With both Base and MyMixin in inherited-members, members from both are filtered\n+    actual = do_autodoc(app, 'class', 'target.inheritance.Derived2', options)\n+    assert '   .. py:method:: Derived2.mixin()' not in actual\n+    assert '   .. py:method:: Derived2.inheritedclassmeth()' not in actual\n+\n+\n+@pytest.mark.sphinx('html', testroot='ext-autodoc')\n+def test_autodoc_inherited_members_Base_only_on_Derived2(app):\n+    options = {\"members\": None,\n+               \"inherited-members\": \"Base\"}\n+\n+    # With only Base in inherited-members, mixin() from MyMixin is shown\n+    # but methods from Base are filtered\n+    actual = do_autodoc(app, 'class', 'target.inheritance.Derived2', options)\n+    assert '   .. py:method:: Derived2.mixin()' in actual\n+    assert '   .. py:method:: Derived2.inheritedclassmeth()' not in actual\n+\n+\n @pytest.mark.sphinx('html', testroot='ext-autodoc')\n def test_autodoc_imported_members(app):\n     options = {\"members\": None,\n"}
{"instance_id": "sphinx-doc__sphinx-10451", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autodoc/typehints.py b/sphinx/ext/autodoc/typehints.py\nindex d912cd7d5..910259f09 100644\n--- a/sphinx/ext/autodoc/typehints.py\n+++ b/sphinx/ext/autodoc/typehints.py\n@@ -27,7 +27,12 @@ def record_typehints(app: Sphinx, objtype: str, name: str, obj: Any,\n             sig = inspect.signature(obj, type_aliases=app.config.autodoc_type_aliases)\n             for param in sig.parameters.values():\n                 if param.annotation is not param.empty:\n-                    annotation[param.name] = typing.stringify(param.annotation, mode)\n+                    if param.kind == param.VAR_POSITIONAL:\n+                        annotation['*' + param.name] = typing.stringify(param.annotation, mode)\n+                    elif param.kind == param.VAR_KEYWORD:\n+                        annotation['**' + param.name] = typing.stringify(param.annotation, mode)\n+                    else:\n+                        annotation[param.name] = typing.stringify(param.annotation, mode)\n             if sig.return_annotation is not sig.empty:\n                 annotation['return'] = typing.stringify(sig.return_annotation, mode)\n     except (TypeError, ValueError):\n@@ -115,7 +120,14 @@ def modify_field_list(node: nodes.field_list, annotations: Dict[str, str],\n         if name == 'return':\n             continue\n \n-        arg = arguments.get(name, {})\n+        if name in arguments:\n+            arg = arguments.get(name, {})\n+        elif name.startswith('**') and name[2:] in arguments:\n+            arg = arguments.get(name[2:], {})\n+        elif name.startswith('*') and name[1:] in arguments:\n+            arg = arguments.get(name[1:], {})\n+        else:\n+            arg = {}\n         if not arg.get('type'):\n             field = nodes.field()\n             field += nodes.field_name('', 'type ' + name)\n@@ -167,13 +179,21 @@ def augment_descriptions_with_types(\n             has_type.add('return')\n \n     # Add 'type' for parameters with a description but no declared type.\n-    for name in annotations:\n+    for name, annotation in annotations.items():\n         if name in ('return', 'returns'):\n             continue\n-        if name in has_description and name not in has_type:\n+        if name in has_description:\n+            field_name = name\n+        elif name.startswith('**') and name[2:] in has_description:\n+            field_name = name[2:]\n+        elif name.startswith('*') and name[1:] in has_description:\n+            field_name = name[1:]\n+        else:\n+            field_name = name\n+        if field_name in has_description and field_name not in has_type:\n             field = nodes.field()\n-            field += nodes.field_name('', 'type ' + name)\n-            field += nodes.field_body('', nodes.paragraph('', annotations[name]))\n+            field += nodes.field_name('', 'type ' + field_name)\n+            field += nodes.field_body('', nodes.paragraph('', annotation))\n             node += field\n \n     # Add 'rtype' if 'return' is present and 'rtype' isn't.\ndiff --git a/tests/roots/test-ext-autodoc/target/typehints.py b/tests/roots/test-ext-autodoc/target/typehints.py\nindex 6b0d6142c..d04a2e2b8 100644\n--- a/tests/roots/test-ext-autodoc/target/typehints.py\n+++ b/tests/roots/test-ext-autodoc/target/typehints.py\n@@ -99,3 +99,15 @@ class _ClassWithDocumentedInit:\n \n         :param x: Some integer\n         \"\"\"\n+\n+\n+class _ClassWithDocumentedInitAndStarArgs:\n+    \"\"\"Class docstring.\"\"\"\n+\n+    def __init__(self, x: int, *args: int, **kwargs: int) -> None:\n+        \"\"\"Init docstring.\n+\n+        :param x: Some integer\n+        :param *args: Some integer\n+        :param **kwargs: Some integer\n+        \"\"\"\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex c075a8e2d..d5e075608 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -1101,6 +1101,46 @@ def test_autodoc_typehints_description_with_documented_init_no_undoc_doc_rtype(a\n             '         **x** (*int*) -- Some integer\\n' == context)\n \n \n+@pytest.mark.sphinx('text', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"description\"})\n+def test_autodoc_typehints_description_with_documented_init_and_star_args(app):\n+    (app.srcdir / 'index.rst').write_text(\n+        '.. autoclass:: target.typehints._ClassWithDocumentedInitAndStarArgs\\n'\n+        '   :special-members: __init__\\n',\n+        encoding='utf8'\n+    )\n+    app.build()\n+    context = (app.outdir / 'index.txt').read_text(encoding='utf8')\n+    assert ('class target.typehints._ClassWithDocumentedInitAndStarArgs(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '   Class docstring.\\n'\n+            '\\n'\n+            '   Parameters:\\n'\n+            '      * **x** (*int*) --\\n'\n+            '\\n'\n+            '      * ***args** (*int*) --\\n'\n+            '\\n'\n+            '      * ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '   __init__(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '      Init docstring.\\n'\n+            '\\n'\n+            '      Parameters:\\n'\n+            '         * **x** (*int*) -- Some integer\\n'\n+            '\\n'\n+            '         * ***args** (*int*) --\\n'\n+            '\\n'\n+            '           Some integer\\n'\n+            '\\n'\n+            '         * ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '           Some integer\\n'\n+            '\\n'\n+            '      Return type:\\n'\n+            '         None\\n' == context)\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"description\"})\n def test_autodoc_typehints_description_for_invalid_node(app):\n"}
{"instance_id": "sphinx-doc__sphinx-11445", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py\nindex 7a1538325..cd82916f0 100644\n--- a/sphinx/util/rst.py\n+++ b/sphinx/util/rst.py\n@@ -25,7 +25,7 @@ except ImportError:\n \n logger = logging.getLogger(__name__)\n \n-docinfo_re = re.compile(':\\\\w+:.*?')\n+docinfo_re = re.compile(':\\\\w+:( |$)')\n symbols_re = re.compile(r'([!-\\-/:-@\\[-`{-~])')  # symbols without dot(0x2e)\n SECTIONING_CHARS = ['=', '-', '~']\n \ndiff --git a/tests/test_util_rst.py b/tests/test_util_rst.py\nindex 40a2ee68b..cd425b61e 100644\n--- a/tests/test_util_rst.py\n+++ b/tests/test_util_rst.py\n@@ -63,6 +63,25 @@ def test_prepend_prolog_with_CR(app):\n                                       ('dummy.rst', 1, 'Sphinx is a document generator')]\n \n \n+def test_prepend_prolog_with_roles_in_first_heading(app):\n+    # Ensure a domain role in the first heading is not confused with a docinfo field\n+    prolog = 'this is rst_prolog\\nhello reST!'\n+    content = StringList([':mod:`mypackage2`',\n+                          '=================',\n+                          '',\n+                          'Content'],\n+                         'dummy.rst')\n+    prepend_prolog(content, prolog)\n+\n+    assert list(content.xitems()) == [('<rst_prolog>', 0, 'this is rst_prolog'),\n+                                      ('<rst_prolog>', 1, 'hello reST!'),\n+                                      ('<generated>', 0, ''),\n+                                      ('dummy.rst', 0, ':mod:`mypackage2`'),\n+                                      ('dummy.rst', 1, '================='),\n+                                      ('dummy.rst', 2, ''),\n+                                      ('dummy.rst', 3, 'Content')]\n+\n+\n def test_prepend_prolog_without_CR(app):\n     # prolog not having CR at tail\n     prolog = 'this is rst_prolog\\nhello reST!'\n"}
{"instance_id": "sphinx-doc__sphinx-7686", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autosummary/generate.py b/sphinx/ext/autosummary/generate.py\nindex a57c73fb7..d5094c2b4 100644\n--- a/sphinx/ext/autosummary/generate.py\n+++ b/sphinx/ext/autosummary/generate.py\n@@ -255,6 +255,9 @@ def generate_autosummary_content(name: str, obj: Any, parent: Any,\n             get_members(obj, {'exception'}, imported=imported_members)\n         ns['attributes'], ns['all_attributes'] = \\\n             get_module_attrs(ns['members'])\n+        if not imported_members:\n+            ns['members'] = [m for m in ns['members']\n+                             if getattr(safe_getattr(obj, m, None), '__module__', None) == obj.__name__]\n         ispackage = hasattr(obj, '__path__')\n         if ispackage and recursive:\n             ns['modules'], ns['all_modules'] = get_modules(obj)\n"}
{"instance_id": "sphinx-doc__sphinx-7738", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/napoleon/docstring.py b/sphinx/ext/napoleon/docstring.py\nindex 11409e6f6..fd0957e7f 100644\n--- a/sphinx/ext/napoleon/docstring.py\n+++ b/sphinx/ext/napoleon/docstring.py\n@@ -318,9 +318,6 @@ class GoogleDocstring:\n             return [line[min_indent:] for line in lines]\n \n     def _escape_args_and_kwargs(self, name: str) -> str:\n-        if name.endswith('_'):\n-            name = name[:-1] + r'\\_'\n-\n         if name[:2] == '**':\n             return r'\\*\\*' + name[2:]\n         elif name[:1] == '*':\ndiff --git a/tests/test_ext_napoleon_docstring.py b/tests/test_ext_napoleon_docstring.py\nindex 3027a4cb2..d9ccc4122 100644\n--- a/tests/test_ext_napoleon_docstring.py\n+++ b/tests/test_ext_napoleon_docstring.py\n@@ -1399,8 +1399,8 @@ arg_ : type\n \"\"\"\n \n         expected = \"\"\"\n-:ivar arg\\\\_: some description\n-:vartype arg\\\\_: type\n+:ivar arg_: some description\n+:vartype arg_: type\n \"\"\"\n \n         config = Config(napoleon_use_ivar=True)\n"}
{"instance_id": "sphinx-doc__sphinx-7975", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/environment/adapters/indexentries.py b/sphinx/environment/adapters/indexentries.py\nindex 5af213932..9e3a03381 100644\n--- a/sphinx/environment/adapters/indexentries.py\n+++ b/sphinx/environment/adapters/indexentries.py\n@@ -110,6 +110,8 @@ class IndexEntries:\n                 lckey = lckey[1:]\n             if lckey[0:1].isalpha() or lckey.startswith('_'):\n                 lckey = chr(127) + lckey\n+            else:\n+                lckey = chr(0) + lckey\n             # ensure a determinstic order *within* letters by also sorting on\n             # the entry itself\n             return (lckey, entry[0])\n@@ -152,6 +154,8 @@ class IndexEntries:\n                 key = key[1:]\n             if key[0:1].isalpha() or key.startswith('_'):\n                 key = chr(127) + key\n+            else:\n+                key = chr(0) + key\n             return key\n \n         # group the entries by letter\ndiff --git a/tests/test_environment_indexentries.py b/tests/test_environment_indexentries.py\nindex 7f6003d54..fb7a48908 100644\n--- a/tests/test_environment_indexentries.py\n+++ b/tests/test_environment_indexentries.py\n@@ -31,6 +31,24 @@ def test_create_single_index(app):\n     assert len(index) == 6\n     assert index[0] == ('Symbols', [('&-symbol', [[('', '#index-9')], [], None]),\n                                     ('9-symbol', [[('', '#index-8')], [], None])])\n+\n+\n+@pytest.mark.sphinx('dummy', freshenv=True)\n+def test_create_single_index_with_unicode_symbols(app):\n+    # Regression test: Unicode symbols (code points > 127) like \u00a3 and \u2190\n+    # should appear in the same \"Symbols\" section as ASCII symbols like @,\n+    # not in a separate second \"Symbols\" section after the alphabetic entries.\n+    text = (\".. index:: @-at\\n\"\n+            \".. index:: \u00a3-pound\\n\"\n+            \".. index:: \u2190-arrow\\n\"\n+            \".. index:: Apple\\n\")\n+    restructuredtext.parse(app, text)\n+    index = IndexEntries(app.env).create_index(app.builder)\n+    assert len(index) == 2\n+    assert index[0] == ('Symbols', [('@-at', [[('', '#index-0')], [], None]),\n+                                    ('\u00a3-pound', [[('', '#index-1')], [], None]),\n+                                    ('\u2190-arrow', [[('', '#index-2')], [], None])])\n+    assert index[1] == ('A', [('Apple', [[('', '#index-3')], [], None])])\n     assert index[1] == ('D', [('docutils', [[('', '#index-0')], [], None])])\n     assert index[2] == ('P', [('pip', [[], [('install', [('', '#index-2')]),\n                                             ('upgrade', [('', '#index-3')])], None]),\n"}
{"instance_id": "sphinx-doc__sphinx-8273", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/builders/manpage.py b/sphinx/builders/manpage.py\nindex 4166dece9..f15eb14fe 100644\n--- a/sphinx/builders/manpage.py\n+++ b/sphinx/builders/manpage.py\n@@ -24,7 +24,7 @@ from sphinx.util import logging\n from sphinx.util import progress_message\n from sphinx.util.console import darkgreen  # type: ignore\n from sphinx.util.nodes import inline_all_toctrees\n-from sphinx.util.osutil import make_filename_from_project\n+from sphinx.util.osutil import ensuredir, make_filename_from_project\n from sphinx.writers.manpage import ManualPageWriter, ManualPageTranslator\n \n \n@@ -80,7 +80,11 @@ class ManualPageBuilder(Builder):\n             docsettings.authors = authors\n             docsettings.section = section\n \n-            targetname = '%s.%s' % (name, section)\n+            if self.config.man_make_section_directory:\n+                ensuredir(path.join(self.outdir, 'man%s' % section))\n+                targetname = 'man%s/%s.%s' % (section, name, section)\n+            else:\n+                targetname = '%s.%s' % (name, section)\n             logger.info(darkgreen(targetname) + ' { ', nonl=True)\n             destination = FileOutput(\n                 destination_path=path.join(self.outdir, targetname),\n@@ -115,6 +119,7 @@ def setup(app: Sphinx) -> Dict[str, Any]:\n \n     app.add_config_value('man_pages', default_man_pages, None)\n     app.add_config_value('man_show_urls', False, None)\n+    app.add_config_value('man_make_section_directory', False, None)\n \n     return {\n         'version': 'builtin',\ndiff --git a/tests/test_build_manpage.py b/tests/test_build_manpage.py\nindex c3c41a2ae..7f5149f44 100644\n--- a/tests/test_build_manpage.py\n+++ b/tests/test_build_manpage.py\n@@ -30,6 +30,12 @@ def test_all(app, status, warning):\n     assert 'Footnotes' not in content\n \n \n+@pytest.mark.sphinx('man', confoverrides={'man_make_section_directory': True})\n+def test_man_make_section_directory(app, status, warning):\n+    app.builder.build_all()\n+    assert (app.outdir / 'man1' / 'sphinxtests.1').exists()\n+\n+\n @pytest.mark.sphinx('man', testroot='directive-code')\n def test_captioned_code_block(app, status, warning):\n     app.builder.build_all()\n"}
{"instance_id": "sphinx-doc__sphinx-8282", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 978fd5df8..08690f8f8 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1261,6 +1261,8 @@ class FunctionDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):  # typ\n                     documenter.objpath = [None]\n                     sigs.append(documenter.format_signature())\n         if overloaded:\n+            if self.env.config.autodoc_typehints in ('none', 'description'):\n+                kwargs.setdefault('show_annotation', False)\n             __globals__ = safe_getattr(self.object, '__globals__', {})\n             for overload in self.analyzer.overloads.get('.'.join(self.objpath)):\n                 overload = evaluate_signature(overload, __globals__,\n@@ -1905,6 +1907,8 @@ class MethodDocumenter(DocstringSignatureMixin, ClassLevelDocumenter):  # type:\n                     documenter.objpath = [None]\n                     sigs.append(documenter.format_signature())\n         if overloaded:\n+            if self.env.config.autodoc_typehints in ('none', 'description'):\n+                kwargs.setdefault('show_annotation', False)\n             __globals__ = safe_getattr(self.object, '__globals__', {})\n             for overload in self.analyzer.overloads.get('.'.join(self.objpath)):\n                 overload = evaluate_signature(overload, __globals__,\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex 7d51b7f0e..d4b4fdb48 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -610,6 +610,61 @@ def test_autodoc_typehints_none(app):\n     ]\n \n \n+@pytest.mark.sphinx('html', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"none\"})\n+def test_autodoc_typehints_none_for_overloaded_functions(app):\n+    options = {\"members\": None}\n+    actual = do_autodoc(app, 'module', 'target.overload', options)\n+    assert list(actual) == [\n+        '',\n+        '.. py:module:: target.overload',\n+        '',\n+        '',\n+        '.. py:class:: Bar(x, y)',\n+        '              Bar(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Baz(x, y)',\n+        '              Baz(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Foo(x, y)',\n+        '              Foo(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '.. py:class:: Math()',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '   .. py:method:: Math.sum(x, y)',\n+        '                  Math.sum(x, y)',\n+        '                  Math.sum(x, y)',\n+        '      :module: target.overload',\n+        '',\n+        '      docstring',\n+        '',\n+        '',\n+        '.. py:function:: sum(x, y)',\n+        '                 sum(x, y)',\n+        '                 sum(x, y)',\n+        '   :module: target.overload',\n+        '',\n+        '   docstring',\n+        '',\n+    ]\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"description\"})\n def test_autodoc_typehints_description(app):\n"}
{"instance_id": "sphinx-doc__sphinx-8435", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 171a3e7b0..ee48b03c0 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1702,7 +1702,7 @@ class DataDocumenter(ModuleLevelDocumenter):\n         if not self.options.annotation:\n             # obtain annotation for this data\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, localns=self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})\n@@ -2093,7 +2093,7 @@ class AttributeDocumenter(DocstringStripSignatureMixin, ClassLevelDocumenter):\n         if not self.options.annotation:\n             # obtain type annotation for this attribute\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, localns=self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex 3d1005ac0..475470d69 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -737,6 +737,22 @@ def test_autodoc_type_aliases(app):\n     ]\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 7), reason='python 3.7+ is required.')\n+@pytest.mark.sphinx('text', testroot='ext-autodoc')\n+def test_autodoc_type_aliases_for_variables(app):\n+    options = {\"members\": None, \"undoc-members\": None}\n+    # default (no aliases)\n+    actual = do_autodoc(app, 'module', 'target.annotations2', options)\n+    assert '   :type: int' in actual\n+    assert '      :type: int' in actual\n+\n+    # define aliases\n+    app.config.autodoc_type_aliases = {'myint': 'myint'}\n+    actual = do_autodoc(app, 'module', 'target.annotations2', options)\n+    assert '   :type: myint' in actual\n+    assert '      :type: myint' in actual\n+\n+\n @pytest.mark.sphinx('html', testroot='ext-autodoc')\n def test_autodoc_default_options(app):\n     # no settings\n"}
{"instance_id": "sphinx-doc__sphinx-8474", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/CHANGES b/CHANGES\nindex b17c7b202..1c614293e 100644\n--- a/CHANGES\n+++ b/CHANGES\n@@ -55,6 +55,8 @@ Bugs fixed\n * #8419: html search: Do not load ``language_data.js`` in non-search pages\n * #8454: graphviz: The layout option for graph and digraph directives don't work\n * #8437: Makefile: ``make clean`` with empty BUILDDIR is dangerous\n+* #8352: numfig: ``no number is assigned for table`` warning is emitted when\n+  building singlehtml or latex for tables with labels but no captions\n \n Testing\n --------\ndiff --git a/sphinx/environment/collectors/toctree.py b/sphinx/environment/collectors/toctree.py\nindex 14ff4ed74..3c009c735 100644\n--- a/sphinx/environment/collectors/toctree.py\n+++ b/sphinx/environment/collectors/toctree.py\n@@ -223,10 +223,6 @@ class TocTreeCollector(EnvironmentCollector):\n         def get_figtype(node: Node) -> str:\n             for domain in env.domains.values():\n                 figtype = domain.get_enumerable_node_type(node)\n-                if domain.name == 'std' and not domain.get_numfig_title(node):  # type: ignore\n-                    # Skip if uncaptioned node\n-                    continue\n-\n                 if figtype:\n                     return figtype\n \ndiff --git a/tests/test_build_html.py b/tests/test_build_html.py\nindex 6b66a2c67..2bf0fa043 100644\n--- a/tests/test_build_html.py\n+++ b/tests/test_build_html.py\n@@ -1158,6 +1158,15 @@ def test_numfig_with_singlehtml(app, cached_etree_parse, fname, expect):\n     check_xpath(cached_etree_parse(app.outdir / fname), fname, *expect)\n \n \n+@pytest.mark.sphinx('singlehtml', testroot='numfig-fix')\n+def test_numfig_with_singlehtml_and_uncaptioned_table(app, warning):\n+    # Labeled tables without captions should not emit \"no number is assigned\" warning\n+    # See https://github.com/sphinx-doc/sphinx/issues/8352\n+    app.build()\n+    warnings = warning.getvalue()\n+    assert 'no number is assigned for table' not in warnings\n+\n+\n @pytest.mark.parametrize(\"fname,expect\", flat_dict({\n     'index.html': [\n         (\".//div[@class='figure align-default']/p[@class='caption']\"\n"}
{"instance_id": "sphinx-doc__sphinx-8506", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/domains/std.py b/sphinx/domains/std.py\nindex c87217c56..e1273757e 100644\n--- a/sphinx/domains/std.py\n+++ b/sphinx/domains/std.py\n@@ -43,7 +43,7 @@ logger = logging.getLogger(__name__)\n \n \n # RE for option descriptions\n-option_desc_re = re.compile(r'((?:/|--|-|\\+)?[^\\s=[]+)(=?\\s*.*)')\n+option_desc_re = re.compile(r'((?:/|--|-|\\+)?\\[[^\\]]*\\][^\\s]*|(?:/|--|-|\\+)?[^\\s=[]+)(=?\\s*.*)')\n # RE for grammar tokens\n token_re = re.compile(r'`(\\w+)`', re.U)\n \ndiff --git a/tests/test_domain_std.py b/tests/test_domain_std.py\nindex 7ee1d6c07..79a5dcdfd 100644\n--- a/tests/test_domain_std.py\n+++ b/tests/test_domain_std.py\n@@ -327,6 +327,19 @@ def test_multiple_cmdoptions(app):\n     assert domain.progoptions[('cmd', '--output')] == ('index', 'cmdoption-cmd-o')\n \n \n+def test_cmdoption_with_optional_prefix(app, warning):\n+    # Test that options with bracket notation like [enable=]PATTERN are accepted\n+    # without warnings (regression test for GitHub issue #8517)\n+    text = (\".. option:: [enable=]PATTERN\\n\")\n+    domain = app.env.get_domain('std')\n+    doctree = restructuredtext.parse(app, text)\n+    assert_node(doctree, (addnodes.index,\n+                          [desc, ([desc_signature, ([desc_name, \"[enable=]PATTERN\"],\n+                                                    [desc_addname, \"\"])],\n+                                  [desc_content, ()])]))\n+    assert warning.getvalue() == ''\n+\n+\n @pytest.mark.skipif(docutils.__version_info__ < (0, 13),\n                     reason='docutils-0.13 or above is required')\n @pytest.mark.sphinx(testroot='productionlist')\n"}
{"instance_id": "sphinx-doc__sphinx-8595", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex d85d79617..c9f90acca 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1074,7 +1074,7 @@ class ModuleDocumenter(Documenter):\n     def get_object_members(self, want_all: bool) -> Tuple[bool, ObjectMembers]:\n         members = self.get_module_members()\n         if want_all:\n-            if not self.__all__:\n+            if self.__all__ is None:\n                 # for implicit module members, check __module__ to avoid\n                 # documenting imported objects\n                 return True, list(members.values())\n"}
{"instance_id": "sphinx-doc__sphinx-8627", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/util/typing.py b/sphinx/util/typing.py\nindex 2d4f67bba..e7c50a502 100644\n--- a/sphinx/util/typing.py\n+++ b/sphinx/util/typing.py\n@@ -105,6 +105,29 @@ def restify(cls: Optional[\"Type\"]) -> str:\n             return _restify_py36(cls)\n \n \n+def _get_annotation_module(annotation: Any) -> str:\n+    \"\"\"Get the best module name for an annotation type.\n+\n+    For C extension types that are defined in a private module (e.g., ``_struct``)\n+    but exposed via a public module (e.g., ``struct``), this returns the public\n+    module name so that cross-references resolve correctly.\n+    \"\"\"\n+    module = getattr(annotation, '__module__', None)\n+    if module:\n+        # Handle C extension types whose __module__ is a private implementation\n+        # module (e.g., struct.Struct has __module__='_struct' but is accessible\n+        # as struct.Struct).\n+        if module.startswith('_'):\n+            public_module = module[1:]  # e.g., '_struct' -> 'struct'\n+            if public_module in sys.modules:\n+                # Verify the class is actually accessible via the public module\n+                qualname = getattr(annotation, '__qualname__', None)\n+                name = getattr(annotation, '__name__', qualname)\n+                if name and getattr(sys.modules[public_module], name, None) is annotation:\n+                    return public_module\n+    return module or ''\n+\n+\n def _restify_py37(cls: Optional[\"Type\"]) -> str:\n     \"\"\"Convert python class to a reST reference.\"\"\"\n     from sphinx.util import inspect  # lazy loading\n@@ -146,18 +169,18 @@ def _restify_py37(cls: Optional[\"Type\"]) -> str:\n         if cls.__module__ == 'typing':\n             return ':class:`%s`' % cls.__qualname__\n         else:\n-            return ':class:`%s.%s`' % (cls.__module__, cls.__qualname__)\n+            return ':class:`%s.%s`' % (_get_annotation_module(cls), cls.__qualname__)\n     elif hasattr(cls, '_name'):\n         # SpecialForm\n         if cls.__module__ == 'typing':\n             return ':obj:`%s`' % cls._name\n         else:\n-            return ':obj:`%s.%s`' % (cls.__module__, cls._name)\n+            return ':obj:`%s.%s`' % (_get_annotation_module(cls), cls._name)\n     elif isinstance(cls, ForwardRef):\n         return ':class:`%s`' % cls.__forward_arg__\n     else:\n         # not a class (ex. TypeVar)\n-        return ':obj:`%s.%s`' % (cls.__module__, cls.__name__)\n+        return ':obj:`%s.%s`' % (_get_annotation_module(cls), cls.__name__)\n \n \n def _restify_py36(cls: Optional[\"Type\"]) -> str:\n@@ -174,7 +197,7 @@ def _restify_py36(cls: Optional[\"Type\"]) -> str:\n         else:\n             qualname = repr(cls).replace('typing.', '')\n     elif hasattr(cls, '__qualname__'):\n-        qualname = '%s.%s' % (module, cls.__qualname__)\n+        qualname = '%s.%s' % (_get_annotation_module(cls), cls.__qualname__)\n     else:\n         qualname = repr(cls)\n \n@@ -325,7 +348,7 @@ def _stringify_py37(annotation: Any) -> str:\n         else:\n             qualname = stringify(annotation.__origin__)  # ex. Union\n     elif hasattr(annotation, '__qualname__'):\n-        qualname = '%s.%s' % (module, annotation.__qualname__)\n+        qualname = '%s.%s' % (_get_annotation_module(annotation), annotation.__qualname__)\n     elif hasattr(annotation, '__origin__'):\n         # instantiated generic provided by a user\n         qualname = stringify(annotation.__origin__)\n@@ -379,7 +402,7 @@ def _stringify_py36(annotation: Any) -> str:\n         else:\n             qualname = repr(annotation).replace('typing.', '')\n     elif hasattr(annotation, '__qualname__'):\n-        qualname = '%s.%s' % (module, annotation.__qualname__)\n+        qualname = '%s.%s' % (_get_annotation_module(annotation), annotation.__qualname__)\n     else:\n         qualname = repr(annotation)\n \ndiff --git a/tests/test_util_typing.py b/tests/test_util_typing.py\nindex a2565f1e1..e5459d11f 100644\n--- a/tests/test_util_typing.py\n+++ b/tests/test_util_typing.py\n@@ -8,6 +8,7 @@\n     :license: BSD, see LICENSE for details.\n \"\"\"\n \n+import struct\n import sys\n from numbers import Integral\n from typing import (Any, Callable, Dict, Generator, List, NewType, Optional, Tuple, TypeVar,\n@@ -44,6 +45,7 @@ def test_restify():\n     assert restify(None) == \":obj:`None`\"\n     assert restify(Integral) == \":class:`numbers.Integral`\"\n     assert restify(Any) == \":obj:`Any`\"\n+    assert restify(struct.Struct) == \":class:`struct.Struct`\"\n \n \n def test_restify_type_hints_containers():\n@@ -125,6 +127,7 @@ def test_stringify():\n     assert stringify(None) == \"None\"\n     assert stringify(Integral) == \"numbers.Integral\"\n     assert stringify(Any) == \"Any\"\n+    assert stringify(struct.Struct) == \"struct.Struct\"\n \n \n def test_stringify_type_hints_containers():\n"}
{"instance_id": "sphinx-doc__sphinx-8713", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/napoleon/docstring.py b/sphinx/ext/napoleon/docstring.py\nindex 755088ca5..a5a986e49 100644\n--- a/sphinx/ext/napoleon/docstring.py\n+++ b/sphinx/ext/napoleon/docstring.py\n@@ -682,7 +682,13 @@ class GoogleDocstring:\n         return self._parse_generic_section(_('Notes'), use_admonition)\n \n     def _parse_other_parameters_section(self, section: str) -> List[str]:\n-        return self._format_fields(_('Other Parameters'), self._consume_fields())\n+        if self._config.napoleon_use_param:\n+            # Allow to declare multiple parameters at once (ex: x, y: int)\n+            fields = self._consume_fields(multiple=True)\n+            return self._format_docutils_params(fields)\n+        else:\n+            fields = self._consume_fields()\n+            return self._format_fields(_('Other Parameters'), fields)\n \n     def _parse_parameters_section(self, section: str) -> List[str]:\n         if self._config.napoleon_use_param:\n"}
{"instance_id": "sphinx-doc__sphinx-8721", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/viewcode.py b/sphinx/ext/viewcode.py\nindex a7d52a91c..060604e25 100644\n--- a/sphinx/ext/viewcode.py\n+++ b/sphinx/ext/viewcode.py\n@@ -182,6 +182,8 @@ def collect_pages(app: Sphinx) -> Generator[Tuple[str, Dict[str, Any], str], Non\n     env = app.builder.env\n     if not hasattr(env, '_viewcode_modules'):\n         return\n+    if app.builder.name.startswith(\"epub\") and not env.config.viewcode_enable_epub:\n+        return\n     highlighter = app.builder.highlighter  # type: ignore\n     urito = app.builder.get_relative_uri\n \n"}
{"instance_id": "sphinx-doc__sphinx-8801", "model_name_or_path": "claude-code-comprehend", "model_patch": "diff --git a/sphinx/ext/autodoc/importer.py b/sphinx/ext/autodoc/importer.py\nindex 477aae247..d3cc555fa 100644\n--- a/sphinx/ext/autodoc/importer.py\n+++ b/sphinx/ext/autodoc/importer.py\n@@ -307,9 +307,12 @@ def get_class_members(subject: Any, objpath: List[str], attrgetter: Callable\n                 analyzer = ModuleAnalyzer.for_module(modname)\n                 analyzer.analyze()\n                 for (ns, name), docstring in analyzer.attr_docs.items():\n-                    if ns == qualname and name not in members:\n-                        members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n-                                                     docstring='\\n'.join(docstring))\n+                    if ns == qualname:\n+                        if name not in members:\n+                            members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n+                                                         docstring='\\n'.join(docstring))\n+                        elif members[name].docstring is None:\n+                            members[name].docstring = '\\n'.join(docstring)\n             except (AttributeError, PycodeError):\n                 pass\n     except AttributeError:\n"}
